<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Identity Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazureid.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazureid.github.io/blog/"/>
  <updated>2021-07-01T00:10:33.179Z</updated>
  <id>https://jpazureid.github.io/blog/</id>
  
  <author>
    <name>Azure Identity Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Microsoft Authentication Library と Microsoft Graph への移行は完了済みでしょうか？</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/have-you-updated-your-applications-to-use-the-microsoft/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/have-you-updated-your-applications-to-use-the-microsoft/</id>
    <published>2021-07-01T01:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.179Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの竜と村上です。</p><p>本記事は、米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/have-you-updated-your-applications-to-use-the-microsoft/ba-p/1144698">Have you updated your applications to use the Microsoft Authentication Library and Microsoft Graph?</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>皆さん、こんにちは。</p><p>2020 年に、アプリケーションを開発する際に <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/msal-overview#languages-and-frameworks">Microsoft Authentication Library (MSAL)</a> と <a href="https://docs.microsoft.com/ja-jp/graph/overview">Microsoft Graph API</a> を使用することを、<a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/update-your-applications-to-use-microsoft-authentication-library/ba-p/1257363">開発者の皆さまへ推奨しました</a>。それ以降、MSAL および Microsoft Graph 双方へのパフォーマンス、セキュリティ、信頼性の向上など機能追加に継続して取り組んで参りました。また、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/app-resilience-continuous-access-evaluation">継続的なアクセス評価 (CAE)</a> に対応した API や、Microsoft Graph への <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/developer-guide-conditional-access-authentication-context">条件付きアクセス認証コンテキスト</a> の追加など、数百もの新しい API を追加しました。MSAL を使用している開発者の皆様がこれらを利用できるようになり、<a href="https://www.microsoft.com/security/blog/2021/01/19/using-zero-trust-principles-to-protect-against-sophisticated-attacks-like-solorigate/">ゼロトラスト対応</a> のアプリケーションを構築できるようになりました。</p><p>2022 年 6 月 30 日をもちまして Active Directory Auth Library (ADAL) および Azure Active Directory Graph のサポートを終了するため、MSAL および Microsoft Graph を使用するよう、アプリのアップデートを推奨します。また、まだ ADAL を使用しているアプリを簡単に見つけることができるようにいたしました。</p><h2 id="ADAL-と-Azure-AD-Graph-をまだ使用しているアプリケーションを特定する"><a href="#ADAL-と-Azure-AD-Graph-をまだ使用しているアプリケーションを特定する" class="headerlink" title="ADAL と Azure AD Graph をまだ使用しているアプリケーションを特定する"></a>ADAL と Azure AD Graph をまだ使用しているアプリケーションを特定する</h2><p>Azure AD Monitor Workbook を使用することで、ADAL を使用しているアプリケーションを特定可能です。Azure AD Monitor workbook は、Azure AD サインイン ログの情報を収集して視覚化する一連のクエリを使用しています。<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/reports-monitoring/reference-azure-monitor-sign-ins-log-schema">こちらのサインイン ログ スキーマ</a> を使用して、サインイン ログを直接参照することもできます。</p><p>ワークブックにアクセスするには:</p><ol><li><a href="https://portal.azure.com/">Azure ポータル</a> にサインインします。</li><li><strong>Azure Active Directory</strong> &gt; <strong>監視</strong> &gt; <strong>Workbooks</strong> に移動します。</li><li>使用状況のセクションから <strong>サインインの Workbook</strong> を開きます。</li></ol><p><img src="/blog/azure-active-directory/have-you-updated-your-applications-to-use-the-microsoft/Woodgrove.png"> </p><p>サインイン Workbook では、ページ下部に新しい表が追加され、最近使用したアプリが ADAL を使用しているかどうかがわかるようになりました。また、これらのアプリの一覧をエクスポートすることもできます。</p><p><img src="/blog/azure-active-directory/have-you-updated-your-applications-to-use-the-microsoft/WoodgroveWorkbooks.png"></p><p>ADAL を使用しているアプリを特定したら、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/msal-migration">MSAL の移行ガイド</a> の活用もご検討ください。Azure AD Graph を使用しているアプリを見つけるには、ソースコード内を “graph.windows.net” という文字列で検索してから、<a href="https://docs.microsoft.com/ja-jp/graph/migrate-azure-ad-graph-planning-checklist?view=graph-rest-1.0">Microsoft Graph の移行ガイド</a> を使用ください。</p><p>ご質問や問題、機能リクエストがございましたら、<a href="https://docs.microsoft.com/en-us/answers/topics/azure-ad-adal-deprecation.html">azure-ad-adal-deprecation</a> または <a href="https://docs.microsoft.com/en-us/answers/topics/azure-ad-graph-deprecation.html">azure-ad-graph-deprecation</a> タグを使用して Microsoft Q&amp;A にてお知らせください。</p><p>いつものように、ご意見やご提案をお待ちしています。以下のコメント欄または <a href="https://feedback.azure.com/forums/169401-azure-active-directory">Azure AD フィードバックフォーラム</a>で、ご意見をお聞かせください。</p><p>Alex Simons (Twitter: <a href="http://twitter.com/alex_a_simons">@Alex_A_Simons</a>)<br>Corporate Vice President of Program Management<br>Microsoft Identity Division</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの竜と村上です。&lt;/p&gt;
&lt;p&gt;本記事は、米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techcommunity.microsof</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>エンタープライズ アプリケーションに、管理者の知らないアプリケーションが追加されている!</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/enterpriseapps-multitenantapps/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/enterpriseapps-multitenantapps/</id>
    <published>2021-06-30T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.171Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity チームの栗井です。</p><p>突然ですが、Azure AD の管理者ユーザー様からよく、下記のようなお問い合わせをいただきます。</p><p>「Azure AD の [エンタープライズ アプリケーション] 一覧に、管理者が追加した覚えのないアプリケーションが追加されています。」</p><p>「これはユーザーが追加したものなのでしょうか。Azure AD のアカウントと連携をとっているのでしょうか。」</p><p>「追加されたアプリケーションは、Azure AD 上の情報やリソースにアクセスが発生するものなのでしょうか。心配です。」</p><h2 id="その正体は「マルチテナント-アプリケーション」"><a href="#その正体は「マルチテナント-アプリケーション」" class="headerlink" title="その正体は「マルチテナント アプリケーション」"></a>その正体は「マルチテナント アプリケーション」</h2><p>Azure ポータル上で確認いただける [エンタープライズ アプリケーション] には、既定で多くのアプリのサービス プリンシパルが登録されております。</p><p>既定で登録されているもの以外について、どのようなパターンでサービス プリンシパルが追加されるのか？という点については、すべてを網羅的にご案内することは難しいですのですが、大まかには下記の 2 パターンに分けることができます。</p><ol><li>権限のあるユーザー (テナント管理者など) が意図的に追加したもの<ul><li>(例) [アプリの登録] 上で登録した Open ID Connect のアプリのサービス プリンシパル<br>豆知識 : [アプリの登録] で一般ユーザーがアプリケーションを登録することを禁止したい場合は <a href="https://jpazureid.github.io/blog/azure-active-directory/users-can-register-applications/">こちらのブログ</a> でご紹介しております</li><li>(例) SAML 連携しているアプリケーションのサービス プリンシパル</li></ul></li><li>ユーザーが何らかのアプリケーションでの認証時に、Azure AD のアカウントを利用することによって、自動的に追加されたもの</li></ol><p>上記の 2. の方法で追加されるサービス プリンシパルは、「マルチテナント アプリケーション」という種類のアプリです。マルチテナント アプリのサービス プリンシパル登録は、管理者の操作を必要としません。</p><p><strong>マルチテナント アプリ</strong>とは、<strong>Azure AD アカウントを持つすべてのユーザー (テナント内外問わず) による、アプリおよび API の利用を想定して設計</strong>されているアプリです。</p><p>※ 具体的には、マルチテナント アプリは外部の Azure AD のテナントの [アプリの登録] にて登録されています。かつ、サポートしているアカウントとして “任意の組織ディレクトリ内のアカウント (任意の Azure AD ディレクトリ - マルチテナント)” が選択されています。</p><h2 id="どのような操作で、ユーザーによって「マルチテナント-アプリケーション」が追加されるのか？"><a href="#どのような操作で、ユーザーによって「マルチテナント-アプリケーション」が追加されるのか？" class="headerlink" title="どのような操作で、ユーザーによって「マルチテナント アプリケーション」が追加されるのか？"></a>どのような操作で、ユーザーによって「マルチテナント アプリケーション」が追加されるのか？</h2><p>ここでは、弊社が公開しているマルチテナント アプリケーション <a href="https://developer.microsoft.com/ja-jp/graph/graph-explorer">“Microsoft Graph Explorer”</a> を例に説明します。</p><p><a href="https://developer.microsoft.com/ja-jp/graph/graph-explorer">“Microsoft Graph Explorer”</a> は、Microsoft Graph REST API 要求を簡単に作成し、対応する応答を表示できる開発者ツールです。このアプリケーションは、弊社の Azure AD テナント (microsoft.com) の [アプリの登録] 上で、マルチテナント アプリケーションとして登録されています。</p><ul><li>仮定 1 : userA さん (<a href="mailto:&#x75;&#x73;&#x65;&#114;&#x41;&#64;&#99;&#x6f;&#110;&#116;&#x6f;&#115;&#x6f;&#x2e;&#99;&#x6f;&#x6d;">&#x75;&#x73;&#x65;&#114;&#x41;&#64;&#99;&#x6f;&#110;&#116;&#x6f;&#115;&#x6f;&#x2e;&#99;&#x6f;&#x6d;</a>) は、contoso.com の Azure AD に所属するユーザーです。</li><li>仮定 2 : contoso.com の Azure AD の [エンタープライズ アプリケーション] 上には、まだ “Microsoft Graph Explorer” のサービス プリンシパルは存在しません。</li></ul><h3 id="userA-さんによってマルチテナント-アプリ「Graph-Explorer」が追加される時の操作"><a href="#userA-さんによってマルチテナント-アプリ「Graph-Explorer」が追加される時の操作" class="headerlink" title="userA さんによってマルチテナント アプリ「Graph Explorer」が追加される時の操作"></a>userA さんによってマルチテナント アプリ「Graph Explorer」が追加される時の操作</h3><ol><li><p>userA さんは、 <a href="https://developer.microsoft.com/ja-jp/graph/graph-explorer">“Microsoft Graph Explorer”</a> にアクセスします。</p></li><li><p>userA さんは下記のボタンから、自身の Azure AD アカウントで認証します。</p><p> <img src="/blog/azure-active-directory/enterpriseapps-multitenantapps/fig1.png" alt="fig1"></p></li><li><p>パスワード認証後、userA さんには下記の画面が表示されます。この例では、openid, profile, User.Read, offline_access へのアクセス許可が要求されているので、userA さんは “承諾” を押下します。</p><p> <img src="/blog/azure-active-directory/enterpriseapps-multitenantapps/fig2.png" alt="fig2"></p></li></ol><ol start="4"><li><p><a href="mailto:&#117;&#x73;&#101;&#x72;&#65;&#x40;&#x63;&#111;&#x6e;&#x74;&#111;&#115;&#x6f;&#x2e;&#99;&#x6f;&#109;">&#117;&#x73;&#101;&#x72;&#65;&#x40;&#x63;&#111;&#x6e;&#x74;&#111;&#115;&#x6f;&#x2e;&#99;&#x6f;&#109;</a>でのサインインが成功します。</p><p> <img src="/blog/azure-active-directory/enterpriseapps-multitenantapps/fig3.png" alt="fig3"></p></li><li><p>次回以降 userA が Graph Explorer にアクセスする際は、openid, profile, User.Read, offline_access のアクセス許可への同意が要求されることはありません。</p></li></ol><p>userA が上記の操作を行った後、管理者によって contoso.com テナントの [エンタープライズ アプリケーション] を開くと、下記のように “Graph explorer (official site)” という名前のサービス プリンシパル が追加されています。</p><p>正確には、3. でユーザーが  “承諾” を押下したタイミングで、このサービス プリンシパルが作成されています。</p><p><img src="/blog/azure-active-directory/enterpriseapps-multitenantapps/fig4.png" alt="fig4"></p><p>なお、同じアプリケーションのサービス プリンシパルが、テナント上に複数登録されることはありません。userA による上記の操作によって作成されたサービス プリンシパルは、今後他のユーザーが Graph Explorer にアクセスする際にも利用されるようになります。</p><h2 id="よくある質問-1-管理者の知らないところでユーザーによって登録された-マルチテナント-アプリケーションは、Azure-AD-上のリソースにアクセスが可能なのですか？セキュリティ的に心配です。"><a href="#よくある質問-1-管理者の知らないところでユーザーによって登録された-マルチテナント-アプリケーションは、Azure-AD-上のリソースにアクセスが可能なのですか？セキュリティ的に心配です。" class="headerlink" title="よくある質問 (1) 管理者の知らないところでユーザーによって登録された マルチテナント アプリケーションは、Azure AD 上のリソースにアクセスが可能なのですか？セキュリティ的に心配です。"></a>よくある質問 (1) 管理者の知らないところでユーザーによって登録された マルチテナント アプリケーションは、Azure AD 上のリソースにアクセスが可能なのですか？セキュリティ的に心配です。</h2><p>これは「はい」であり「いいえ」です。まず、下記の大原則がございます。</p><ol><li><p>アプリケーションが Azure AD のリソースにアクセスするためには、テナントのユーザーが明示的に “アクセス許可” を付与する操作が必要です。その操作が行われるのは (先ほども出てきた) この画面です。</p><p> <img src="/blog/azure-active-directory/enterpriseapps-multitenantapps/fig2.png" alt="fig2"></p></li><li><p>ユーザーが “アクセス許可” を承諾することができるのは、そのユーザー自身がアクセスできるリソースの範囲に限られます。</p></li><li><p>Azure AD テナント全体 (テナントユーザー全員のリソースや、テナント自体に紐づくデータなど) へのアクセス許可を承諾することができるのは、管理者ユーザーのみです。</p></li></ol><p>“アクセス許可” 自体の考え方や仕組みについては、下記の記事でより詳細に、分かりやすくご紹介しておりますので、こちらをご覧ください。</p><ul><li>「管理者の承認が必要」のメッセージが表示された場合の対処法(<a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework/">https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework/</a>)</li></ul><p>ここでお伝えしたいことの要点は下記の通りです。</p><ul><li><strong>管理者が知らないところで一般ユーザーによって追加されたマルチテナント アプリのサービス プリンシパルが、Azure AD のリソース全体にアクセスできる ! ということは起こりえません</strong> ので、ご安心ください。</li><li>なぜなら、Azure AD のリソース全体にアクセスするための許可 (アプリケーション権限) をサービス プリンシパルに与えられるのは、管理者ユーザーのみだからです。</li><li>一般ユーザーは、自身がアクセス可能な範囲でアプリにアクセス許可を与えることができます。(ユーザー委任の権限)</li></ul><p>先述の例だと、userA は Graph Explorer に対して、下記のアクセスを許可しています。<br>    - userA 自身の基本情報 (openid, profile, User.Read) へのアクセス<br>    - userA が許可済みのアクセスに対する、継続的なアクセス権 (offline_access)<br>    - <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-permissions-and-consent#openid-connect-scopes">profile と offline_access についての詳細はこちら</a></p><h2 id="よくある質問-2-エンタープライズ-アプリケーションが勝手に追加されるのは不本意です。一般ユーザーによるこの操作を禁止することは可能でしょうか"><a href="#よくある質問-2-エンタープライズ-アプリケーションが勝手に追加されるのは不本意です。一般ユーザーによるこの操作を禁止することは可能でしょうか" class="headerlink" title="よくある質問 (2) エンタープライズ アプリケーションが勝手に追加されるのは不本意です。一般ユーザーによるこの操作を禁止することは可能でしょうか?"></a>よくある質問 (2) エンタープライズ アプリケーションが勝手に追加されるのは不本意です。一般ユーザーによるこの操作を禁止することは可能でしょうか?</h2><p>結論から言うと可能です。</p><p>前述の通り、マルチテナント アプリケーションのサービス プリンシパルが追加されるタイミングは、「ユーザーが認証後、アクセス許可を承諾した時」です。<br>なので、ユーザーによるアクセス許可の承諾を禁止することで、マルチテナント アプリケーションの追加もできなくなります。</p><p>これによって、ユーザーの認証後に表示される “アクセス許可” の画面が、下記の画面に置きかわります。</p><p><img src="/blog/azure-active-directory/enterpriseapps-multitenantapps/fig4.png" alt="fig4"></p><p>ユーザーは管理者によってアクセス許可が承諾されない限り、このアプリケーションへアクセスすることができません。</p><p>ユーザーによるアクセス許可の承諾を禁止する設定画面は 2 つございます。</p><h3 id="1-エンタープライズ-アプリケーション-gt-ユーザー設定"><a href="#1-エンタープライズ-アプリケーション-gt-ユーザー設定" class="headerlink" title="1. [エンタープライズ アプリケーション] &gt; [ユーザー設定]"></a>1. [エンタープライズ アプリケーション] &gt; [ユーザー設定]</h3><p><img src="/blog/azure-active-directory/enterpriseapps-multitenantapps/fig5.png" alt="fig5"></p><p>設定項目 : [ユーザーは、アプリが自身の代わりに会社のデータにアクセスすることを許可できます]<br>この項目を “いいえ” にすることで、ユーザーはアプリケーションに対していかなるアクセス許可も承諾することができなくなります。 </p><h3 id="2-エンタープライズ-アプリケーション-gt-同意とアクセス許可"><a href="#2-エンタープライズ-アプリケーション-gt-同意とアクセス許可" class="headerlink" title="2. [エンタープライズ アプリケーション] &gt; [同意とアクセス許可]"></a>2. [エンタープライズ アプリケーション] &gt; [同意とアクセス許可]</h3><p><img src="/blog/azure-active-directory/enterpriseapps-multitenantapps/fig6.png" alt="fig6"></p><p>この画面では、前述の [ユーザー設定] よりも細かい設定が可能です。設定内容はより細かくなりましたが、前述の [ユーザーは、アプリが自身の代わりに会社のデータにアクセスすることを許可できます] と同一の設定ですので、[同意とアクセス許可] の画面で設定を変更すると、[ユーザー設定] の画面でも変更が反映されます。<br>[ユーザー設定] では、ユーザーによるアクセス許可承諾の可否は “はい” “いいえ” のみが選べますが、ここではその中間の選択肢があります。それが “確認済みの発行元からのアプリに対して選択されたアクセス許可を与えることへのユーザーの同意を許可する (推奨)” です。</p><p>とてもカジュアルに言い換えると、「発行元が怪しくないアプリケーションに対する、部分的なアクセス許可であれば、一般ユーザーでも承諾することができる」ということです。</p><ul><li>“確認済みの発行元” とは、「自身のテナント」+「Microsoft によって認められた発行元」のことを指します。「Microsoft によって認められた発行元」についての詳細は下記の公開情報をご覧ください。<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/publisher-verification-overview">発行者の確認(docs.microsoft.com)</a></li></ul></li><li>“選択されたアクセス許可” とは、管理者があらかじめ [アクセス許可の分類] に登録したアクセス許可のことです。<ul><li>設定画面 : [エンタープライズ アプリケーション] &gt; [同意とアクセス許可] &gt; [アクセス許可の分類]</li></ul></li></ul><h2 id="よくある質問-3-ユーザーによるアクセス許可の承諾を一切禁止したので、勝手にマルチテナント-アプリケーションが追加されることはなくなりました！ただし、ユーザーが本当に必要なマルチテナント-アプリケーションの利用を許可するには、どうすればいいでしょうか。"><a href="#よくある質問-3-ユーザーによるアクセス許可の承諾を一切禁止したので、勝手にマルチテナント-アプリケーションが追加されることはなくなりました！ただし、ユーザーが本当に必要なマルチテナント-アプリケーションの利用を許可するには、どうすればいいでしょうか。" class="headerlink" title="よくある質問 (3) ユーザーによるアクセス許可の承諾を一切禁止したので、勝手にマルチテナント アプリケーションが追加されることはなくなりました！ただし、ユーザーが本当に必要なマルチテナント アプリケーションの利用を許可するには、どうすればいいでしょうか。"></a>よくある質問 (3) ユーザーによるアクセス許可の承諾を一切禁止したので、勝手にマルチテナント アプリケーションが追加されることはなくなりました！ただし、ユーザーが本当に必要なマルチテナント アプリケーションの利用を許可するには、どうすればいいでしょうか。</h2><p>結論から言うと、「ユーザーに代わって、管理者が代わりにアクセス許可を付与すること」が必要です。</p><p>再掲になりますが、下記の記事で手順をご紹介しています。</p><ul><li>「管理者の承認が必要」のメッセージが表示された場合の対処法(<a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework/">https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework/</a>)</li></ul><p>以上の情報がご参考になれば幸いです。<br>ご不明な点がございましたら弊社サポートまでお気軽にお問い合わせください !</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity チームの栗井です。&lt;/p&gt;
&lt;p&gt;突然ですが、Azure AD の管理者ユーザー様からよく、下記のようなお問い合わせをいただきます。&lt;/p&gt;
&lt;p&gt;「Azure AD の [エンタープライズ アプリケーション] 一覧に、管理者が追加</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Application" scheme="https://jpazureid.github.io/blog/tags/Application/"/>
    
  </entry>
  
  <entry>
    <title>App Service 認証を利用して複数のテナントの Azure AD ユーザーをサインインさせる方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/app-service-auth-multi-tenant/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/app-service-auth-multi-tenant/</id>
    <published>2021-06-29T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.087Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの高田です。今回は、App Service 認証を利用して複数のテナントの Azure AD ユーザーを App Service にサインインさせる方法について案内いたします。</p><p>まず、App Service は Web サイトや REST API など HTTP ベースのサービスを公開するための Azure のサービスです。例えば Visual Studio で開発した ASP.NET Core アプリケーションを Azure を用いて公開したい場合、Visual Studio の Publish 機能を用いることで非常に簡単に実現できます。またお客様によっては、そのようにして公開した Web サイトに対し認証機能を組み込みたい場合もあると思います。この場合に活用いただけるのが App Service 認証です (Easy Auth という名称で呼ばれることもあります)。</p><p>以下では、App Service 認証を利用して複数の Azure AD テナントのユーザーを App Service 上の Web サイトにサインインさせる方法をご紹介します。Web サイトの公開範囲ごとにシナリオを分けて解説していきます。</p><ul><li>シナリオ 1: App Service の Web サイトを自テナントのユーザーだけに公開したい</li><li>シナリオ 2: 主に自テナントのユーザー向けに提供している App Service の Web サイトを別テナントの一部ユーザーにもアクセスさせたい</li><li>シナリオ 3: App Service の Web サイトを複数の Azure AD テナントのユーザーにアクセスさせたい</li></ul><p>以下にシナリオごとに順に解説していきます。以下のシナリオは、全て ASP.NET Core Web アプリケーションなどを Visual Studio などから App Service に Publish 済みであるということを前提とします。App Service へ ASP.NET Core アプリケーションを展開する方法については、<a href="https://docs.microsoft.com/ja-jp/aspnet/core/host-and-deploy/azure-apps/?view=aspnetcore-5.0&tabs=visual-studio">Azure App Service に ASP.NET Core アプリを展開する</a> などのページをご覧ください。</p><h2 id="シナリオ-1-App-Service-の-Web-サイトを自テナントのユーザーだけに公開したい"><a href="#シナリオ-1-App-Service-の-Web-サイトを自テナントのユーザーだけに公開したい" class="headerlink" title="シナリオ 1: App Service の Web サイトを自テナントのユーザーだけに公開したい"></a>シナリオ 1: App Service の Web サイトを自テナントのユーザーだけに公開したい</h2><p>まず最も基本的なパターンとして、App Service のサイトを自テナントのユーザーだけに公開したい場合を考えます。この場合、必要なのは、App Service 認証の設定のみです。App Service 認証の設定を行うだけで、アプリへのアクセス時に Azure AD での認証が求められるようになります。また認証が求められた際には、そのアプリが登録されている Azure AD テナントのユーザーのみがサインイン可能です。</p><p>App Service を構成するため以下の手順を進めます。以下の手順は <a href="https://docs.microsoft.com/ja-jp/azure/app-service/scenario-secure-app-authentication-app-service#configure-authentication-and-authorization">チュートリアル: Azure App Service で実行されている Web アプリに認証を追加する</a> でも解説がありますので、よろしければ併せてご参照ください。</p><ol><li>Auzre ポータルに App Service の管理者でサインインし、App Service を開きます。</li><li>App Service 認証を構成したい Web アプリを選びます。</li><li>[認証] を選択して、[ID プロバイダーを追加] を選択します。</li><li>[ID プロバイダー] として [Microsoft] を選択します。</li><li>[アプリの登録の種類] が [アプリの登録を新規作成する] であることを確認します。</li><li>[サポートされているアカウントの種類] が [現在のテナント - 単一テナント] であることを確認します。</li><li>[認証] が [認証が必要] に設定されていることを確認します。</li><li>[追加] を選択します。</li></ol><p><img src="/blog/azure-active-directory/app-service-auth-multi-tenant/screen1.png"></p><p>以上で操作は可能です。Web サイトの URL にアクセスいただくと、Azure AD の認証画面が表示されるようになります。上記操作を行った Azure AD テナントのユーザーを指定すれば、アプリにサインインできます。</p><p>なお、ユーザーが App Service 認証を経由して Web アプリにアクセスすると、Web アプリには以下のような値を含む HTTP ヘッダーが渡されます。Web アプリはこのヘッダーの値を確認することで、どのようなユーザーがサインインしてきたかを識別可能です。詳細については <a href="https://docs.microsoft.com/ja-jp/azure/app-service/app-service-authentication-how-to#access-user-claims">Azure App Service 上での認証と承認の高度な使用方法 - ユーザー要求へのアクセス</a> もご参照ください。</p><table><thead><tr><th>HTTP ヘッダーの名前</th><th>ヘッダーの値 (例)</th></tr></thead><tbody><tr><td>X-MS-CLIENT-PRINCIPAL-NAME</td><td><a href="mailto:&#116;&#x65;&#115;&#116;&#64;&#x63;&#111;&#x6e;&#116;&#x6f;&#x73;&#111;&#46;&#99;&#111;&#109;">&#116;&#x65;&#115;&#116;&#64;&#x63;&#111;&#x6e;&#116;&#x6f;&#x73;&#111;&#46;&#99;&#111;&#109;</a></td></tr><tr><td>X-MS-CLIENT-PRINCIPAL-ID</td><td>bfef01fb-9b32-457a-b488-690de651bf7f</td></tr></tbody></table><h2 id="シナリオ-2-主に自テナントのユーザー向けに提供している-App-Service-の-Web-サイトを別テナントの一部ユーザーにもアクセスさせたい"><a href="#シナリオ-2-主に自テナントのユーザー向けに提供している-App-Service-の-Web-サイトを別テナントの一部ユーザーにもアクセスさせたい" class="headerlink" title="シナリオ 2: 主に自テナントのユーザー向けに提供している App Service の Web サイトを別テナントの一部ユーザーにもアクセスさせたい"></a>シナリオ 2: 主に自テナントのユーザー向けに提供している App Service の Web サイトを別テナントの一部ユーザーにもアクセスさせたい</h2><p>このシナリオの場合、Azure AD が提供する B2B ゲスト招待機能を利用することが適切です。App Service 認証はシナリオ 1 と同様に単一テナントとして構成し、自テナントに外部テナントのユーザーをゲスト招待します。外部テナントのユーザーを都度招待するということが手間でなければ (事前にこのユーザーは App Service の Web サイトアクセスさせたいというのがわかっていれば)、Azure AD の観点でも適切な方法になります。</p><p>上述のとおり、このシナリオの場合は App Service 認証の観点では特に構成変更の必要はありません。シナリオ 1 に加えて、以下の Azure AD 側の対応 (ゲストの招待操作) を実施いただければと思います。</p><ol><li>Auzre ポータルにアクセスします。</li><li>App Service を構成しているテナントに Azure AD のグローバル管理者やゲスト招待元のディレクトリ ロールを持つユーザーでサインインします。</li><li>Azure Active Directory ブレードに進み、[ユーザー] を開きます。</li><li>[+ 新しいゲスト ユーザー] を押します。</li><li>招待したい外部校テナントのユーザーの E メール アドレス (<a href="mailto:&#116;&#101;&#x73;&#x74;&#x40;&#102;&#x61;&#98;&#114;&#x69;&#x6b;&#97;&#109;&#x2e;&#x63;&#x6f;&#109;">&#116;&#101;&#x73;&#x74;&#x40;&#102;&#x61;&#98;&#114;&#x69;&#x6b;&#97;&#109;&#x2e;&#x63;&#x6f;&#109;</a>) を入力して、招待ボタンを押します。</li><li>指定されたユーザーで招待メールが届いているかを確認します。</li><li>招待メールを受け取ったユーザーは、メールに従い招待の処理を完了します。</li></ol><p>以上の操作を行うことで、招待処理を完了したユーザーは、App Service を構成している Azure AD テナントにゲストとして Azure AD アカウントが作成されます。これにより、そのゲスト ユーザーは App Service を構成している Azure AD テナント上のユーザーとして認識されます。このため App Service 認証の設定が単一テナントのままでも、その Web サイトにサインインが可能になります。招待していないユーザーで Web サイトにアクセスしようとするとそのユーザーはアクセスがブロックされます。</p><h2 id="シナリオ-3-App-Service-の-Web-サイトを複数の-Azure-AD-テナントのユーザーにアクセスさせたい"><a href="#シナリオ-3-App-Service-の-Web-サイトを複数の-Azure-AD-テナントのユーザーにアクセスさせたい" class="headerlink" title="シナリオ 3: App Service の Web サイトを複数の Azure AD テナントのユーザーにアクセスさせたい"></a>シナリオ 3: App Service の Web サイトを複数の Azure AD テナントのユーザーにアクセスさせたい</h2><p>上記シナリオ 2 では、App Service の Web サイトに外部のユーザーをアクセスさせるにあたり個別にゲスト ユーザーの招待が必要でした。個別に招待を行うのではなく、複数の Azure AD テナントのユーザーに Web サイトへのアクセスを許可したい場合は、App Service 認証を単一テナントではなく、マルチテナントとして構成します。これにより、どの Azure AD テナントからでもその Web サイトにアクセスさせることができるようになります。</p><p>まず、既に単一テナントで App Service 認証を構成している場合は、以下の手順に沿って既存の構成を一旦削除ください。</p><ol><li>Auzre ポータルに App Service の管理者でサインインし、App Service を開きます。</li><li>App Service 認証を構成したい Web アプリを選びます。</li><li>[認証] を選択して、[認証の設定] の隣にある [編集] を選択します。</li><li>[認証されていないアクセスを許可する] を選択して、[保存] を押下します。</li><li>[ID プロバイダー] から Microsoft を探して、削除のアイコンをクリックします。</li><li>確認画面で [削除] を選択します。</li></ol><p>続いて、マルチテナントとして構成するため ID プロバイダーを追加しなおします。</p><ol><li>[ID プロバイダーを追加] を選択します。</li><li>[ID プロバイダー] として [Microsoft] を選択します。</li><li>[アプリの登録の種類] が [アプリの登録を新規作成する] であることを確認します。</li><li>[サポートされているアカウントの種類] で [任意の Azure AD ディレクトリ - マルチテナント] を選択します。</li><li>[認証] が [認証が必要] に設定されていることを確認します。</li><li>[追加] を選択します。</li></ol><p>なお、[追加] を押下した際に、同じ名前のアプリケーションが既に存在するメッセージが表示されるかと思います。これは先に単一テナントで App Service 認証を構成したときのアプリケーション オブジェクトが Azure AD 側に残っているためです。メッセージを回避するには名前を別のものに変更するか、以下の手順で Azure AD から該当のアプリケーション オブジェクトを削除して再度同じ名前で追加を実施ください。</p><ol><li>Azure Active Directory ブレードを開き、[アプリの登録] を開きます。</li><li>検索ボックスにアプリケーションの名前を入力します。</li><li>結果が表示されたらそれをクリックします。</li><li>[削除] を選択します。</li><li>確認が求められたら [削除] を再度押下します。</li></ol><p>ID プロバイダーの追加が完了したら、さらに以下の操作を行います。</p><ol><li>[ID プロバイダー] から Microsoft を探して、編集のアイコンをクリックします。</li><li>[発行者の URL] を <a href="https://login.microsoftonline.com/common/v2.0">https://login.microsoftonline.com/common/v2.0</a> に変更します。</li><li>[保存] を選択します。</li></ol><p><img src="/blog/azure-active-directory/app-service-auth-multi-tenant/screen2.png"></p><p>以上で操作は完了です。</p><p>Azure AD ではアプリケーション オブジェクト側の構成とログオン時の URL の指定内容によって、どのユーザーがアプリケーションにサインイン可能かを制御しています。元々上記 [発行者の URL] にはテナント ID を含む値が指定されていました。この場合、アプリケーションがマルチテナントで構成されていても、そのアプリにサインインできるのはその指定されたテナント上のユーザーのみとなります。発行者の URL を <a href="https://login.microsoftonline.com/common/v2.0">https://login.microsoftonline.com/common/v2.0</a> に書き換えると、URL としてもマルチテナントを受け入れるようになるため、複数のテナントのユーザーからサインインが可能となります。</p><p>なお、上記状態では構成したとおり様々な Azure AD テナントから Web アプリにアクセスが可能となります。もしアプリを特定の数テナントだけにアクセスさせたいという場合は、アプリケーション側で X-MS-CLIENT-PRINCIPAL-NAME ヘッダーの値を確認し、サインインしたユーザーのドメイン名が意図したものでなければアクセスを拒否するなどの対応をご検討ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの高田です。今回は、App Service 認証を利用して複数のテナントの Azure AD ユーザーを App Service にサインインさせる方法について案内いたします。&lt;/p&gt;
&lt;p&gt;まず、App</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="App Service" scheme="https://jpazureid.github.io/blog/tags/App-Service/"/>
    
  </entry>
  
  <entry>
    <title>PIM の活用方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/pim-overview/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/pim-overview/</id>
    <published>2021-06-14T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.275Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの福島です。</p><p>システムの管理者は、定常運用時における運用管理アカウントのアクセス権管理に悩まれていないでしょうか。</p><p>今回のブログでは、”最低限必要な権限” を ”最低限必要な人間” に ”最低限の期間” 付与することが出来る Previleged Identity Management (PIM) という機能についてご紹介します。</p><span id="more"></span><p>例えば、自社のシステムが Azure 上でリリースされた後も下記のようなトラブルが発生した時には運用管理アカウントで Azure ポータルにサインインしてシステム変更作業を行う必要があると思います。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. 一般ユーザーが MFA 用に利用していたスマートフォンを紛失したため、該当アカウントの MFA 情報をリセットする必要がある</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. Azure AD に登録したアプリケーションのシークレットの有効期限が切れるため、新しいシークレットを発行する必要がある</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. 新しく発行したアプリケーションのシークレットをサブスクリプション X のリソースグループ A にある Key Vault に登録する必要がある</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. 業務アプリケーションが稼働するサブスクリプション X のリソースグループ A にある Azure VM がハングアップしたので、Azure ポータルから強制的に再起動する必要がある</span><br></pre></td></tr></table></figure><p> それぞれの作業を行うには Azure 上で下記のようなアクセス権を運用管理アカウントに付与する必要があります。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. -&gt; Azure AD ロールのユーザー管理者</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. -&gt; Azure AD ロールのクラウドアプリケーション管理者</span><br><span class="line"></span><br><span class="line"><span class="number">3.4</span>. -&gt; リソースグループ A の共同作成者</span><br></pre></td></tr></table></figure><p>Azure 上ではアクセス権はロール (役割) として集約されており、ロールには大きく <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/roles/permissions-reference">Azure AD ロール</a> と <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/rbac-and-directory-admin-roles#azure-roles">Azure リソースロール</a> があります。<br>前者は Azure Active Directory 上のアクセス権を示すのに対して、後者は Azure サブスクリプションに作成したリソース (VM や App Service など) に対するアクセス権を指します。<br>これらのロールは Azure テナント上で最上位の権限を持つグローバル管理者 (システム管理者) が、Azure ポータル上で運用管理アカウントに対してアクセス権として付与してあげれば何ら問題はありません。<br>しかし、セキュリティに厳格な会社では実際にアクセス権を付与するまでに様々なステップがあるものと思います。<br><img src="/blog/azure-active-directory/pim-overview/pic01.jpg"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. 運用担当者はシステム変更日時、システム変更内容、システム変更に必要なアクセス権 (ロール) をメールなどに記載してシステム管理者に申請します。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. システム管理者はメールに記載されたシステム変更作業の日時や変更作業内容を精査して問題なければ指定されたアクセス権 (ロール) を運用管理アカウントに付与します。</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. 作業日当日、運用担当者はアクセス権 (ロール) を付与された運用管理アカウントを利用して Azure にサインインし、システム変更作業を行います。作業完了後はシステム管理者に報告を行います。</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. システム管理者はシステム変更作業の完了報告を確認し、問題がなければ運用アカウントに付与したアクセス権 (ロール) を削除します。</span><br></pre></td></tr></table></figure><p>しかし、これらの作業ステップには図中に記載の通り様々な問題があります。</p><ul><li><p>実際のシステム変更作業を行っていないシステム管理者にもかなりの作業負担がある。</p></li><li><p>前日にアクセス権の付与を行った後に、作業日当日まで時間が空いている場合は必要以上に長い期間運用管理アカウントに強力なアクセス権 (ロール) が付与された状態になる。</p></li><li><p>万が一、システム管理者が運用管理アカウントに付与したアクセス権 (ロール) を削除し忘れた場合、運用管理アカウントは永続的に強力なアクセス権を保持することになる。</p></li></ul><p>上記の問題のうち、特に後半 2 つについては「セキュリティ」的な懸案事項になるかと思います。<br>万が一、運用管理アカウントに強力なアクセス権が付与されていた状態で運用管理アカウントの資格情報が漏洩し、悪意ある攻撃者によって企業の Azure テナントに不正に侵入されてしまった場合、攻撃者は運用管理アカウントに付与されたアクセス権 (ロール) を悪用して可能な限りの不正行為、資産の奪取を行うことが想定されます。</p><p>このようなリスク (攻撃者によるアカウントの乗っ取りが発生した時に、保持するアクセス権に応じてセキュリティ被害が拡大してしまうリスク) を最小限にするべく、アクセス権の管理は冒頭に記載の通り「最小権限の原則」に則り、”最低限必要な権限” を ”最低限必要な人間” に ”最低限の期間” 付与することが望ましいといえます。</p><h1 id="PIM-を使った-Just-in-Time-のアクセス権"><a href="#PIM-を使った-Just-in-Time-のアクセス権" class="headerlink" title="PIM を使った Just in Time のアクセス権"></a>PIM を使った Just in Time のアクセス権</h1><p>Azure では、上述した「最小権限の原則」に則り「セキュリティ」リスクを最小化する機能として Previleged Identity Management (PIM) が提供されています。</p><p>PIM を利用した場合、システム管理者は運用管理アカウントに対して<code>「対象割り当て」</code>と<code>「アクティブ割り当て」</code>という 2 つのロールアサインを行うことが可能です。</p><p><code>「アクティブ割り当て」</code>は、PIM を利用しない場合と同様に特定のロールを割り当て時点で有効状態として割り当てることを指します。<br>一方で<code>「対象割り当て」</code>を行った場合、運用管理アカウントはそのままでは割り当てられたロールの権限を保有することは出来ません。<br>実際に割り当てられたロールのアクセス権を保有したい場合は、ロールの<code>アクティブ化</code>処理を行う必要があります。<br>また、<code>アクティブ化</code>処理を行う際には特定アカウントの<code>承認</code>を必須とすることも可能です。<br>加えて一度アクティブ化されたロールは既定の場合 8 時間のみ有効で、8 時間が経過した後は自動的にアクティブ化が解除されます。</p><p><img src="/blog/azure-active-directory/pim-overview/pic03.jpg"></p><p>これらの PIM の動作をシステム変更管理プロセスに組み込むと下記のように運用することが可能です。</p><p><img src="/blog/azure-active-directory/pim-overview/pic02.jpg"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. システム管理者はシステムの運用開始日に運用管理アカウントに特定ロールを「対象割り当て」でアサインします。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. 運用担当者は運用変更作業が発生した日に「対象割り当て」を受けたロールのアクティブ化処理を行います。</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. 運用責任者 (運用担当者の上長など) は、運用担当者が行ったアクティブ化処理の承認処理を行います。</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. 承認を受けた運用担当者は実際のシステム変更作業を行います。</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>. アクティブ化の有効期限 (既定で <span class="number">8</span> 時間) を迎えれば、自動的にアクティブ化されたロールが無効化されます。</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>. 「対象割り当て」の期間は既定で <span class="number">1</span> 年間となっていますので、<span class="number">1</span> 年間の間は必要に応じて何度もアクティブ化処理を行うことが可能です。</span><br></pre></td></tr></table></figure><p>一見すると冒頭に記載したステップとあまり変わらないように見えますが、運用期間が長くなるほどそのメリットが見えてきます。</p><ul><li><p>システム管理者は運用開始日の「対象割り当て」作業のみを行い、以降のシステム変更を運用部門に完全に移管することが出来ます。</p></li><li><p>「対象割り当て」期間中、運用管理アカウントは実際のアクセス権を行使することは出来ません。万が一攻撃者にアカウントが乗っ取られた場合も攻撃者はロールのアクセス権を悪用することが出来ません。</p></li><li><p>実際にロールのアクセス権をアクティブ化して利用するためには、運用担当者以外のユーザー (上記例の場合、運用担当者の上長である運用責任者) によってアクティブ化の承認を行う必要があります。そのため、万が一運用管理アカウントが乗っ取られていた場合も承認処理によって水際対策を行うことが可能です。</p></li><li><p>承認によってアクティブ化されたロールは既定で 8 時間だけ有効です。有効時間が過ぎた場合アクティブ化されたロールは自動的に無効になり、運用管理アカウントのアクセス権は作業前の状態に戻ります。(アクセス権の削除忘れが発生することはありません。また、作業日当日に必要な時間帯だけロールが有効化される、まさに Just in Time のアクセス権となります。)</p></li></ul><h1 id="PIM-の参考画面"><a href="#PIM-の参考画面" class="headerlink" title="PIM の参考画面"></a>PIM の参考画面</h1><p>もっとイメージがつきやすいように実際に PIM を利用した画面をみてみましょう。</p><p>・システム管理者は事前に「ユーザー管理者」ロールの承認者として「運用管理責任者」を登録しておきます。</p><p><img src="/blog/azure-active-directory/pim-overview/pic04.jpg"></p><p>・その後、運用管理アカウントに対して「ユーザー管理者」ロールを<code>対象割り当て</code>でアサインします。</p><p><img src="/blog/azure-active-directory/pim-overview/pic05.jpg"><br><img src="/blog/azure-active-directory/pim-overview/pic06.jpg"></p><p>・運用管理アカウントは作業日の当日に、<code>対象割り当て</code>を受けたロールをアクティブ化します。</p><p><img src="/blog/azure-active-directory/pim-overview/pic07.jpg"><br><img src="/blog/azure-active-directory/pim-overview/pic08.jpg"></p><p>・運用管理責任者に自動的に承認要求のメールが届きますので、運用管理責任者はこれを承認します。</p><p><img src="/blog/azure-active-directory/pim-overview/pic09.jpg"><br><img src="/blog/azure-active-directory/pim-overview/pic10.jpg"></p><p>・運用管理アカウントのロールがアクティブ化されたので運用管理担当者はシステム変更作業を開始します。アクティブ化時間は既定で 8 時間となっていますので、8 時間以内に作業を完了します。</p><p><img src="/blog/azure-active-directory/pim-overview/pic11.jpg"></p><p>・8 時間後には自動的にアクティブ化されたロールが無効化されます。</p><p><img src="/blog/azure-active-directory/pim-overview/pic13.jpg"></p><h1 id="よくある質問と回答"><a href="#よくある質問と回答" class="headerlink" title="よくある質問と回答"></a>よくある質問と回答</h1><blockquote><p><em><strong>PIM を利用するのにライセンスが必要ですか？</strong></em></p></blockquote><p>はい。PIM を利用するためには、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/privileged-identity-management/subscription-requirements">Azure Active Directory P2 ライセンスが必要</a>です。<br>追加のコストは掛かりますが、上述の通り長期的な目線で見ればシステム管理者の負担の軽減やセキュリティリスクの最小化を実現することができますので、是非ご検討いただければと思います。</p><blockquote><p><em><strong>PIM を利用しないと Azure を安全に利用できないということですか？</strong></em></p></blockquote><p>いいえ。PIM はアカウントが乗っ取られた場合のセキュリティリスクを最小化する機能 (且つ運用負担を軽減する機能) ではありますが、アカウントの「認証」自体を強固にする機能ではありません。Azure では「認証」に多要素認証 (MFA) を用いていることでアカウント保護をより強固にすることが可能であり、Azure Active Direcotory では「セキュリティの既定値群」などを利用して既定の状態で強力なアカウント保護機能を提供しておりますので、PIM を利用しない場合も Azure Active Directory は強固なセキュリティ対策機能を保持しているとお考えいただいて問題ありません。</p><p>*PIM のアクティブ化時に多要素認証 (MFA) 済トークンを必須とすることは可能ですが、多要素認証 (MFA) 済のセッションが端末ごと悪意あるユーザーに奪取された場合にはそのままアクティブ化を実行されてしまいますので、必ず「承認」のプロセスで水際対策することを推奨します。また、多要素認証 (MFA) といった認証の強度を構成する設定は別途「条件付きアクセス」といった認証・認可を専任で設定する機能に一元化することが適しています。</p><p>*「最小権限の原則」については、PIM を利用しない状態でもシステム管理者が運用担当者と物理的に近くで働いており、最短時間でのアクセス権付与・ダブルチェック・アクセス権の削除を実施できるようであれば、いわば手動で「最小権限の原則」を実現することは可能です。しかし、これらの項目はシステム管理者の労力を多く伴うものであり、または運用ミスが発生する可能性もございますので、これらのタスクを自動化する PIM を是非ご活用いただければと存じます。</p><blockquote><p><em><strong>ロール毎に承認者を設定することが出来ますか？</strong></em></p></blockquote><p>「ユーザー管理者」などの Azure AD ロールは Azure AD テナント上で一意のロールとなるため、Azure AD ロール 1 つに対して承認者を決定します。</p><p>(例 : 「ユーザー管理者」の承認者をリーダー A に設定し、「クラウドアプリケーション管理者」の承認者をリーダー B に設定します。)</p><p>一方で Azure AD リソースのロール (「共同作成者」など) は管理グループ、サブスクリプション、リソースグループ、リソース毎に用意されており、それぞれに別の承認者を設定することが可能です。</p><p>(例 : リソースグループ A の「共同作成者」の承認者をリーダー A に設定し、リソースグループ B の「共同作成者」の承認者をリーダー B に設定します。)</p><blockquote><p><em><strong>最低限の権限が良いということは Azure リソース毎、且つ運用操作毎にロールを定義しておいたほうが良いのでしょうか？(例 : ”Restart Virtual Machine” というアクションのみを許可したカスタムロールを作成し VM1 のみに付与できるようにする、など)</strong></em></p></blockquote><p>極端なことを言えば記載された方法も考えられます。しかし、カスタムロールを作成するコストと、複数リソースの複数操作が必要になったときに複数のカスタムロール毎に「対象割り当て」「アクティブ化」「承認」を行う運用コストが、それによって得られるセキュリティメリットと釣り合わないものと思います。そのため、上記の例では最低限の作業対象をリソースグループとし、操作権限の纏まりはビルトインの「共同作成者」としています。</p><p>*多くの会社では、チーム毎にリソースグループを用意し、そのリソースグループにチームが管理する対象の複数リソースを纏めていることから、リソースグループはロールの割り当て対象として最も適しているものと思います。</p><p>*アクセス権にはアクセスレベル (読み取り、書き込みなど) とアクセス範囲 (A リソースと B リソース含むなど) という考え方があります。(縦軸と横軸のイメージです。) 「共同作成者」は最上位のアクセスレベルを保有しますが、アクセス範囲が 1 リソースグループに限定されていることからも、運用レベルに合った ”最低限のアクセス権” と定義することができるものと思います。</p><blockquote><p><em><strong>PIM によるロールのアクティブ化は監査できますか？</strong></em></p></blockquote><p>はい、PIM を利用したロールのアクティブ化は Azure AD の監査ログに情報が記録されます。参考情報としてアクティブ化の承認が行われた時は <code>Add member to role approval requested (PIM activation)</code> が記録され、自動的にアクティブ化が無効化された場合は <code>Remove member from role (PIM activation expired)</code> が記録されます。システム変更日の後日に作業履歴を確認する場合は、Azure AD の監査ログでこれらのログをご確認いただければと思います。</p><h1 id="終わりに"><a href="#終わりに" class="headerlink" title="終わりに"></a>終わりに</h1><p>いかがでしたでしょうか。PIM は Azure AD Premium P2 という追加のライセンスが必要になりますが、その分システム管理者が多くのメリットを享受できるものと思います。<br>本ブログが少しでもお役に立てれば幸甚ですので、是非 PIM の活用についてご検討ください。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの福島です。&lt;/p&gt;
&lt;p&gt;システムの管理者は、定常運用時における運用管理アカウントのアクセス権管理に悩まれていないでしょうか。&lt;/p&gt;
&lt;p&gt;今回のブログでは、”最低限必要な権限” を ”最低限必要な人間” に ”最低限の期間” 付与することが出来る Previleged Identity Management (PIM) という機能についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Security" scheme="https://jpazureid.github.io/blog/tags/Security/"/>
    
    <category term="PIM" scheme="https://jpazureid.github.io/blog/tags/PIM/"/>
    
  </entry>
  
  <entry>
    <title>Azure における ゲスト ユーザー招待 (B2B) のよくある質問</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/b2bfaq/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/b2bfaq/</id>
    <published>2021-05-31T01:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.131Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。 Azure Identity サポート チームです。<br>こちらのブログでは、Azure における ゲスト ユーザー招待 (B2B) のよくある質問をお纏めいたしました。</p><p>それぞれ 招待をする側 と 招待された側にわけて記載をしておりますので、以下のリンクより参照いただけますと幸いです。</p><ul><li><a href="#1-%E6%8B%9B%E5%BE%85%E3%81%97%E3%81%9F%E5%81%B4%E3%81%AE%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E8%B3%AA%E5%95%8F">1.招待した側のよくある質問</a></li><li><a href="#2-%E6%8B%9B%E5%BE%85%E3%81%95%E3%82%8C%E3%81%9F%E5%81%B4%E3%81%AE%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E8%B3%AA%E5%95%8F">2.招待された側のよくある質問</a></li></ul><p>なお、B2B についてのご説明は以下のブログにもおまとめしておりますので、機能のご紹介は以下を参照ください。</p><ul><li><a href="/blog/azure-active-directory/what-is-b2b/">Azure AD B2B とは | Japan Azure Identity Support Blog</a></li></ul><p>また、本ブログでは ユーザーが元々所属している Azure AD を “ホーム ディレクトリ”<br>そのユーザーが招待された先の Azure AD を “招待先ディレクトリ” と記載します。</p><p><img src="/blog/azure-active-directory/b2bfaq/image01.png"></p><h2 id="1-招待した側のよくある質問"><a href="#1-招待した側のよくある質問" class="headerlink" title="1.招待した側のよくある質問"></a>1.招待した側のよくある質問</h2><p><img src="/blog/azure-active-directory/b2bfaq/image02.png"></p><h3 id="Q-ゲスト-ユーザーを招待した際に名前-表示名-を指定しましたが、後日確認すると違う名前が表示されました。なぜですか"><a href="#Q-ゲスト-ユーザーを招待した際に名前-表示名-を指定しましたが、後日確認すると違う名前が表示されました。なぜですか" class="headerlink" title="Q. ゲスト ユーザーを招待した際に名前 (表示名) を指定しましたが、後日確認すると違う名前が表示されました。なぜですか?"></a>Q. ゲスト ユーザーを招待した際に名前 (表示名) を指定しましたが、後日確認すると違う名前が表示されました。なぜですか?</h3><p>A. ゲスト ユーザーの名前は、ユーザーが招待に承諾した際にホーム ディレクトリ側の情報で上書きします。<br>そのため、招待時に指定した名前は 招待への承諾時に変更されます。</p><p><img src="/blog/azure-active-directory/b2bfaq/image03.png"></p><p>ホーム ディレクトリとは異なる、招待先ディレクトリ独自の名前を設定する場合には、招待への承諾後に再度変更します。</p><p><img src="/blog/azure-active-directory/b2bfaq/image04.png"></p><h3 id="Q-招待したゲスト-ユーザーからサインインができないと連絡がありました。対処方法を教えて下さい"><a href="#Q-招待したゲスト-ユーザーからサインインができないと連絡がありました。対処方法を教えて下さい" class="headerlink" title="Q. 招待したゲスト ユーザーからサインインができないと連絡がありました。対処方法を教えて下さい"></a>Q. 招待したゲスト ユーザーからサインインができないと連絡がありました。対処方法を教えて下さい</h3><p>A. ゲスト ユーザーであっても、サインインはホーム ディレクトリにて行われます。<br>そのため、まずは招待したゲスト ユーザーが ホーム ディレクトリ にサインインができるかを切り分けてください。</p><p>“ホーム ディレクトリ” にもサインインができない場合には、”ホーム ディレクトリ” 側での対応が必要となりますので招待した側のディレクトリの管理者で対応できません。<br>一方、ホーム ディレクトリにはサインインができるが、”招待先ディレクトリ” にはサインインができない場合には、招待した側のディレクトリにて調査します。</p><p>ゲスト ユーザーのよくある サインインができない問題については、<a href="#2-%E6%8B%9B%E5%BE%85%E3%81%95%E3%82%8C%E3%81%9F%E5%81%B4%E3%81%AE%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E8%B3%AA%E5%95%8F">2.招待された側のよくある質問</a> に記載しています。</p><h3 id="Q-招待したいユーザーがメールを受信できないアカウントです。メールを受信できなければ、ゲスト-ユーザーとして招待できませんか"><a href="#Q-招待したいユーザーがメールを受信できないアカウントです。メールを受信できなければ、ゲスト-ユーザーとして招待できませんか" class="headerlink" title="Q. 招待したいユーザーがメールを受信できないアカウントです。メールを受信できなければ、ゲスト ユーザーとして招待できませんか?"></a>Q. 招待したいユーザーがメールを受信できないアカウントです。メールを受信できなければ、ゲスト ユーザーとして招待できませんか?</h3><p>A. メールを受信できないユーザーであっても招待することが可能です。<br>( メールを受信できないユーザーとは  <a href="mailto:&#x78;&#x78;&#120;&#64;&#x63;&#111;&#110;&#116;&#x73;&#111;&#x2e;&#111;&#110;&#x6d;&#105;&#99;&#114;&#x6f;&#115;&#111;&#102;&#116;&#46;&#x63;&#x6f;&#109;">&#x78;&#x78;&#120;&#64;&#x63;&#111;&#110;&#116;&#x73;&#111;&#x2e;&#111;&#110;&#x6d;&#105;&#99;&#114;&#x6f;&#115;&#111;&#102;&#116;&#46;&#x63;&#x6f;&#109;</a> のような Azure AD 上のユーザーも含みます。)</p><p>メールを受信できないアカウントの場合、招待メールを受け取ることができないため、直接リンクを利用して招待に承諾します。<br>以下の URL をゲスト ユーザーに送付し、招待への承諾を依頼ください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://portal.azure.com/&lt;招待先ディレクトリのテナントID&gt;</span><br></pre></td></tr></table></figure><p>メールを利用しない招待については、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/redemption-experience#redemption-through-a-direct-link">B2B コラボレーションの招待の利用 - Azure AD | Microsoft Docs</a> を参照ください。(直接リンクによる利用 の項 に記載があります)</p><h3 id="Q-招待するユーザーのUPN-とMail-属性の値が違います。どちらを利用するべきですか"><a href="#Q-招待するユーザーのUPN-とMail-属性の値が違います。どちらを利用するべきですか" class="headerlink" title="Q. 招待するユーザーのUPN とMail 属性の値が違います。どちらを利用するべきですか?"></a>Q. 招待するユーザーのUPN とMail 属性の値が違います。どちらを利用するべきですか?</h3><p>A.UPN を指定して招待ください。</p><p><a href="#Q-%E6%8B%9B%E5%BE%85%E3%81%97%E3%81%9F%E3%81%84%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%8C%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%92%E5%8F%97%E4%BF%A1%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%A7%E3%81%99%E3%80%82%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%92%E5%8F%97%E4%BF%A1%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%80%81%E3%82%B2%E3%82%B9%E3%83%88-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%A8%E3%81%97%E3%81%A6%E6%8B%9B%E5%BE%85%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93%E3%81%8B">Q. 招待したいユーザーがメールを受信できないアカウントです。</a> の項 の通り、メールを受信できないユーザーであっても招待が可能です。<br>Mail 属性にて招待をした場合も招待に承諾することができ、ゲスト ユーザーとしてアクセスできますが、一部で 正常にサービスが利用できないという過去事例があります。<br>そのため、より安全に機能をご利用いただくためには、UPN を指定し招待ください。</p><h3 id="Q-ゲスト-ユーザー招待時にメールを送信したくありません。メールを送らずに招待する方法はありますか"><a href="#Q-ゲスト-ユーザー招待時にメールを送信したくありません。メールを送らずに招待する方法はありますか" class="headerlink" title="Q. ゲスト ユーザー招待時にメールを送信したくありません。メールを送らずに招待する方法はありますか?"></a>Q. ゲスト ユーザー招待時にメールを送信したくありません。メールを送らずに招待する方法はありますか?</h3><p>A. Azure Portal など 画面からの招待では メールを送らずに招待することが出来ません。<br>メールを送らずに招待をしたい場合、PowerShell コマンドを利用します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># コマンドのインストール</span></span><br><span class="line"><span class="built_in">Install-Module</span> AzureAD</span><br><span class="line"></span><br><span class="line"><span class="comment"># ユーザーで認証</span></span><br><span class="line"><span class="built_in">Connect-AzureAD</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># メールを送らずに招待</span></span><br><span class="line"><span class="built_in">New-AzureADMSInvitation</span> <span class="literal">-InvitedUserEmailAddress</span> &lt;招待するユーザーのUPN(メールアドレス形式)&gt; <span class="literal">-InvitedUserDisplayName</span> &lt;ゲスト ユーザーの表示名&gt; <span class="literal">-InviteRedirectUrl</span> &lt;招待へ承諾後、アクセスするURL&gt;  <span class="literal">-SendInvitationMessage</span> <span class="variable">$false</span></span><br></pre></td></tr></table></figure><h3 id="Q-招待を実施すると、”グループ電子メール-アドレスはサポートされていません”-とエラーになる"><a href="#Q-招待を実施すると、”グループ電子メール-アドレスはサポートされていません”-とエラーになる" class="headerlink" title="Q. 招待を実施すると、”グループ電子メール アドレスはサポートされていません” とエラーになる"></a>Q. 招待を実施すると、”グループ電子メール アドレスはサポートされていません” とエラーになる</h3><p><img src="/blog/azure-active-directory/b2bfaq/image05.png"></p><p>A. 招待時に指定したメールアドレスが 、Microsoft 365 (Azure AD) 上でグループのメールアドレスに指定されています。<br>ゲスト ユーザーとして招待が行えるのは ユーザーアカウントのみとなるため、別途 招待するユーザーにてアカウントを作成する必要があります。</p><blockquote><p>(補足)<br>グループを指定して招待することで、そのグループに所属しているユーザーを一括で招待するといった機能もありません。<br>そのため、必ず ホーム ディレクトリ にてユーザー アカウント として作成されているアカウントを招待します。</p></blockquote><h3 id="Q-ゲスト-ユーザーの招待に有効期限はありますか"><a href="#Q-ゲスト-ユーザーの招待に有効期限はありますか" class="headerlink" title="Q. ゲスト ユーザーの招待に有効期限はありますか?"></a>Q. ゲスト ユーザーの招待に有効期限はありますか?</h3><p>A. Azure Portal や Teams からの招待では 、特に有効期限はありません。<br>ただし、SharePoint Online で招待した場合は既定で 90 日間の有効期限となります。</p><h3 id="Q-ゲスト-ユーザーの-Mail-属性-や-ProxyAddress-属性が空になります。-なぜですか"><a href="#Q-ゲスト-ユーザーの-Mail-属性-や-ProxyAddress-属性が空になります。-なぜですか" class="headerlink" title="Q. ゲスト ユーザーの Mail 属性 や ProxyAddress 属性が空になります。 なぜですか?"></a>Q. ゲスト ユーザーの Mail 属性 や ProxyAddress 属性が空になります。 なぜですか?</h3><p>A. 連絡先 (コンタクト) として登録しているメールアドレスを指定し招待すると、Mail 属性 や ProxyAddress 属性が空 (未設定の状態) になります。<br>Mail 属性 や ProxyAddress 属性が空の場合、ユーザー検索時に メールアドレスで検索できないなどの影響があるため、メールアドレスを基に検索を行いたい場合には対処が必要になります。</p><p>対処としては、連絡先から該当メールアドレスを削除の上、ゲスト ユーザーの再招待を行う必要があります。<br>なお、連絡先の削除手順は それぞれ連絡先を追加した手順によって異なります。</p><h4 id="オンプレミス-Active-Directory-より連絡先-を追加した場合"><a href="#オンプレミス-Active-Directory-より連絡先-を追加した場合" class="headerlink" title="オンプレミス Active Directory より連絡先 を追加した場合"></a>オンプレミス Active Directory より連絡先 を追加した場合</h4><ol><li>オンプレミス Active Directory にて、 [Active Directory ユーザー と コンピューター] を起動します。</li><li>対象の連絡先を右クリックし、”削除 (D)” を実行します。</li></ol><p><img src="/blog/azure-active-directory/b2bfaq/image06.png"></p><h4 id="Microsoft-365-管理センターより連絡先-を追加した場合"><a href="#Microsoft-365-管理センターより連絡先-を追加した場合" class="headerlink" title="Microsoft 365 管理センターより連絡先 を追加した場合"></a>Microsoft 365 管理センターより連絡先 を追加した場合</h4><ol><li>Microsoft 管理センター にて連絡先 (<a href="https://admin.microsoft.com/Adminportal/Home#/Contact">https://admin.microsoft.com/Adminportal/Home#/Contact</a>) にアクセスし、対象の連絡先を検索します。</li><li>メールアドレスをチェックすることで “連絡先を削除” が表示されますので、クリックし連絡先を削除します。</li></ol><p><img src="/blog/azure-active-directory/b2bfaq/image07.png"></p><h2 id="2-招待された側のよくある質問"><a href="#2-招待された側のよくある質問" class="headerlink" title="2.招待された側のよくある質問"></a>2.招待された側のよくある質問</h2><p><img src="/blog/azure-active-directory/b2bfaq/image08.png"></p><h3 id="アクセスができない際の対処"><a href="#アクセスができない際の対処" class="headerlink" title="アクセスができない際の対処"></a>アクセスができない際の対処</h3><h3 id="Q-“ネットワーク管理者によってアクセスがブロックされました-外部アクセスがポリシーによってブロックされています。アクセスするには、IT-部門にお問い合わせください。”-と表示されアクセスできない"><a href="#Q-“ネットワーク管理者によってアクセスがブロックされました-外部アクセスがポリシーによってブロックされています。アクセスするには、IT-部門にお問い合わせください。”-と表示されアクセスできない" class="headerlink" title="Q. “ネットワーク管理者によってアクセスがブロックされました / 外部アクセスがポリシーによってブロックされています。アクセスするには、IT 部門にお問い合わせください。” と表示されアクセスできない"></a>Q. “ネットワーク管理者によってアクセスがブロックされました / 外部アクセスがポリシーによってブロックされています。アクセスするには、IT 部門にお問い合わせください。” と表示されアクセスできない</h3><p><img src="/blog/azure-active-directory/b2bfaq/image09.png"></p><p>A.<br>原因: ゲスト ユーザーが利用してい社内の NW 機器 によって アクセスできる ディレクトリが制限されています。<br>対処: 利用しているネットワークの管理者に依頼の上、NW　機器 にアクセス先のテナント ID を追加します。</p><blockquote><p>補足:<br>このエラーは “テナント 制限” と呼ばれる機能による制限です。<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/manage-apps/tenant-restrictions">テナント制限を使用して SaaS クラウド アプリケーションへのアクセスを管理する</a></p></blockquote><h3 id="Q-“アカウントがブロックされました-お客様のアカウントについて、疑わしいアクティビティが検出されました。”-と表示されアクセスできない"><a href="#Q-“アカウントがブロックされました-お客様のアカウントについて、疑わしいアクティビティが検出されました。”-と表示されアクセスできない" class="headerlink" title="Q. “アカウントがブロックされました / お客様のアカウントについて、疑わしいアクティビティが検出されました。” と表示されアクセスできない"></a>Q. “アカウントがブロックされました / お客様のアカウントについて、疑わしいアクティビティが検出されました。” と表示されアクセスできない</h3><p>“申し訳ございません。アクセスしようとしている組織では危険なユーザーを制限しています。Contoso の管理者にお問い合わせください。” と表示されアクセスできない。</p><p><img src="/blog/azure-active-directory/b2bfaq/image10.png"></p><blockquote><p>補足 :<br>サインインログには以下が記録されます。<br>530032<br>Failure reason : User blocked due to risk on home tenant.</p></blockquote><p>A.<br>原因: ゲスト ユーザーのアカウントにてリスクが検知されています。<br>対処: <a href="https://passwordreset.microsoftonline.com/">https://passwordreset.microsoftonline.com</a> にアクセスし、パスワード リセットを行い リスクをクリアします。</p><p>自身でパスワード リセットができない場合、ホーム ディレクトリ の管理者に依頼し、パスワード リセットかリスクのクリアを依頼します。<br>なお、オンプレミス Active Directory から同期しているユーザーは、パスワード リセットを実施してもリスクがクリアされないため、クラウド側 (Azure AD) の管理者への依頼が必要になります。</p><p>【リスクのクリア手順】<br>Azure Portal (<a href="https://portal.azure.com/">https://portal.azure.com</a>) &gt; [Azure Active Directory] &gt; [セキュリティ] &gt; [危険なユーザー]<br>対象のユーザーにチェックをつけ、”ユーザー リスクを無視する”を実行ください。</p><div class="alert is-important"><p class="alert-title">重要</p><p>本当にリスクを無視していいかの判断は管理者様が実際のユーザーに確認するなど、セキュリティ リスクを考慮の上、ご実施ください。</p></div><p><img src="/blog/azure-active-directory/b2bfaq/image11.png"></p><blockquote><p>補足 : こちらは Azure AD Identity Protection という機能にて制限しています。<br>アクセスをブロックするかはそれぞれのテナント毎の設定になるため、このエラーが表示された場合には招待先ディレクトリ にてブロックの設定がされています。</p></blockquote><p>なお、リスクの検出はそれぞれのホーム ディレクトリで行われます。<br>ホーム ディレクトリで検出されたリスクが、招待先ディレクトリ の Identity Protection で検知される仕組みとなります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/identity-protection/concept-identity-protection-risks">リスクとは Azure AD Identity Protection | Microsoft Docs</a></li></ul><h3 id="Q-“これに対するアクセス権がありません-サインインは完了しましたが、このリソースへのアクセス許可がありません。”-と表示されアクセスできない"><a href="#Q-“これに対するアクセス権がありません-サインインは完了しましたが、このリソースへのアクセス許可がありません。”-と表示されアクセスできない" class="headerlink" title="Q. “これに対するアクセス権がありません / サインインは完了しましたが、このリソースへのアクセス許可がありません。” と表示されアクセスできない"></a>Q. “これに対するアクセス権がありません / サインインは完了しましたが、このリソースへのアクセス許可がありません。” と表示されアクセスできない</h3><p><img src="/blog/azure-active-directory/b2bfaq/image12.png"></p><p>A.<br>原因: “招待先ディレクトリ” での 条件付きアクセスと呼ばれる設定にて、許可されていないアクセスをしています。<br>対処: “招待先ディレクトリ” の管理者 に依頼の上、条件付きアクセスの設定を変更します。 または、適切な条件下でアクセスを行うようにします。</p><blockquote><p>補足 : このエラーの詳細は、<a href="/blog/azure-active-directory/azuread-access-denied/">「アクセス権がありません」のエラーについて | Japan Azure Identity Support Blog</a> を参照ください。</p></blockquote><h3 id="アクセス後に情報が閲覧できない"><a href="#アクセス後に情報が閲覧できない" class="headerlink" title="アクセス後に情報が閲覧できない"></a>アクセス後に情報が閲覧できない</h3><h3 id="Q-“xxxxディレクトリには-Azure-サブスクリプションがありません。ここをクリックして、別のディレクトリに切り替えてください。”-と表示され、Azure-サブスクリプションにアクセスできない"><a href="#Q-“xxxxディレクトリには-Azure-サブスクリプションがありません。ここをクリックして、別のディレクトリに切り替えてください。”-と表示され、Azure-サブスクリプションにアクセスできない" class="headerlink" title="Q. “xxxxディレクトリには Azure サブスクリプションがありません。ここをクリックして、別のディレクトリに切り替えてください。” と表示され、Azure サブスクリプションにアクセスできない"></a>Q. “xxxxディレクトリには Azure サブスクリプションがありません。ここをクリックして、別のディレクトリに切り替えてください。” と表示され、Azure サブスクリプションにアクセスできない</h3><p><img src="/blog/azure-active-directory/b2bfaq/image13.png"></p><p>A.<br>原因: Azure サブスクリプションに対しての閲覧権限がないか、アクセスしている ディレクトリが異なっている可能性があります。<br>対処: Azure サブスクリプションの管理者に依頼し 権限を付与するか、アクセスしている ディレクトリを確認します。</p><p>ディレクトリの変更 は Azure Portal の <code>ディレクトリ + サブスクリプション</code> から行います。</p><p><img src="/blog/azure-active-directory/b2bfaq/image14.png"></p><blockquote><p>補足: このエラーの詳細は、<a href="https://jpazureid.github.io/blog/azure-active-directory/subscription-azuread">サブスクリプションが見えない | Japan Azure Identity Support Blog</a> を参照ください。</p></blockquote><h3 id="Q-“このデータへのアクセス権がありません。”が表示される-と表示され、ユーザー一覧にアクセスできない"><a href="#Q-“このデータへのアクセス権がありません。”が表示される-と表示され、ユーザー一覧にアクセスできない" class="headerlink" title="Q. “このデータへのアクセス権がありません。”が表示される と表示され、ユーザー一覧にアクセスできない"></a>Q. “このデータへのアクセス権がありません。”が表示される と表示され、ユーザー一覧にアクセスできない</h3><p><img src="/blog/azure-active-directory/b2bfaq/image15.png"></p><p>A.<br>原因: 既定では、ゲスト ユーザーは “招待先ディレクトリ” のユーザー情報を閲覧することができません。<br>対処: “招待先ディレクトリ” の管理者によって ゲスト ユーザーへのアクセス権を変更依頼をするか、個別に “ディレクトリ閲覧者” などのロールの付与を依頼します。</p><blockquote><p>補足: 既定でのゲスト ユーザーによる権限については、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/fundamentals/users-default-permissions">既定のユーザー アクセス許可 - Azure Active Directory | Microsoft Docs</a> を参照ください。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。 Azure Identity サポート チームです。&lt;br&gt;こちらのブログでは、Azure における ゲスト ユーザー招待 (B2B) のよくある質問をお纏めいたしました。&lt;/p&gt;
&lt;p&gt;それぞれ 招待をする側 と 招待された側にわけて記載をしておりますので、</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="B2B" scheme="https://jpazureid.github.io/blog/tags/B2B/"/>
    
  </entry>
  
  <entry>
    <title>CAE (Continuous Access Evaluation: 継続的アクセス評価)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/cae-overview/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/cae-overview/</id>
    <published>2021-05-16T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.135Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity チームの金森です。</p><p>みなさんは CAE (Continuous Access Evaluation: 継続的アクセス評価) という機能をご存知でしょうか。<br>2021 年 5 月現在、以下のようなお知らせがあり、目にされた方も多いのではないかと思います。</p><ul><li>Microsoft 365 管理ポータルのメッセージ センターに MC255540 (Continuous access evaluation on by default) として情報が公開</li><li>送信元 : Microsoft Azure <a href="mailto:&#x61;&#x7a;&#x75;&#114;&#x65;&#45;&#x6e;&#111;&#x72;&#x65;&#112;&#108;&#x79;&#64;&#x6d;&#105;&#99;&#x72;&#x6f;&#115;&#111;&#x66;&#x74;&#46;&#x63;&#111;&#x6d;">&#x61;&#x7a;&#x75;&#114;&#x65;&#45;&#x6e;&#111;&#x72;&#x65;&#112;&#108;&#x79;&#64;&#x6d;&#105;&#99;&#x72;&#x6f;&#115;&#111;&#x66;&#x74;&#46;&#x63;&#111;&#x6d;</a> から TRACKING ID: 5T93-LTG として以下の件名のメールでお知らせ<br>-&gt;Continuous access evaluation will be enabled in premium Azure AD tenants beginning on 15 June 2021</li></ul><p>CAE とは、簡単に言いますと <strong>あるサービスを利用しているクライアントの状態が変わった際、ほぼリアルタイムでその変化を検知してアクセス制御を行う</strong> ことができる機能、です！<br>実は以下のような技術情報、Blog にてお伝えしてきた通り、2020 年から機能自体は実装が進んでいました。</p><p><a href="https://jpazureid.github.io/blog/azure-active-directory/moving-towards-real-time-policy-and-security-enforcement/">ポリシーとセキュリティのリアル タイムな適用に向けて</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/fundamentals/resilience-with-continuous-access-evaluation">継続的アクセス評価を使用して回復性を強化する</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価</a></p><p>この CAE 機能が、Azure AD Premium を有効にしているテナントについても 2021 年　6 月 15 日から 9 月 30 日にかけて順次有効になります、というお知らせが MC255540 であり 5T93-LTG の通知となります。</p><h2 id="CAE-とは具体的にどんな機能なの？"><a href="#CAE-とは具体的にどんな機能なの？" class="headerlink" title="CAE とは具体的にどんな機能なの？"></a>CAE とは具体的にどんな機能なの？</h2><p>これまで、条件付きアクセス (CA) によるアクセス制御を行われている環境では [Azure AD (AAD) に対してクライアントがアクセス トークンの新規取得、もしくは取得済みアクセス トークンの更新] を行うタイミングで、CA ポリシーの評価が行われていました。これは、逆に言うと [クライアントの取得済みアクセス トークンの有効期限内であれば、AAD へのアクセスが行われず CA ポリシーの評価もその間は行われない] ことを意味しています。</p><p>通常、あるリソース (Exchange Online や SharePoint Online 等) へクライアントがアクセスするために、AAD が発行しているアクセス トークンの有効期限は既定では 60 分です。つまり、アクセス トークンを取得してから 60 分間は、該当クライアントはリソースに対してアクセスし続けることが可能です。<br>もしその 60 分間に、該当 AAD ユーザー自体が (運用によって適切に) 無効もしくは削除されたり、セキュリティ リスクに伴いパスワードの変更や発行済みトークンの失効が行われたり、アクセスが許可されていない場所にクライアントが移動したりしたとしても、これまでは [アクセス トークンの更新タイミング = 前回取得から約 60 分後] までは、リソースへのアクセスが継続して行えてしまいました。</p><p>ここで、CAE が有効な AAD テナントでは、CAE に対応しているリソースに対して AAD から状態変化の Event がほぼリアルタイム (*) で通知されるようになります。また、CA ポリシーがリソースにも共有され、クライアントのアクセス元 IP アドレスのチェックがリソース側でも行われるようになり、アクセスが許可されていない場所にクライアントが移動した場合の検知がほぼリアルタイム (*) に行えることになります。</p><div class="alert is-info"><p class="alert-title">Note</p><p>(*) クラウド サービス間の処理となるため、数分～十数分程度のバッファはあるものとしてお考えください</p></div><p>CAE が有効に動作した際の、実際の処理フローのシナリオ例は、前述の技術情報 <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価</a> の <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation#example-flows">フローの例</a> をぜひご覧ください。以下にそれぞれのシナリオを解説します。</p><h3 id="ユーザー失効イベントのフロー"><a href="#ユーザー失効イベントのフロー" class="headerlink" title="ユーザー失効イベントのフロー"></a>ユーザー失効イベントのフロー</h3><p>こちらは管理者が意図して、ある AAD ユーザーの更新トークンを失効させた、というシナリオになります。<br>CAE が提供される前では、何らかの理由 (セキュリティ要因に関する理由が主なものでしょう) で更新トークンを失効させても、アクセス トークンが有効な 60 分間は、継続してユーザーはリソース アクセスが可能でした。<br>しかし、管理者としては、更新トークンの失効と併せて一刻も早くアクセス トークンの利用も停止させ、その AAD ユーザーに早く再認証を求めさせたい、と思うのが自然です。<br>再認証を求めることができれば、改めて CA によるアクセス制御が行えるため、CA のアクセス制御を突破した場合のみリソースにアクセスできるようにすることが可能です。</p><p>AAD は、ある AAD ユーザーの更新トークンが失効されると、Events として CAE に対応しているリソース (Exchange Online や SharePoint Online 等) に失効されたことを通知します。<br>この通知を受けたリソース側は、クライアントがまだ期限内のアクセス トークンを保持していても、クライアントからのアクセスを拒否して 401+ 認証チャレンジをクライアントに返します。<br>つまり [手持ちのトークンが期限内かどうかはさておき、クライアントに AAD に更新トークンの妥当性をチェックさせに行く] 応答を返します。<br>ここでクライアントは AAD に向かい、改めて認証が行われて、CA によるアクセス制御の評価を受けることになります。</p><h3 id="ユーザー状態変更のフロー-プレビュー"><a href="#ユーザー状態変更のフロー-プレビュー" class="headerlink" title="ユーザー状態変更のフロー (プレビュー)"></a>ユーザー状態変更のフロー (プレビュー)</h3><p>こちらは、[CA ポリシーで場所 (クライアントの接続元 IP アドレス) によるアクセス制御] を行っている場合に有効なシナリオになります。<br>例えば、CA ポリシーで [信頼された場所 A (送信元 IP アドレス範囲) からのアクセスは許可するが、それ以外の場所からのアクセスはブロックする] というアクセス制御を行っていたとします。<br>信頼された場所 A からアクセスしたクライアントは、もちろんその時点ではリソース (Exchange Online や SharePoint Online 等) に対してアクセスが可能です。</p><p>ここでクライアントが [CA ポリシー上、信頼されていない場所] に移動したとします。<br>前述の通り、これまではクライアントが取得しているアクセス トークン (基本的に 60 分) の更新タイミングが来るまでは、信頼されていない場所からのアクセスも行えていました。<br>しかし、AAD で CAE が有効になっていると、CAE に対応しているリソースへも CA ポリシーが同期され内容を評価できるようになります。<br>つまり、リソース側もクライアントの送信元 IP (場所) の情報を元に、CA ポリシーで許可された送信元 IP アドレスかどうか、をチェックすることができます。</p><p>CA ポリシーで許可されていない送信元 IP アドレスからクライアントがアクセスしてきていると判断したリソース側は、クライアントがまだ期限内のアクセス トークンを保持していても、クライアントからのアクセスを拒否して 401+ 認証チャレンジをクライアントに返します。<br>ここでクライアントは AAD に向かい、改めて認証が行われて、CA によるアクセス制御の評価を受けることになります。</p><p>CAE とは、上記のように [クライアント/ユーザーの変化に応じて、”改めて AAD でのアクセス制御の評価を受けてほしい” 状態になったタイミング] で、今までよりも速やかにアクセス制御 (=AAD への認証に伴う CA ポリシーの評価) を受けることが可能になる機能です。</p><h2 id="CAE-が有効になるとどんな影響があるの？"><a href="#CAE-が有効になるとどんな影響があるの？" class="headerlink" title="CAE が有効になるとどんな影響があるの？"></a>CAE が有効になるとどんな影響があるの？</h2><p>先に記載した通り、今までよりもほぼリアルタイムに、クライアント/ユーザーの状態変化に応じてアクセス トークンの有効期間内であってもユーザーのアクセスの失効がおこなわれた場合に反映させることができたり、 CA ポリシーの評価を受けられるようになります。つまり有効になることで困ることは基本的には無いのですが、注意が必要な点として CAE が有効になりますとアクセス トークンの有効期限が最大 28 時間になります。<br>前述の技術情報 <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価</a> の <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation#token-lifetime">トークンの有効期間</a> をご覧ください。</p><p>最大 28 時間というアクセス トークンの有効期間は長すぎじゃないか？！という印象を持たれるかもしれません。<br>しかし、前述の機能の説明のとおり、セキュリティという観点ではアクセス トークンの有効期間内であっても、クライアント/ユーザーの状態変化に応じて速やかに CA ポリシーの評価を受けることができるようになるので、むしろ向上するとお考えいただければと思います。</p><p>運用面において、 CAE のデメリットとなりうるところとしては、ユーザー アカウントのグループ メンバーシップや条件付きアクセス ポリシーに変更を加えても、その変更が反映されるまでに 1 日 (正確には最大 28 時間) 要することが挙げられます。これは、ユーザーのグループメンバーシップの更新や、ポリシーの更新については、特に CAE による発行済みアクセス トークンの再確認対象にならないためです。<br>技術情報 <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価</a> の <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation#troubleshooting">トラブルシューティング</a> の項目にあります <strong>グループ メンバーシップとポリシー更新が有効になる時間</strong> もご参照ください。</p><p>なお、条件付きアクセスのサインインの頻度の設定は CAE よりも優先されます。仮に CAE が有効になってもサインインの頻度で設定したタイミングで再認証を求めるようにすることができますのでご安心ください。</p><h2 id="CAE-はどのリソースおよびクライアントでも実現できるの？"><a href="#CAE-はどのリソースおよびクライアントでも実現できるの？" class="headerlink" title="CAE はどのリソースおよびクライアントでも実現できるの？"></a>CAE はどのリソースおよびクライアントでも実現できるの？</h2><p>現時点では、リソースとしては Exchange Online と SharePoint Online、アクセス元のクライアントとしてはブラウザと Office アプリが対象になります。<br>なお、Exchange Onine や SharePoint Online が併用されている Teams も対象になります。</p><p>CAE に対応していないリソース、クライアント アプリの場合は、アクセス トークンの考え方はこれまで通りです。</p><h2 id="CAE-は無効にできるの？"><a href="#CAE-は無効にできるの？" class="headerlink" title="CAE は無効にできるの？"></a>CAE は無効にできるの？</h2><p>はい、CAE を無効にすることは、Azure ポータル上の操作にて可能です。<br>前述の技術情報 <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価</a> <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation#enable-or-disable-cae-preview">CAE を有効または無効にする (プレビュー)</a> をご覧ください。</p><p>技術情報にも記載がありますが、既定の設定画面が多少分かりづらいので補足しますと、既定の設定画面は以下のように [<strong>プレビューを無効にする</strong>] が選択された状態が初期値になっています。<br><img src="/blog/azure-active-directory/cae-overview/cae-gui.png"></p><p>[<strong>なんだ、無効じゃないか</strong>] と思ってしまいそうですが、このままの状態で 6 月 15 日以降になると、CAE は有効になってしまいます。<BR><br>とても紛らわしい話で申し訳ないのですが、 CAE を無効にして、6 月 15 日以降に自動的に有効になることを防ぎたい方は、上記の画面で一度 Enable を選択してから、再度 Disable を選択して [保存] をクリックしてください。</p><p>上記内容が CAE の理解に向けて、皆様の参考となりますと幸いです。<br>どちら様も素敵な AAD ライフをお過ごしください！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity チームの金森です。&lt;/p&gt;
&lt;p&gt;みなさんは CAE (Continuous Access Evaluation: 継続的アクセス評価) という機能をご存知でしょうか。&lt;br&gt;2021 年 5 月現在、以下のようなお知らせがあり、目</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Conditional Access" scheme="https://jpazureid.github.io/blog/tags/Conditional-Access/"/>
    
    <category term="Zero Trust" scheme="https://jpazureid.github.io/blog/tags/Zero-Trust/"/>
    
  </entry>
  
  <entry>
    <title>パスワード ライトバックのしくみと一般的なトラブルシューティング</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory-connect/password-writeback-overview/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory-connect/password-writeback-overview/</id>
    <published>2021-05-10T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:32.963Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの金子です。<br>今回はパスワード ライトバックのしくみと一般的なトラブルシューティングについてご紹介します。</p><h2 id="パスワード-ハッシュ同期とパスワード-ライトバックの違いとは"><a href="#パスワード-ハッシュ同期とパスワード-ライトバックの違いとは" class="headerlink" title="パスワード ハッシュ同期とパスワード ライトバックの違いとは"></a>パスワード ハッシュ同期とパスワード ライトバックの違いとは</h2><p>まず、ユーザーは Azure AD Connect により、オンプレミス AD から Azure AD に同期されていることを前提とします。<br>パスワード ハッシュ同期についてはご存じの方が多いと思いますが、パスワード ハッシュ同期はオンプレミスの認証パスワード (厳密にはパスワード ハッシュ) を Azure AD に同期する機能です。これによりユーザーは同じ ID/パスワードで Office 365 などのクラウド上のアプリにもサインインすることができるようになります。<br>オンプレミス側でパスワードを変更した場合も同様にクラウド側へ同期されますが、逆にクラウド側からはオンプレミス側のパスワードをリセットしたり変更することはできません。なぜなら、パスワード ハッシュ同期はオンプレミスの Active Directory Domain Services (AD DS) から Azure AD への一方向の同期しかおこなわないためです。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/1_phs.png"></p><p>そのため、社外で仕事をしておりオンプレミス AD に接続できないような状況で次のような要件が発生する場合はパスワード ライトバックを有効化する必要があります。</p><ul><li><p><strong>ユーザーが Microsoft 365 などのクラウド アプリにサインインする認証パスワードを忘れたため、ユーザー自身で同期ユーザーのパスワードをリセットしたい</strong></p></li><li><p><strong>何らかの要件があり Azure AD の管理者が、同期ユーザーのパスワードを強制的にリセットしたい</strong></p></li><li><p><strong>Azure AD Identity Protection によって同期ユーザーの資格情報の漏洩が疑われた (リスク検知した) 場合に、ユーザー自身でパスワードを変更 (または リセット) したい、Azure AD の管理者がユーザーに代わってパスワードをリセットしたい</strong></p></li></ul><p>上記のようなシナリオでは、パスワード ライトバックを有効にすることで要件を実現できます。<br>SSPR と連動させれば、ユーザーがパスワードを忘れてしまった場合でもユーザー自身がオンプレミス AD のパスワードをリセットできるため、IT 管理者の負荷を軽減することができます。<br>また、Identity Protection によって不正なアクセスなどを検知した場合、ユーザー自身が同期ユーザーのパスワードを変更 (リセット) できる他、管理者は Azure ポータルにサインインできる環境であれば、どこにいてもユーザーのパスワードを強制的にリセットすることができますので、セキュリティ リスクを軽減することにもつながります。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/2_password-writeback.png"></p><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><p>同期ユーザーに対する社外ネットワークからのパスワード変更およびリセットを実現するためには、次の前提条件をすべて満たしている必要があります。</p><ol><li>Azure AD Connect でパスワード ライトバックを有効化していること</li><li>Azure ポータル上でセルフサービス パスワード リセット (SSPR) が有効になっていること（“オンプレミスとの統合”）</li><li>利用するユーザーごとに Azure AD Premium P1 または P2 ライセンス、もしくは Microsoft 365 Business Premium ライセンスを持っていること</li><li>AD DS コネクタ アカウントに下記のアクセス許可があること<ul><li>パスワードのリセット</li><li>lockoutTime に対する書き込みアクセス許可</li><li>pwdLastSet に対する書き込みアクセス許可</li><li>まだ設定していない場合は、そのフォレスト内の “各ドメイン” のルート オブジェクトに対する “期限切れではないパスワード” の拡張権利があること</li></ul></li><li>Azure AD Connect サーバーから下記の外部 URL へ HTTPS で接続できること<pre><code> *.passwordreset.microsoftonline.com *.servicebus.windows.net</code></pre></li></ol><h2 id="パスワード-ライトバックのしくみ"><a href="#パスワード-ライトバックのしくみ" class="headerlink" title="パスワード ライトバックのしくみ"></a>パスワード ライトバックのしくみ</h2><p>ではパスワード ライトバックが実際にどのようなしくみで動作しているかを説明します。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/3_password-writeback-detail.png"></p><p>まず、ユーザーが Azure AD のアカウントでパスワード変更 (SSPR)  要求をおこないますと、設定したパスワードが暗号化され、テナント固有の Service Bus へ送られます。<br>Service Bus に保留中のリセット要求が届くと、パスワード リセット エンドポイントがオープンし、Azure AD Connect サーバーの Password Reset Service が処理を開始 (PasswordResetRequestStart) し Azure AD 側から暗号化されたパスワードを取得します。<br>これはオンプレミス側からクラウド側への Outbound (HTTPS / 443) の通信でおこなわれますので、クラウド側からオンプレミス側への Inbound の通信（ポート）を開放する必要はありません。</p><p>Password Reset Service がパスワードを取得しますと、秘密鍵で複合化し、Azure AD Connect はリセット要求のあったユーザーをデータべ―ス内から探し出し、AD Sync サービスが適切な AD DS に対してパスワード リセットを要求します。この時、実際のパスワードリセットは Azure AD Connect で設定したオンプレミス AD 上の AD DS コネクタ アカウント (既定では MSOL_xxxxx) がおこないます。</p><p>そして、パスワード リセット (変更) が成功しますと、Password Reset Service は成功 (PasswordResetSuccess) を Azure AD 側に通知します。<br>この通知を受け取るとパスワード変更 (SSPR)  が完了します。</p><p>このパスワード ライトバックの一連の処理はログ上では次のように記録されます。</p><h3 id="●-Azure-AD-Connect-サーバーのアプリケーション-イベントログ"><a href="#●-Azure-AD-Connect-サーバーのアプリケーション-イベントログ" class="headerlink" title="● Azure AD Connect サーバーのアプリケーション イベントログ"></a>● Azure AD Connect サーバーのアプリケーション イベントログ</h3><p><strong>PasswordResetService</strong><br>Event ID: 31001<br>PasswordResetRequestStart, Details: <a href="mailto:&#117;&#115;&#x65;&#x72;&#49;&#x40;&#99;&#x6f;&#x6e;&#x74;&#111;&#x73;&#x6f;&#46;&#99;&#111;&#109;">&#117;&#115;&#x65;&#x72;&#49;&#x40;&#99;&#x6f;&#x6e;&#x74;&#111;&#x73;&#x6f;&#46;&#99;&#111;&#109;</a></p><p><strong>ADSync</strong><br>Event ID: 405<br>Call sync ldap_bind for DomainName=CONTOSO.COM, UserName=MSOL_xxxxxxxxx.</p><p><strong>ADSync</strong><br>Event ID: 403<br>ImpersonationHelper call LogonUser for DomainName=CONTOSO.COM, UserName=MSOL_xxxxxxxxx.</p><p><strong>ADSync</strong><br>Event ID: 405<br>Call sync ldap_bind for DomainName=CONTOSO.COM, UserName=MSOL_xxxxxxxxx.</p><p><strong>PasswordResetService</strong><br>Event ID: 31002<br>TrackingId: xxxxxxxxx-xxxx-xxxxxxxxx-xxxxxxxxx, PasswordResetSuccess, Details: Context: cloudAnchor: User_xxxxxxxxx-xxxxxxxxx, SourceAnchorValue: xxxxxxxxxxxxxxxxxx, UserPrincipalName: <a href="mailto:&#117;&#115;&#x65;&#114;&#x31;&#64;&#99;&#111;&#110;&#116;&#111;&#x73;&#111;&#46;&#99;&#x6f;&#109;">&#117;&#115;&#x65;&#114;&#x31;&#64;&#99;&#111;&#110;&#116;&#111;&#x73;&#111;&#46;&#99;&#x6f;&#109;</a>, unblockUser: True</p><h3 id="●-Azure-AD-の監査ログ"><a href="#●-Azure-AD-の監査ログ" class="headerlink" title="● Azure AD の監査ログ"></a>● Azure AD の監査ログ</h3><p><strong>Self-service password reset flow activity progress</strong><br>User submitted a new password</p><p><strong>Reset user password</strong></p><p><strong>Update StsRefreshTokenValidFrom Timestamp</strong></p><p><strong>Reset password (self-service)</strong><br>Successfully completed reset.</p><p><strong>Self-service password reset flow activity progress</strong><br>User successfully reset password</p><p>また、パスワード ハッシュ同期を有効化している場合は、パスワード ライトバック後に下記のログが記録されます。<br>これは Password Reset Service とは別のパスワード ハッシュ同期処理のプロセスが動作しているためで、オンプレミス AD 側で変更されたパスワードは通常のパスワード ハッシュ同期のタイミング ( 2 分に一度) で Azure AD 側へ同期されます。<br>これはパスワード ハッシュ同期の既定の動作とご理解ください。</p><h3 id="●-Azure-AD-Connect-サーバーのアプリケーション-イベントログ-1"><a href="#●-Azure-AD-Connect-サーバーのアプリケーション-イベントログ-1" class="headerlink" title="● Azure AD Connect サーバーのアプリケーション イベントログ"></a>● Azure AD Connect サーバーのアプリケーション イベントログ</h3><p><strong>Directory Synchronization</strong><br>Event ID: 657<br>Password Change Result</p><h3 id="●-Azure-AD-の監査ログ-1"><a href="#●-Azure-AD-の監査ログ-1" class="headerlink" title="● Azure AD の監査ログ"></a>● Azure AD の監査ログ</h3><p><strong>Change user password</strong></p><p>(補足）<br>パスワード ライトバックを利用する上で、パスワード ハッシュ同期の有効化は必須ではありません。<br>パスワード ライトバックはパスワード ハッシュ同期による認証だけではなく、パススルー認証や AD FS の環境でもサポートされています。よって、認証方法によらず、同期ユーザーは Azure AD 側からもパスワード変更 (SSPR) をおこなうことができます。</p><h2 id="トラブルシューティング"><a href="#トラブルシューティング" class="headerlink" title="トラブルシューティング"></a>トラブルシューティング</h2><p>パスワード ライトバックが失敗するシナリオはいくつか考えられます。<br>ここでは一般的なエラー要因とその対処方法についてご紹介します。</p><ol><li>変更したパスワードが オンプレミス AD のパスワード ポリシーを満たしていない (Event ID 33008)</li><li>“password” や “baseball” といった推測されやすい用語が含まれているため Azure AD 側で変更が拒否された</li><li>パスワード ライトバックに必要なアクセス許可が付与されていない (Event ID 33004)</li><li>ADSync サービスがダウンしていた (Event ID 31034)</li><li>オンプレミス AD 側でユーザーが見つからない (Event ID 33002)</li><li>オンプレミス AD の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした (Event ID 33004)</li><li>Azure AD Connect 構成ウィザードでパスワード ライトバックを有効化できない</li></ol><h4 id="1-変更したパスワードが-オンプレミス-AD-のパスワード-ポリシーを満たしていない-Event-ID-33008"><a href="#1-変更したパスワードが-オンプレミス-AD-のパスワード-ポリシーを満たしていない-Event-ID-33008" class="headerlink" title="1. 変更したパスワードが オンプレミス AD のパスワード ポリシーを満たしていない (Event ID 33008)"></a>1. 変更したパスワードが オンプレミス AD のパスワード ポリシーを満たしていない (Event ID 33008)</h4><p>[エラー内容]<br>Azure AD Connect のイベントログには Event ID 33008 のエラーが記録されます。<br>エラー メッセージ：<strong>A restriction prevents the password from being changed to the current one specified.</strong></p><p>[原因と対処方法]<br>パスワードライトバックを利用して同期ユーザーのパスワードリセット (変更) を行った場合、オンプレミス AD のパスワードポリシーおよび Azure AD のパスワードポリシー双方が評価されます。<br>オンプレミス AD のパスワード ポリシー (文字数や変更禁止期間など) やアカウントのパスワード変更禁止設定など、パスワード ポリシーを満たしていない場合、パスワード変更は下記のエラーが返されます。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/4_error.png"></p><p>この場合はオンプレミス AD のパスワード ポリシーで決められた範囲でパスワードを変更する必要があります。<br>「グループ ポリシー管理エディター」にて「パスワード ポリシーの設定」をご確認ください。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/5_gpo.png"></p><h4 id="2-“password”-や-“baseball”-といった推測されやすい用語が含まれているため-Azure-AD-側で変更が拒否された"><a href="#2-“password”-や-“baseball”-といった推測されやすい用語が含まれているため-Azure-AD-側で変更が拒否された" class="headerlink" title="2. “password” や “baseball” といった推測されやすい用語が含まれているため Azure AD 側で変更が拒否された"></a>2. “password” や “baseball” といった推測されやすい用語が含まれているため Azure AD 側で変更が拒否された</h4><p>[エラー内容]<br>上述の通り、パスワードライトバックを利用して同期ユーザーのパスワード変更 (リセット) を実施した場合、オンプレミス AD のパスワードポリシーに加えて、Azure AD のパスワードポリシーも評価されます。<br>もし パスワード リセットで設定したパスワードが Azure AD 側の禁止文字に該当する場合は、変更が拒否されます。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/6_error2.png"></p><p>[原因と対処方法]<br>Azure AD 側ではパスワードの文字列に対して以下の両方のチェックがおこなわれます。このチェックはオンプレミス AD にパスワード リセットを要求する前に Azure AD によって内部的に実行されます。</p><ul><li>グローバル禁止パスワード</li><li>カスタム禁止パスワード</li></ul><p>グローバル禁止パスワードは、 Azure AD がグローバルで禁止しているパスワード リストです。<br>セキュリティ上このリストは公開されていませんが、 “password” や “baseball” といった推測されやすい用語が含まれている場合が該当します。</p><p>カスタム禁止パスワードは、管理者が設定できる禁止パスワードです。<br>これらの禁止パスワードを利用しないようにパスワード変更 (リセット) を行うことが対処策となります。</p><h4 id="3-パスワード-ライトバックに必要なアクセス許可が付与されていない-Event-ID-33004"><a href="#3-パスワード-ライトバックに必要なアクセス許可が付与されていない-Event-ID-33004" class="headerlink" title="3. パスワード ライトバックに必要なアクセス許可が付与されていない (Event ID 33004)"></a>3. パスワード ライトバックに必要なアクセス許可が付与されていない (Event ID 33004)</h4><p>[エラー内容]<br>前述の「前提条件 (4)」 に記載したパスワード ライトバックに必要なアクセス許可が対象のユーザーや OU に付与されていない場合はエラーが返されます。</p><p>Azure AD Connect のイベントログに Event ID 33004 のエラーが記録されます。<br>エラー メッセージ：<strong>Requesting user was denied access to perform the operation on a privileged account.</strong></p><p>[原因と対処方法]<br>パスワード変更をおこなう AD DS コネクタ アカウントには以下の 2 つがあり、ご自身の環境がどちらのアカウントを使用しているかを確認します。</p><p>a. Azure AD Connect のインストール時に新規で作成されたアカウント (既定では MSOL_xxxxx)<br>b. オンプレミス AD 上に作成した既存のアカウント</p><p>a のアカウントは自動でルート ディレクトリに対して必要なアクセス許可が付与されますので、配下の OU やユーザーにもアクセス許可が継承されます。そのため、通常はパスワード変更の権限も付与されています。</p><p>b のアカウントはアクセス許可を手動で割り当てる必要があります。もしアクセス許可を付与していない場合は、下記に記載された PowerShell コマンドレットで権限を付与してください。</p><p>パスワード ライトバックのアクセス許可<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-configure-ad-ds-connector-account#permissions-for-password-writeback">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-configure-ad-ds-connector-account#permissions-for-password-writeback</a></p><h4 id="4-ADSync-サービスがダウンしていた-Event-ID-31034"><a href="#4-ADSync-サービスがダウンしていた-Event-ID-31034" class="headerlink" title="4. ADSync サービスがダウンしていた (Event ID 31034)"></a>4. ADSync サービスがダウンしていた (Event ID 31034)</h4><p>[エラー内容]<br>Azure AD Connect のイベントログには Event ID 31034 のエラーが記録されます。<br>エラー メッセージ：<strong>The connection to the connect service was lost.</strong></p><p>[原因と対処方法]<br>ADSync サービスがダウンしている場合はパスワード リセットが失敗します。<br>Azure AD Connect サーバーの ADSync サービスを再起動してください。</p><h4 id="5-オンプレミス-AD-側でユーザーが見つからない-Event-ID-33002"><a href="#5-オンプレミス-AD-側でユーザーが見つからない-Event-ID-33002" class="headerlink" title="5. オンプレミス AD 側でユーザーが見つからない (Event ID 33002)"></a>5. オンプレミス AD 側でユーザーが見つからない (Event ID 33002)</h4><p>[エラー内容]<br>Azure AD Connect のイベントログには Event ID 33002 のエラーが記録されます。<br>エラー メッセージ：<strong>The operation failed because the object could not be found.</strong></p><p>[原因と対処方法]<br>オンプレミス AD 側でユーザーが見つからない場合はパスワード リセットが失敗します。<br>オンプレミス AD にユーザーが存在することを確認してください。</p><h4 id="6-オンプレミス-AD-の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした-Event-ID-33004"><a href="#6-オンプレミス-AD-の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした-Event-ID-33004" class="headerlink" title="6. オンプレミス AD の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした (Event ID 33004)"></a>6. オンプレミス AD の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした (Event ID 33004)</h4><p>[エラー内容]<br>Azure AD Connect のイベントログには Event ID 33004 のエラーが記録されます。<br>エラー メッセージ：<strong>The password could not be updated because the management agent credentials were denied access.</strong></p><p>●エラーになる操作<br>サインイン時に「パスワードを忘れた場合」をクリックします。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/7_forget-password.png"></p><p>SSPR の画面に遷移します。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/8_sspr.png"></p><p>パスワード リセットはエラーになります。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/9_sspr-error.png"></p><p>[原因と対処方法]<br>対象のユーザー アカウントが Active Directory の保護されたグループ (例えば Enterprise Admins や Domain Admins ) に所属していることが考えられます。</p><p>オンプレミス AD の保護されたグループに所属しているメンバーは、パスワード リセット (パスワードを忘れた場合のリセット) はできません。<br>オンプレミス AD の保護されたグループに所属しているメンバーは、以下のいずれかの方法でパスワードの変更・リセットを行う必要があります。</p><ul><li>オンプレミス AD でパスワード変更をまたはパスワードリセットを行う</li><li>Azure にサインイン後自らパスワード “変更” を行う</li><li>Azure のセルフサービス パスワードリセット (SSPR) を利用し自らパスワード “リセット” を行う</li></ul><p>Active Directory の保護されたグループ (いわゆる管理者グループ) に所属すると、そのユーザー アカウントの adminCount 属性に “1” が自動で設定されます。<br>この属性が 1 に設定されたアカウントに対してはドメイン コントローラーにおける SDProp と呼ばれるプロセスにより 1 時間に 1 回、AdminSDHolder オブジェクトに設定されているアクセス許可で上書きされます。そのため、AD ユーザーに対してパスワード リセットを実行している “AD DS コネクタ アカウント” のリセット権限が失われ、結果として Azure AD Connect のパスワード リセットが失敗します。</p><p>本エラーの対処方法としては、そのようなアカウントについては Azure AD でのパスワード リセットの機能を利用しないようにする、または Active Directory の保護されたグループ メンバーから外す (対処策 1) か、 AdminSDHolder に対して Azure AD Connect を動作させているアカウントに権限を付与します (対処策 2)。</p><p><strong>対処策 1. Active Directory の保護されたグループ メンバーから外す場合</strong></p><p>パスワード ライドバックを実行したいユーザーを保護されたグループのメンバーから外します。そのうえで [Active Directoty ユーザーとコンピューター] の プロパティ内の [属性エディター] タブにて、adminCount の 1 の値を手動でクリアします。<br>保護されたグループのメンバーから外しても adminCount の値、ならびに権限の継承設定は自動で元に戻りません。そのため、過去に Domain Admins 等の保護されたグループに所属しており、現在は所属していないアカウントについても本事象が発生することがあります。<br>このようなケースでは対象アカウントに対して adminCount 値をクリアし、権限の継承を有効化することで対処可能です。</p><p>[属性エディター] にて adminCount 値をクリアします。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/10_property.png"></p><p>そして、[セキュリティ] タブの [詳細設定] にて、「継承の有効化」をおこなってください。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/11_inheritance.png"></p><p>継承が有効化されますと、ルート ディレクトリのアクセス許可が継承されますので、 “AD DS コネクタ アカウント” に対してパスワード リセットのアクセス許可が付与されます。</p><p><img src="/blog/azure-active-directory-connect/password-writeback-overview/12_check.png"></p><p><strong>対処策 2. 今後も Active Directory の保護されたグループ メンバーに所属させる場合</strong></p><p>Active Directory の保護されたグループ メンバーに所属させ続けなければならない場合は後述の手順を実施することで Azure AD からのパスワードの変更は可能です。<br>しかしながら、保護されたグループ メンバーに所属するユーザーを Azure 管理ポータル上などでユーザー以外の管理者がリセットさせることはできません。<br>保護されたグループ メンバーに所属するユーザーは adminCount の値が “1” となりますが、 Azure AD からオンプレミス Active Directory 上の保護されたグループ メンバーに所属するユーザーをリセットしようとした際に adminCount の値がチェックされ、 adminCount の値が 1 の場合にはユーザー以外のパスワード リセットを許容しません。ユーザー本人によるパスワード リセットについては adminCount が “1” であってもパスワード リセットは可能です。ユーザー本人によるパスワード リセットを行いたい場合には、後述のアクセス許可を付与ください。</p><ul><li><p>保護されたグループ メンバーに対して、パスワード変更を行う場合の設定手順</p><p> この場合は、AdminSDHolder にパスワード ライトバックに必要なアクセス許可を付与します。ドメインの構成を変更する作業となりますため、事前に検証環境などで動作をお試しいただいてから運用環境で設定されることをお勧めいたします。<br> なお、 MSOL からはじまるアカウント名の場合、 Azure AD Connect が自動で必要な権限は付与しているため通常であれば作業は不要です。権限が付与されていない場合に設定ください。</p></li></ul><p>手順 :</p><ol><li>Azure AD Connect サーバーにて Synchronization Service Manager を起動します。</li><li>画面上部の [Connectors] を選択し、表示された Connector 一覧より、オンプレミス AD フォレスト名のコネクタを選択して画面右の Actions メニューより [Properties] を選択します。</li><li>プロパティ画面が表示するので [Connect to Active Directory Forest] メニューを選択します。</li><li>画面右に表示されたアカウントが、AD フォレストに対して同期処理時にアクセスしているアカウントとなりますので、アカウント名を控えます。</li><li>任意の ドメイン コントローラー に、ドメイン管理者でサインインし、[ADSI エディタ] を開きます。</li><li>左ペイン上で [ADSI エディタ] を選択し、右クリック – [接続] と選択し、「既定の名前付けコンテキスト」が選択された状態で [OK] を選択します。</li><li>左ペインでドメイン名配下の [CN=System] - [CN=AdminSDHolder] と展開し、 AdminSDHolder を右クリックしてプロパティを表示します。</li><li>[セキュリティ] タブより [詳細設定] ボタンをクリックし、[アクセス許可] タブ内の [追加] ボタンをクリックします。</li><li>アクセス許可エントリ画面にて上部の [プリンシパルの選択] リンクをクリックし、前の手順で確認した「AD フォレストに対して同期処理時にアクセスしているアカウント」を追加します。</li><li>画面下部のアクセス許可の一覧最下部にある [すべてクリア] ボタンをクリックします。</li><li>適用先が「このオブジェクトのみ」となっていることを確認した上で [すべてのプロパティの読み取り] および [すべてのプロパティの書き込み] にチェックを入れて保存します。</li><li>[OK] ボタンを複数回クリックし、設定を終了します。</li><li>既定では 1 時間以内に、自動で adminCount 属性が 1 となっているユーザーのアクセス許可が上記で設定したアクセス許可と同じとなります。</li></ol><ul><li>保護されたグループ メンバーに対して、ユーザー自身がパスワード リセットを行う場合の設定手順<br>「保護されたグループ メンバーに対して、パスワード変更を行う場合の設定手順」を実施し、その後更に以下の手順でパスワード リセット権限を付与します。</li></ul><ol start="14"><li><p>ドメイン コントローラーにドメイン管理者権限を持つユーザーでサインインし、コマンド プロンプトを起動します。</p></li><li><p>以下のコマンドを実行します。<br>dsacls “cn=adminsdholder,cn=system,dc=&lt;ドメイン名&gt; “ /G “&lt;ドメイン名&gt;&lt;AD DS コネクタ アカウントの sAMAccountName&gt;:CA;Reset Password”</p></li><li><p>実行後、既定では 1 時間以内に、自動で adminCount 属性が 1 となっているユーザーのアクセス許可に手順 15. で付与した権限が追加されます。</p></li></ol><h4 id="7-Azure-AD-Connect-構成ウィザードでパスワード-ライトバックを有効化できない"><a href="#7-Azure-AD-Connect-構成ウィザードでパスワード-ライトバックを有効化できない" class="headerlink" title="7. Azure AD Connect 構成ウィザードでパスワード ライトバックを有効化できない"></a>7. Azure AD Connect 構成ウィザードでパスワード ライトバックを有効化できない</h4><p>[エラー内容]<br>構成ウィザードでパスワード ライトバックの構成中に下記のエラー メッセージが表示される場合があります。</p><p>エラーメッセージ：<br><strong>パスワードの書き戻しを構成できません。 必要なライセンスを持っていることを確認します。</strong><br>Unable to configure password writeback. Ensure you have the required license and consult the event log for addition information.</p><p>[原因と対処方法]<br>このエラーメッセージは「前提条件の (5) 」のエンドポイントに接続できない場合に発生します。<br>オンプレミスでプロキシ サーバーをご利用されている場合に、Azure AD Connect が machine.config のプロキシ設定を正しく読み込めていないため、外部エンドポイントへの通信がプロキシを経由できず、オンプレミスのファイアウォール等でブロックされている可能性があります。</p><p>外部エンドポイントへの接続がプロキシを経由できていない場合は、machine.config にプロキシの設定を追加した後、一度 Azure AD Connect サーバーを再起動してください。<br>その後、構成ウィザードでパスワード ライトバックを有効にしますと、オンプレミスのファイアウォール等でブロックされることなくエンドポイントへ接続できるようになりエラーが解消されます。</p><p>もし何かエラーが生じて原因がわからないなどお困り事がありましたら、お気軽にテクニカル サポートへお問い合わせください。<br>上記の情報が少しでも皆様のお役に立ちましたら幸いです。</p><h3 id="参考文献やリンクなど"><a href="#参考文献やリンクなど" class="headerlink" title="参考文献やリンクなど"></a>参考文献やリンクなど</h3><p>前提条件<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#prerequisites">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#prerequisites</a></p><p>Azure AD Connect に使用されるアカウント<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/reference-connect-accounts-permissions#accounts-used-for-azure-ad-connect">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/reference-connect-accounts-permissions#accounts-used-for-azure-ad-connect</a></p><p>Azure AD Connect に対するアカウントのアクセス許可を構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#configure-account-permissions-for-azure-ad-connect">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#configure-account-permissions-for-azure-ad-connect</a></p><p>Confirm network connectivity<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/troubleshoot-sspr-writeback#confirm-network-connectivity">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/troubleshoot-sspr-writeback#confirm-network-connectivity</a></p><p>エディションと機能の比較<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-licensing#compare-editions-and-features">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-licensing#compare-editions-and-features</a></p><p>パスワード ライトバックのしくみ<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-writeback#how-password-writeback-works">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-writeback#how-password-writeback-works</a></p><p>Password writeback event log error codes<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/troubleshoot-sspr-writeback#password-writeback-event-log-error-codes">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/troubleshoot-sspr-writeback#password-writeback-event-log-error-codes</a></p><p>カスタムの禁止パスワードを構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-configure-custom-password-protection#configure-custom-banned-passwords">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-configure-custom-password-protection#configure-custom-banned-passwords</a></p><p>パスワード ライトバックのアクセス許可<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-configure-ad-ds-connector-account#permissions-for-password-writeback">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-configure-ad-ds-connector-account#permissions-for-password-writeback</a></p><p>付録 c: 保護されたアカウントと Active Directory のグループ<br><a href="https://docs.microsoft.com/ja-jp/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory">https://docs.microsoft.com/ja-jp/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory</a></p><p>Azure AD Connect ウィザードを実行すると、エラーが発生する: パスワードの書き戻しを構成できません<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/active-directory/unable-configure-pwd-writeback-error">https://docs.microsoft.com/ja-jp/troubleshoot/azure/active-directory/unable-configure-pwd-writeback-error</a></p><p>パスワードの書き戻し (FAQ)<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/active-directory-passwords-faq#password-writeback">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/active-directory-passwords-faq#password-writeback</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの金子です。&lt;br&gt;今回はパスワード ライトバックのしくみと一般的なトラブルシューティングについてご紹介します。&lt;/p&gt;
&lt;h2 id=&quot;パスワード-ハッシュ同期とパスワード-ライトバックの違いとは&quot;&gt;&lt;</summary>
      
    
    
    
    
    <category term="Azure AD Connect" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-Connect/"/>
    
    <category term="Password Writeback" scheme="https://jpazureid.github.io/blog/tags/Password-Writeback/"/>
    
    <category term="Self Service Password Reset" scheme="https://jpazureid.github.io/blog/tags/Self-Service-Password-Reset/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD Connect における TLS 1.2 の対応について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory-connect/azure-ad-connect-tls/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory-connect/azure-ad-connect-tls/</id>
    <published>2021-04-23T01:00:00.000Z</published>
    <updated>2021-07-01T00:10:32.911Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。 Azure Identity サポート チームです。</p><p>こちらのブログでは、MC246440 にて案内している Azure AD における TLS 1.0 および TLS 1.1 の無効化における Azure AD Connect の対応ついてご案内いたします。</p><h2 id="MC246440-の詳細"><a href="#MC246440-の詳細" class="headerlink" title="MC246440 の詳細"></a>MC246440 の詳細</h2><p>この度、2021 年 6 月 30 日をもって TLS 1.0 /1.1 , 3DES 暗号スイート (TLS_RSA_WITH_3DES_EDE_CBC_SHA)  のプロトコルおよび暗号のサポートが終了いたします。<br>それに伴い Azure AD にて 上記プロトコルが無効化されますので、Azure AD Connect でも TLS 1.2 への対応が必要となります。</p><div class="alert is-important"><p class="alert-title">重要</p><p>上記の通り、2021 年 6 月 30 日に TLS 1.0 および TLS 1.1 の無効化を計画しておりましたが、お客様の対応状況を考慮し 無効化を2022 年 1 月 31 日に延期いたしました。</p><p>延期はしておりますが、早急に TLS 1.2 への対応のご準備をよろしくお願いいたします。</p><p>なお、延期については MC258228 として通知されております。</p><p>また、実施いただく対応としては、後述の内容と同一でございます。</p></div><h2 id="TLS-1-2への対応"><a href="#TLS-1-2への対応" class="headerlink" title="TLS 1.2への対応"></a>TLS 1.2への対応</h2><p>主な対応は以下の 3 点です。</p><ol><li>Azure AD Connect を TLS 1.2 に対応している バージョン (1.4.38.0 以降) にバージョンアップを行う。</li><li>Windows Server (OS レベル) で TLS 1.2 が無効化されていないことを確認する。</li><li>パススルー認証エージェントが 1.5.389.0 以上であることを確認する。</li></ol><p>なお、こちらは TLS 1.2 が既定で有効になっている Windows Server 2012 以降をご利用いただいている前提でのご説明となります。<br>古いバージョンの Windows Server をご利用いただいている場合には、別途 TLS 1.2 を有効にする手順が必要となります。</p><p>それぞれ、以下に詳細を記載いたします。</p><h3 id="1-Azure-AD-Connect-を-TLS-1-2-に対応している-バージョン-1-4-38-0-以降-にバージョンアップを行う。"><a href="#1-Azure-AD-Connect-を-TLS-1-2-に対応している-バージョン-1-4-38-0-以降-にバージョンアップを行う。" class="headerlink" title="1. Azure AD Connect を TLS 1.2 に対応している バージョン (1.4.38.0 以降) にバージョンアップを行う。"></a>1. Azure AD Connect を TLS 1.2 に対応している バージョン (1.4.38.0 以降) にバージョンアップを行う。</h3><p>古い Azure AD Connect を利用している場合には OS の設定に関わらず、TLS 1.0 もしくは TLS1.1 が利用される場合があります。<br>そのため、安全に Azure AD Connect を利用するためには、バージョンアップをご検討ください。<br>バージョンアップの手順については、以下の公開情報やブログに詳細をおまとめしておりますので、こちらをご参照ください。</p><ul><li>Title:Azure AD Connect:旧バージョンから最新バージョンにアップグレードする<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-upgrade-previous-version">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-upgrade-previous-version</a></li><li>Title:Azure AD Connect アップグレード手順詳細<br><a href="https://jpazureid.github.io/blog/azure-active-directory-connect/how-to-upgrade-details/">https://jpazureid.github.io/blog/azure-active-directory-connect/how-to-upgrade-details/</a></li></ul><p>なお、バージョンは以下の手順にて確認することが可能です。</p><p>コマンドでの確認:</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">wmic product list &gt; <span class="variable">%userprofile%</span>\desktop\product.txt</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory-connect/azure-ad-connect-tls/image01.png"></p><p>画面での確認:</p><p>[コントロールパネル] - [プログラム] - [プログラムと機能] で ”Microsoft Azure AD Connect” のバージョンを確認します。</p><p><img src="/blog/azure-active-directory-connect/azure-ad-connect-tls/image02.png"></p><h3 id="2-Windows-Server-（OS-レベル）で-TLS-1-2-が無効化されていないことを確認する。"><a href="#2-Windows-Server-（OS-レベル）で-TLS-1-2-が無効化されていないことを確認する。" class="headerlink" title="2. Windows Server （OS レベル）で TLS 1.2 が無効化されていないことを確認する。"></a>2. Windows Server （OS レベル）で TLS 1.2 が無効化されていないことを確認する。</h3><p>Azure AD Connect が新しいバージョンであっても、OS にて TLS 1.2 が無効化されていれば、Azure AD Connect は TLS 1.0 /1.1 を利用する可能性があります。</p><p>TLS 1.2 が無効化されていないことは 以下のレジストリで確認が可能です。</p><p>レジストリ: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\Schannel\Protocols</p><p>以下のように Protocols 配下に TLS 1.2 に関する設定がなければ 、既定通り TLS 1.2 が有効であるため 、対応は不要です。</p><p><img src="/blog/azure-active-directory-connect/azure-ad-connect-tls/image03.png"></p><p>一方、以下のように TLS 1.2 のキーが存在し、かつ Enabled の値が 0 (無効) である場合には、OS レベルで TLS 1.2 が無効化されています。<br>キーを削除するか Enabled を 1 (有効) にする必要があります。</p><p>レジストリ:HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client<br><img src="/blog/azure-active-directory-connect/azure-ad-connect-tls/image04.png"></p><p>もしくは<br>レジストリ:HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server<br><img src="/blog/azure-active-directory-connect/azure-ad-connect-tls/image06.png"></p><h3 id="3-パススルー認証エージェントが-1-5-389-0-以上であることを確認する。"><a href="#3-パススルー認証エージェントが-1-5-389-0-以上であることを確認する。" class="headerlink" title="3. パススルー認証エージェントが 1.5.389.0 以上であることを確認する。"></a>3. パススルー認証エージェントが 1.5.389.0 以上であることを確認する。</h3><p>Azure AD Connect でサインイン方式としてパススルー認証が選択されており、Azure AD Connect サーバー以外にパススルー認証エージェントを別途インストールされている場合は、1.5.389.0 以降のエージェントがインストールされていることを確認ください。</p><p>[コントロールパネル] - [プログラム] - [プログラムと機能] で ”Microsoft Azure AD Connect Authentication Agent” のバージョンを確認します。</p><p><img src="/blog/azure-active-directory-connect/azure-ad-connect-tls/image05.png"></p><p>古い場合は、Azure ポータルにサインインし、[Azure Active Directory] - [Azure AD Connect] - [パススルー認証] - [ダウンロード] より最新のエージェントをダウンロードし、インストールします。</p><h2 id="よくあるご質問"><a href="#よくあるご質問" class="headerlink" title="よくあるご質問"></a>よくあるご質問</h2><h3 id="Q-バージョンアップをしなかった場合の影響について教えてください。"><a href="#Q-バージョンアップをしなかった場合の影響について教えてください。" class="headerlink" title="Q. バージョンアップをしなかった場合の影響について教えてください。"></a>Q. バージョンアップをしなかった場合の影響について教えてください。</h3><p>A. 恐縮ながら、ご利用の各バージョンにおける 影響についてはご案内することができません。2021 年 6 月 30 日以降 は Azure AD Connect  1.4.38.0 以降のバージョンであればご利用いただけることを確認しております。古いバージョンの Azure AD Connect を 6 月 30 日以降もご利用の場合に何らかの事象が発生した場合も、サポート チケットを発行いただくことは可能です。ただし調査の結果、発生している事象が古いバージョンに起因している可能性が考えられる場合は、最新版へのアップデートや、ご利用の環境での最新版を用いた動作確認をご案内させていただく点にご留意ください。</p><h3 id="Q-TLS-1-0-1-1-を無効化した際の影響はありますか。"><a href="#Q-TLS-1-0-1-1-を無効化した際の影響はありますか。" class="headerlink" title="Q. TLS 1.0 /1.1 を無効化した際の影響はありますか。"></a>Q. TLS 1.0 /1.1 を無効化した際の影響はありますか。</h3><p>A. Azure  や Office 365 など弊社のクラウドサービスは すでに TLS 1.2 にて動作をしておりますので影響ございません。また、社内のサーバー間での通信におきましても、上記 TLS 1.2 の無効化がされていなければ 影響はありません。その他 ご利用いただいている Web サービス 等がある場合には、それぞれ サービス提供元にご確認ください。</p><p>上記内容が少しでも参考となりますと幸いです。なお、製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポート サービスをご利用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。 Azure Identity サポート チームです。&lt;/p&gt;
&lt;p&gt;こちらのブログでは、MC246440 にて案内している Azure AD における TLS 1.0 および TLS 1.1 の無効化における Azure AD Connect の対応ついてご案</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Azure AD Connect" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-Connect/"/>
    
    <category term="TLS 1.2" scheme="https://jpazureid.github.io/blog/tags/TLS-1-2/"/>
    
  </entry>
  
  <entry>
    <title>クライアント シークレット作成画面の変更について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azuread-clientsecrets-202104/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azuread-clientsecrets-202104/</id>
    <published>2021-04-19T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.127Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity チームの栗井です。</p><p>この度、Azure AD アプリケーション (Service Principal) のクライアント シークレットの作成画面の変更、設定可能な有効期限の変更がありましたので、本記事にて紹介します。</p><h2 id="新旧画面の比較"><a href="#新旧画面の比較" class="headerlink" title="新旧画面の比較"></a>新旧画面の比較</h2><p>該当画面 : [Azure Active Directory] &gt; [アプリの登録] &gt; (任意のアプリケーション) &gt; [証明書とシークレット]</p><p><img src="/blog/azure-active-directory/azuread-clientsecrets-202104/clientsecrets.png" alt="該当画面"></p><ul><li><p>従来の画面では、有効期限が「1 年」「2 年」「なし (= 無期限)」が選択いただけました。</p></li><li><p>新しい画面では、1, 12, 18, 24 ヶ月が選択肢として表示されます。</p><p>  [カスタム] を選択することで更にきめ細かく開始日と終了日を選択可能です。</p><ul><li>開始日 : 現在の日付 ～ 1 年 6 ヶ月後の範囲内を指定します。(現在の日時が 2021/04/20 の場合、2021/04/20 ～ 2022/10/20 の範囲)</li><li>終了日 : 開始日 ～ 開始日 ＋ 2 年後 の範囲内を指定します。(開始日を 2021/04/20 にした場合、2021/04/20 ～ 2023/04/20 の範囲)</li></ul></li></ul><h2 id="最大の変更点-“無期限”-のクライアント-シークレットが作成不可になりました"><a href="#最大の変更点-“無期限”-のクライアント-シークレットが作成不可になりました" class="headerlink" title="最大の変更点 : “無期限” のクライアント シークレットが作成不可になりました"></a>最大の変更点 : “無期限” のクライアント シークレットが作成不可になりました</h2><p>上記の変更によって、 <strong>新しい画面では無期限 (= 失効日を持たない永続的な) クライアント シークレットを作成することができなくなりました。</strong> 最大でも 2 年ごとに、クライアント シークレットを更新する必要があります。</p><h2 id="動作変更に至った経緯"><a href="#動作変更に至った経緯" class="headerlink" title="動作変更に至った経緯"></a>動作変更に至った経緯</h2><p>上記の動作変更は「同じクライアント シークレットを長期間利用し続けることは、セキュリティ リスクである」という考えに基づきます。</p><p>クライアント シークレットは、アプリケーションが Azure AD へアクセスするために利用するための資格情報です。万が一この情報が漏洩することで、その登録されたアプリケーションに許可された操作をおこなうことができます。</p><p>特に、利用されなくなったアプリケーションが、有効な資格情報 (クライアント シークレット) を保持し続けることは、リスクと考えられます。</p><p>Azure AD に登録されたアプリケーションについて、利用されなくなった時点で適宜削除することが理想的ではありますが、現実問題、多かれ少なかれ残存してしまう現状があります。このようなアプリケーションが、無期限の資格情報を持つ、アプリケーションに許可された操作を行える状態になっていることは、望ましくない状態です。</p><h2 id="過去に作成した-“無期限”-のクライアント-シークレットはどうなりますか？"><a href="#過去に作成した-“無期限”-のクライアント-シークレットはどうなりますか？" class="headerlink" title="過去に作成した “無期限” のクライアント シークレットはどうなりますか？"></a>過去に作成した “無期限” のクライアント シークレットはどうなりますか？</h2><p>結論から言いますと、過去に作成した、有効期限が無期限のクライアント シークレットの有効期限は変わりません。</p><p>有効期限が無期限のクライアント シークレットは、これまでも内部的には “2299 年 12 月 31 日” が有効期限とされていたので、新しい画面ではこの日付に置き換わります。</p><p>今回の動作変更 (選択できるのは最長 2 年、無期限は選べない) は、これから新たな画面で作成される、新しいクライアント シークレットが対象です。</p><h2 id="PowerShell-からは、有効期限が-2-年以上のクライアント-シークレットが作成できるようですが…"><a href="#PowerShell-からは、有効期限が-2-年以上のクライアント-シークレットが作成できるようですが…" class="headerlink" title="PowerShell からは、有効期限が 2 年以上のクライアント シークレットが作成できるようですが…"></a>PowerShell からは、有効期限が 2 年以上のクライアント シークレットが作成できるようですが…</h2><p>はい、現在は PowerShell コマンドでクライアントシークレットを作成する際は、2 年以上の有効期限を指定することが可能です。</p><ol><li>PowerShell を管理者権限で起動します</li><li>下記コマンドで  Azure Active Directory PowerShell モジュール をインストールします (すでにインストール済みである場合は必要ありません)<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Install-Module -Name AzureAD</span><br></pre></td></tr></table></figure></li><li>下記コマンドでテナントに接続します <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Connect-AzureAD </span><br></pre></td></tr></table></figure></li><li>下記コマンドでシークレットを作成します <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">New-AzureADApplicationPasswordCredential -ObjectId &lt;アプリの Object Id を指定&gt; -CustomKeyIdentifier &quot;キーの説明&quot; -StartDate &quot;2021/04/20 00:00:00&quot; -EndDate &quot;2299/12/31 23:59:59&quot;</span><br></pre></td></tr></table></figure></li></ol><p>ただし、いずれは PowerShell コマンドによるクライアントシークレット作成にも、Azure ポータル上と同じ制限がかかるようになる方針です (制限が反映された際には、この項目は削除する予定です)。この制限が実施されるスケジュールについては、現時点では未定です。</p><h2 id="今後のアップデートについて"><a href="#今後のアップデートについて" class="headerlink" title="今後のアップデートについて"></a>今後のアップデートについて</h2><p>本変更についての公開情報やアナウンス等は、現在 (2021/04/21) の時点で公開されておりません。新たな情報が入り次第、本記事内でアップデートさせていただきます。</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>上記の内容がご参考になれば幸いです。<br>ご不明点などございます場合は、ぜひ弊社サポートサービスをご利用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity チームの栗井です。&lt;/p&gt;
&lt;p&gt;この度、Azure AD アプリケーション (Service Principal) のクライアント シークレットの作成画面の変更、設定可能な有効期限の変更がありましたので、本記事にて紹介します。&lt;/</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Application" scheme="https://jpazureid.github.io/blog/tags/Application/"/>
    
    <category term="Client Secrets" scheme="https://jpazureid.github.io/blog/tags/Client-Secrets/"/>
    
  </entry>
  
  <entry>
    <title>3/18 (日本語抄訳) RCA - 複数の Microsoft サービスで発生した認証エラー (Tracking ID LN01-P8Z)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/20210318-rca-azure-ad/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/20210318-rca-azure-ad/</id>
    <published>2021-03-17T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.059Z</updated>
    
    <content type="html"><![CDATA[<p>いつも Azure Identity サポート チームのブログを参照いただきましてありがとうございます。</p><p>今回は 日本時間の 3/16 に発生しました Azure Active Directory の障害について、RCA (Root Cause Analysis) レポートの日本語版の抄訳を紹介します。原文は <a href="https://status.azure.com/ja-jp/status/history/">状態の履歴および根本原因分析 (RCA)</a> を確認ください。</p><p>日本語版の抄訳の PDF については、以下のリンクよりダウンロード頂けます。</p><p><a href="/blog/azure-active-directory/20210318-rca-azure-ad/LN01-P8Z_JP.pdf">LN01-P8Z _JP.pdf</a></p><p>本障害では Azure および Office 365 へのサインインができないことをはじめ、障害の対象となりましたテナントで多大な影響が生じました。改めて、今回の障害により多くのお客様にご迷惑をお掛けしましたことを深くお詫び申し上げます。</p><h2 id="3-18-日本語抄訳-RCA-–-複数の-Microsoft-サービスで発生した認証エラー-Tracking-ID-LN01-P8Z"><a href="#3-18-日本語抄訳-RCA-–-複数の-Microsoft-サービスで発生した認証エラー-Tracking-ID-LN01-P8Z" class="headerlink" title="3/18 (日本語抄訳) RCA – 複数の Microsoft サービスで発生した認証エラー (Tracking ID LN01-P8Z)"></a>3/18 (日本語抄訳) RCA – 複数の Microsoft サービスで発生した認証エラー (Tracking ID LN01-P8Z)</h2><h3 id="影響の概要"><a href="#影響の概要" class="headerlink" title="影響の概要"></a>影響の概要</h3><p>2021 年 3 月 15 日の 19:00 UTC (日本時間 3 月 16 日 AM 4:00) から 2021 年 3 月 16 日の 09:37 UTC (日本時間 3 月 16 日 18:37) の間で、認証を Azure Active Directory (Azure AD) に依存する Microsoft サービスおよびサードパーティ アプリケーションにおいて、認証処理を行う際にエラーが発生した可能性があります。Azure AD サービスに対する対処策は、2021 年 3 月 15 日 21:05 UTC (日本時間 3 月 16 日 6:05) に完了しました。これにより各サービスへのトラフィックが順次回復しました。以下に、主なサービスとその回復までの時間を示します。</p><p>2021 年 3 月 15 日 22:39 UTC (日本時間 3 月 16 日 07:39): Azure Resource Manager が回復しました。<br>2021 年 3 月 16 日 01:00 UTC (日本時間 3 月 16 日 10:00): Azure Key Vault (ほとんどのリージョン) が回復しました。<br>2021 年 3 月 16 日 01:18 UTC (日本時間 3 月 16 日 10:18): セーフ デプロイメント プロセス (SDP) の一環として、Azure Storage の構成アップデートを最初の運用テナントに適用しました。<br>2021 年 3 月 16 日 01:50 UTC (日本時間 3 月 16 日 10:50): Azure Portal の機能が完全に回復しました。<br>2021 年 3 月 16 日 04:04 UTC (日本時間 3 月 16 日 13:04): Azure Storage の構成変更がほとんどのリージョンに適用されました。<br>2021 年 3 月 16 日 04:30 UTC (日本時間 3 月 16 日 13:30): 残りの Azure Key Vault リージョン (West US、Central US、East US 2) が回復しました。<br>2021 年 3 月 16 日 09:25 UTC (日本時間 3 月 16 日 18:25): Azure Storage が復旧を完了し、障害が完全に解消したことを報告しました。</p><h3 id="根本原因と緩和策"><a href="#根本原因と緩和策" class="headerlink" title="根本原因と緩和策"></a>根本原因と緩和策</h3><p>Azure AD は、OpenID およびその他の ID 標準プロトコルの利用をサポートするために、暗号鍵を使用して暗号的な署名処理を行います。セキュリティを高める標準的な対策の一環として、自動化されたシステムが、スケジュールに従い使用されなくなった鍵を自動的に削除します。過去数週間にわたり、複雑な複数のクラウドにまたがる移行を行うために、特定の鍵を通常よりも長い期間にわたり「保持」とマークしていました。この対応において、自動化処理がその「保持」状態を誤って無視してしまう不具合が顕在化し、その特定の鍵が削除される状態が生じました。</p><p>署名鍵に関するメタデータは、インターネットの ID 標準プロトコルに沿い、Azure AD によってインターネット上でアクセス可能な場所に公開されます。この公開されたメタデータが 2021 年 3 月 15 日 19:00 UTC (日本時間 3 月 16 日 AM 4:00) に変更されたことにより、Azure AD と連携してこれらのプロトコルを使用するアプリケーションは、順次新しいメタデータを取得し始めました。結果として、削除された鍵で署名されたトークン/アサーションが信頼されなくなりました。この時点で、エンド ユーザーはこれらのアプリケーションにアクセスすることができなくなりました。</p><p>サービスのテレメトリによって問題が検知され、エンジニアリング チームが問題の対応を開始しました。2021 年 3 月 15 日 19:35 UTC (日本時間 3 月 16 日 AM 4:35) に、進行中だった直近のバックエンドの基盤変更を元の状態に戻しました。鍵の削除処理が根本的な原因であることが判明したため、21:05 UTC (日本時間 AM 6:05) に鍵のメタデータを以前の状態にロールバックしました。</p><p>アプリケーションはロールバックされたメタデータを取得し、正しいメタデータでキャッシュを更新する必要があります。キャッシュの処理方法が様々なサーバーでそれぞれ異なって実装されているため、個々のアプリケーションが復旧するまでの時間もそれぞれ異なるものとなりました。一部のストレージ リソースでは、キャッシュされたメタデータによる影響が長く続きました。このため、これらのキャッシュを無効化して更新するための更新プログラムを展開しました。このプロセスが完了し、2021 年 3 月 16 日 9:37 UTC (日本時間 3 月 16 日 18:37) に、残存する影響を受けたお客様に対しても問題の解消が報告されました。</p><p>Azure AD は、この問題を含む一連のリスクを防ぐため、バックエンドのセーフ デプロイメント プロセス (SDP) システムに追加の保護を適用するという複数フェーズの取り組みを進めていました。第 1 フェーズでは、新しい鍵の追加を保護する対応を行いましたが、鍵の削除への対応は第 2 フェーズにあり、今年半ばまでに完了する予定でした。以前の Azure AD の障害は 2020 年 9 月 28 日に発生しており、複数フェーズの SDP の取り組みが完了すれば、どちらの障害も再発を防止できる類いのリスクとなります。</p><h3 id="次のステップ"><a href="#次のステップ" class="headerlink" title="次のステップ"></a>次のステップ</h3><p>今回の障害がどれほど深刻な影響を与えたか、また容認しがたいものであったか弊社としても認識しており、深く陳謝いたします。今後このような問題が発生しないように、Microsoft Azure プラットフォームとプロセスの改善に継続的に取り組んでまいります。9 月の障害では、「今回確認された一連の問題を防ぐため、Azure AD サービスのバックエンド SDP システムに追加の保護機能を適用する」という計画を示しました。</p><ul><li><p>この SDP の変更の第 1 段階は終了し、第 2 段階は非常に慎重かつ段階的に展開を進めており、今年半ばに終了する予定です。初期の分析では、このシステムが完全に導入されれば、今回起きたような障害や 2020 年 9 月に起きた関連する障害も防止が可能です。それまでは、SDP の第 2 フェーズが完了するまでの間、鍵の削除プロセスに追加の保護措置を講じます。</p></li><li><p>9 月に発生した障害では、Azure AD バックアップ認証システムの導入についても言及しました。この取り組みは順調に進んでいます。しかし、残念ながら今回のケースでは、Azure AD バックアップ認証システムはトークンの発行を保護できても、トークンの検証までは保護できませんでした。これはトークンの検証処理が今回影響を受けたメタデータのエンドポイントに依存しているためです。</p></li><li><p>本障害では、Azure Active Directory を使用しているお客様にはサービス正常性を通じて通知を行いました。しかし、影響を受けた関連するサービスすべてに対しての通知を行うことができませんでした。この点については、ツールの不備があると判断し、今後適切に通知が行われるよう対応していく予定です。</p></li><li><p>調査と進捗状況について、お客様により最新の情報を提供すべきでした。今回、Azure、Microsoft 365、Dynamics 365 の間で情報提供の詳細やタイミングに差異があったことを確認しており、複数の Microsoft サービスを利用しているお客様の混乱を招きました。このためサービス間で一貫性と透明性を高めるために、修復項目を設けています。</p></li></ul><h3 id="フィードバックのお願い"><a href="#フィードバックのお願い" class="headerlink" title="フィードバックのお願い"></a>フィードバックのお願い</h3><p>Azure カスタマー・コミュニケーション・エクスペリエンスの向上のためのアンケートにご協力ください: <a href="https://aka.ms/AzurePIRSurvey">https://aka.ms/AzurePIRSurvey</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;いつも Azure Identity サポート チームのブログを参照いただきましてありがとうございます。&lt;/p&gt;
&lt;p&gt;今回は 日本時間の 3/16 に発生しました Azure Active Directory の障害について、RCA (Root Cause Analysi</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD サポートが提供する [深刻度 A の対応について]</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/support-sevA/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/support-sevA/</id>
    <published>2021-02-28T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.307Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure &amp; Identity サポート チームの関口です。</p><p>今回は、お客様が弊社サポートにお問い合わせする際にご指定いただく「深刻度 (重要度 / 緊急度) A」の詳細について紹介します。<br>本記事は Azure ＆ Identity (Azure AD) サポートを念頭に置いてまとめたものですが、基本的には Azure サポート全般に当てはまります。どのような状況の際に「深刻度 A」での対応となるか、サポートをご利用いただく際の助けになれば幸いです。</p><br><p>Azure のサポートでは、深刻度を A ~ C に分類しています。</p><p>通常深刻度 (深刻度 B、もしくは C) は、日本時間の営業時間内 平日 9:00 ～ 17:30 の対応のみ承っています。<br>※ 土日祝日、年末年始、事前に <a href="https://aka.ms/JSupport">日本マイクロソフト サポート情報 (aka.ms/JSupport)</a> にてお知らせするサポート休業日を除く</p><p>深刻度 A の支援を提供する際の条件・対応範囲については、以下の公開情報に詳細がありますので参照ください。</p><p><a href="https://azure.microsoft.com/ja-jp/support/plans/response/">サポート プラン—サポート内容と応答性 | Microsoft Azure</a><br><a href="https://www.microsoft.com/ja-jp/services/professional-supportqa.aspx">プロフェッショナル サポートをご利用の皆様へ - Microsoft Services</a></p><p>深刻度 A は限定された範囲や条件での対応となるため、お客様のご状況に対して最適な深刻度 (B または C) を弊社より案内させていただく可能性がありますことをご了承いただければ幸いです。深刻度 A の対応に関する詳細な説明は以下をご参照ください。</p><br><h2 id="▼-深刻度-A-の定義"><a href="#▼-深刻度-A-の定義" class="headerlink" title="▼ 深刻度 A の定義"></a>▼ 深刻度 A の定義</h2><p>「事業に重要な影響が及ぶ場合」の案件に対するご支援が該当します。<br>「事業に重要な影響が及ぶ場合」とは、サーバーダウン、データベース破損やメールの滞留、多数のユーザーがログインできない等、ビジネスに多大な影響を及ぼすような危機的状況を示します。製造業であれば生産ラインが止まる、金融業であれば取引システムダウン、医療関係であれば医療行為の妨げとなるなど、お客様のビジネスに大規模な損失や影響が発生している状態です。</p><p>たとえば、以下のようなご状況は深刻度 A として対応を実施します。</p><h3 id="パターン-1-Microsoft-365-を利用しているが、-Azure-AD-を利用したユーザー認証に失敗し、メールを使うことができない。"><a href="#パターン-1-Microsoft-365-を利用しているが、-Azure-AD-を利用したユーザー認証に失敗し、メールを使うことができない。" class="headerlink" title="パターン 1 : Microsoft 365 を利用しているが、 Azure AD を利用したユーザー認証に失敗し、メールを使うことができない。"></a>パターン 1 : Microsoft 365 を利用しているが、 Azure AD を利用したユーザー認証に失敗し、メールを使うことができない。</h3><p>深刻度 A で対応します。なお、この場合は、大規模なデータセンター障害の可能性もありますので、先に <a href="https://status.azure.com/ja-jp/status">Azure の状態</a> や <a href="https://status.office.com/">Microsoft 365 Service health status (office.com)</a> を参照し、お客様のテナントに依存しない問題が発生していないかの確認もお勧めします。</p><h3 id="パターン-2-オンプレミスで運用しているフェデレーション-サーバー-AD-FS-がダウンし、-AD-FS-に依存する認証に失敗する。"><a href="#パターン-2-オンプレミスで運用しているフェデレーション-サーバー-AD-FS-がダウンし、-AD-FS-に依存する認証に失敗する。" class="headerlink" title="パターン 2 : オンプレミスで運用しているフェデレーション サーバー (AD FS) がダウンし、 AD FS に依存する認証に失敗する。"></a>パターン 2 : オンプレミスで運用しているフェデレーション サーバー (AD FS) がダウンし、 AD FS に依存する認証に失敗する。</h3><p>深刻度 A で対応します。なお、深刻度 A は復旧を目的としたご支援となるため、バックアップが存在する場合はバックアップからの復元、バックアップを利用できない場合はサーバーの再構築での対応を進め、復旧後の原因調査などは、深刻度 B または C での通常営業時間内での調査となります。</p><h3 id="パターン-3-Azure-AD-Connect-でオンプレミスから-Azure-AD-に同期を構成している環境で、大量のユーザー-グループを削除・変更してしまい、メールが届かなくなるなどの障害が発生した。"><a href="#パターン-3-Azure-AD-Connect-でオンプレミスから-Azure-AD-に同期を構成している環境で、大量のユーザー-グループを削除・変更してしまい、メールが届かなくなるなどの障害が発生した。" class="headerlink" title="パターン 3 : Azure AD Connect でオンプレミスから Azure AD に同期を構成している環境で、大量のユーザー / グループを削除・変更してしまい、メールが届かなくなるなどの障害が発生した。"></a>パターン 3 : Azure AD Connect でオンプレミスから Azure AD に同期を構成している環境で、大量のユーザー / グループを削除・変更してしまい、メールが届かなくなるなどの障害が発生した。</h3><p>深刻度 A で対応します。削除したオブジェクトの復元などは必ずしもできない場合がありますが、復旧のための支援を深刻度 A で対応します。復旧後の原因、再発防止などの支援については、深刻度 B または C での通常営業時間内での調査となります。</p><p>一方、事象が既に解消されており原因究明を目的とした調査をご希望される場合や、設定方法の How To などのアドバイザリ要素を含む支援は 深刻度 A として承ることができません。<br>以下のような例では、深刻度 B または C での通常営業時間内の対応とさせていただいております。</p><h3 id="パターン-4-Azure-AD-を利用したユーザー認証に失敗する事象が発生したが、理由はわからないものの現在は解消されているように見受けられる。今のうちに原因究明を行い、再発する可能性がないことを保証したい。"><a href="#パターン-4-Azure-AD-を利用したユーザー認証に失敗する事象が発生したが、理由はわからないものの現在は解消されているように見受けられる。今のうちに原因究明を行い、再発する可能性がないことを保証したい。" class="headerlink" title="パターン 4 : Azure AD を利用したユーザー認証に失敗する事象が発生したが、理由はわからないものの現在は解消されているように見受けられる。今のうちに原因究明を行い、再発する可能性がないことを保証したい。"></a>パターン 4 : Azure AD を利用したユーザー認証に失敗する事象が発生したが、理由はわからないものの現在は解消されているように見受けられる。今のうちに原因究明を行い、再発する可能性がないことを保証したい。</h3><p>明確に事象の再発が予期されるご状況ではない場合は、深刻度 A として承ることはできません。</p><h3 id="パターン-5-Azure-AD-を利用した多数のユーザー認証が失敗してしまう事象が発生した。Azure-AD-の特定の機能が原因であることは把握しており、無効にすれば事象の回避を行うことができるが、設定変更は避けたい。"><a href="#パターン-5-Azure-AD-を利用した多数のユーザー認証が失敗してしまう事象が発生した。Azure-AD-の特定の機能が原因であることは把握しており、無効にすれば事象の回避を行うことができるが、設定変更は避けたい。" class="headerlink" title="パターン 5 : Azure AD を利用した多数のユーザー認証が失敗してしまう事象が発生した。Azure AD の特定の機能が原因であることは把握しており、無効にすれば事象の回避を行うことができるが、設定変更は避けたい。"></a>パターン 5 : Azure AD を利用した多数のユーザー認証が失敗してしまう事象が発生した。Azure AD の特定の機能が原因であることは把握しており、無効にすれば事象の回避を行うことができるが、設定変更は避けたい。</h3><p>事象の回避策がある場合は深刻度 A での対応継続はできず、基本的にはその対応による回避をお願いしております。事象回避策を実施することで、お客様の事業に重大な影響が生じることが想定される場合は、具体的な影響についてヒアリングの上、支援の判断をさせていただきます。</p><h3 id="パターン-6-プロジェクトのスケジュールの関係上、すぐに事象の原因を究明したい-または-仕様の確認を行いたい。特定の日までに構築を完了させる必要があるため、本日中の解決を依頼したい。"><a href="#パターン-6-プロジェクトのスケジュールの関係上、すぐに事象の原因を究明したい-または-仕様の確認を行いたい。特定の日までに構築を完了させる必要があるため、本日中の解決を依頼したい。" class="headerlink" title="パターン 6 : プロジェクトのスケジュールの関係上、すぐに事象の原因を究明したい または 仕様の確認を行いたい。特定の日までに構築を完了させる必要があるため、本日中の解決を依頼したい。"></a>パターン 6 : プロジェクトのスケジュールの関係上、すぐに事象の原因を究明したい または 仕様の確認を行いたい。特定の日までに構築を完了させる必要があるため、本日中の解決を依頼したい。</h3><p>基本的に深刻度 A での対応を承ることはできません。このような場合、案内の時刻や日付のお約束はできませんが、通常営業時間内で可能な限り早期に案内を差し上げることができるように善処します。</p><br><h2 id="▼-支援時間"><a href="#▼-支援時間" class="headerlink" title="▼ 支援時間"></a>▼ 支援時間</h2><p>弊社営業時間以外の深夜や休日であっても、24 時間 365 日エンジニアが対応します。</p><br><h2 id="▼-支援範囲"><a href="#▼-支援範囲" class="headerlink" title="▼ 支援範囲"></a>▼ 支援範囲</h2><p>正常な状態で稼働していたサービスを危機的状況から脱却させるまでの復旧、問題回避を目的とした支援となります。仕様確認、危機的状況から脱却したあとの原因究明などは含まれません。事象の回避や復旧が完了した場合は、以降の支援は翌営業日以降での通常営業時間内での対応とさせていただきます。</p><br><h2 id="▼-支援条件"><a href="#▼-支援条件" class="headerlink" title="▼ 支援条件"></a>▼ 支援条件</h2><p>お客様がマイクロソフトの担当と常に電話で連絡が取れる状態であることが条件となります。</p><p>また、上述の通り、お客様環境を危機的状況から脱却させることを目的とした対応が深刻度 A の支援範囲となりますので、原則として、マイクロソフトの担当が依頼する切り分けや回避策の実施に全面的にご協力いただく必要があります。</p><p>なお、お客様と連絡が取れないなどの理由で、支援を満足にご提供できないと弊社が判断した場合、または、お問い合わせ内容が深刻度 A に該当しない場合、お問い合わせの深刻度を B または C に変更の上、通常営業時間内での対応とさせていただくことがあります。</p><br><h2 id="▼-その他"><a href="#▼-その他" class="headerlink" title="▼ その他"></a>▼ その他</h2><p>• お客様の問題がお客様側の設定ミスに起因する問題であり、その解消のために、弊社データ センター側へエスカレーションを実施の上、データ センター側で対応が必要な場合 (例 条件付きアクセスによる管理者のブロック) は、緊急対応による即日の対応は困難となります。</p><p>• 問題の原因が、お客様もしくはサードパーティー製のアプリケーション (モジュール) にある可能性が高いとエンジニアが判断した場合、継続の調査を承ることができません。</p><p>• Azure データ センター側に起因した問題の原因は、基本的に <a href="https://status.azure.com/ja-jp/status/history/">Azure の状態の履歴 | Microsoft Azure</a> に記載されている以上の情報開示はできません。<br>生じていた問題について問題解決の過程で判明したものであればお伝え可能ですが、原因究明それ自体を目的とした調査を承ることはできません。<br>(オンプレミス製品の原因の調査は、<a href="https://www.microsoft.com/ja-jp/services/Microsoft-Unified-Support.aspx">マイクロソフト ユニファイドサポート (旧 Premier サポート)</a> をご利用いただいている場合のみご支援が可能です)</p><p>• Professional Developer サポートは、開発環境を想定しているため、深刻度 A もしくは B をご利用いただくことはできません。</p><br><p>以上の通り、深刻度 A は限定的な支援のご提供となりますが、深刻度 B や C では、お客様の状況や実現されたい内容をしっかりとヒアリングした上で腰を据えてよりきめ細かなご支援を提供することができます。また、深刻度の差異にかかわらず、どのようなお問い合わせにつきましても、サポート担当一人ひとりが誠心誠意をもってお客様の助けになるように努めてまいりますので、どうぞよろしくお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure &amp;amp; Identity サポート チームの関口です。&lt;/p&gt;
&lt;p&gt;今回は、お客様が弊社サポートにお問い合わせする際にご指定いただく「深刻度 (重要度 / 緊急度) A」の詳細について紹介します。&lt;br&gt;本記事は Azure ＆ Identit</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD サポートが提供する [ご支援に関する Q&amp;A]</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/support-Q&amp;A/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/support-Q&amp;A/</id>
    <published>2021-02-28T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.307Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure &amp; Identity サポート チームの関口です。</p><p>今回は、Azure AD サポート窓口の対応に関する Q ＆ A をおまとめしました。<br>本記事は Azure ＆ Identity (Azure AD) サポートを念頭に置いたものですが、基本的には Azure サポート全般に当てはまります。<br>Azure サポートに関する公開情報は以下のものがありますが、より具体的なサポート シナリオについて本記事で説明します。</p><p><a href="https://azure.microsoft.com/ja-jp/support/faq/">サポートに関する FAQ | Microsoft Azure</a><br><a href="https://azure.microsoft.com/ja-jp/support/plans/">Azure のサポート プランの比較 | Microsoft Azure</a></p><br><h2 id="▼-お問い合わせの発行-対応終了-再オープンについて"><a href="#▼-お問い合わせの発行-対応終了-再オープンについて" class="headerlink" title="▼ お問い合わせの発行 / 対応終了 / 再オープンについて"></a>▼ お問い合わせの発行 / 対応終了 / 再オープンについて</h2><h4 id="Q-問い合わせを発行したテナントと異なるテナントの調査は受け付けてもらえますか？"><a href="#Q-問い合わせを発行したテナントと異なるテナントの調査は受け付けてもらえますか？" class="headerlink" title="Q. 問い合わせを発行したテナントと異なるテナントの調査は受け付けてもらえますか？"></a>Q. 問い合わせを発行したテナントと異なるテナントの調査は受け付けてもらえますか？</h4><p>A. 原則受け付けることはできません。</p><p>お客様が発行するお問い合わせはテナントに紐づいています。Azure AD に関する技術サポートはサポート契約が存在するテナントを対象としているため、サポート契約の有無を客観的に判断することができない異なるテナントの調査は原則承ることができません。</p><h4 id="Q-パートナー契約を締結している場合、問い合わせを発行したテナントと異なるテナントの調査は受け付けてもらえますか？"><a href="#Q-パートナー契約を締結している場合、問い合わせを発行したテナントと異なるテナントの調査は受け付けてもらえますか？" class="headerlink" title="Q. パートナー契約を締結している場合、問い合わせを発行したテナントと異なるテナントの調査は受け付けてもらえますか？"></a>Q. パートナー契約を締結している場合、問い合わせを発行したテナントと異なるテナントの調査は受け付けてもらえますか？</h4><p>A. 調査対象のテナントよりお問い合わせを発行してください。</p><p>パートナー契約 (Cloud Solution Provider 契約) を締結いただいているお客様におかれましては、エンドのお客様のお問い合わせを代理で起票いただくシナリオは多いかと存じます。この場合、調査対象のテナントからのお問い合わせをお願いします。<br>何らかの事情により、エンドのお客様のテナントからお問い合わせが発行できない場合は、お問い合わせ発行時にその旨 (お問い合わせが発行できないご事情) をご記載ください。お問い合わせをいただいた上で、サポート担当が個別に確認をさせていただきます。</p><h4 id="Q-問い合わせ終了後の再開は可能ですか？"><a href="#Q-問い合わせ終了後の再開は可能ですか？" class="headerlink" title="Q. 問い合わせ終了後の再開は可能ですか？"></a>Q. 問い合わせ終了後の再開は可能ですか？</h4><p>A. サポート契約が有効であれば可能です。以前のお問い合わせ番号を明記の上、新規のお問い合わせ発行をお願いします。</p><p>お問い合わせ対応の終了 (クローズ) は、お客様のご了承をいただいた場合、あるいは一定期間ご連絡をいただけなかった場合にサポート担当が実施します。<br>対応終了後でもご質問があったり、事象が再発した場合、サポート契約が有効であればいつでも対応を再開することが可能です。その際には、以前のお問い合わせ番号を明記の上、新規お問い合わせの発行をお願いします。以前のお問い合わせ番号を確認し、対応経緯を把握した上でサポート担当からご連絡差し上げます。</p><br><h2 id="▼-ご支援の方法について"><a href="#▼-ご支援の方法について" class="headerlink" title="▼ ご支援の方法について"></a>▼ ご支援の方法について</h2><h4 id="Q-問題の原因究明をしてもらうことは可能ですか？"><a href="#Q-問題の原因究明をしてもらうことは可能ですか？" class="headerlink" title="Q. 問題の原因究明をしてもらうことは可能ですか？"></a>Q. 問題の原因究明をしてもらうことは可能ですか？</h4><p>A. 問題解決の過程で判明した原因であればお伝えすることが可能です。</p><p>Azure AD などのクラウド環境に関する技術サポートでは、発生している障害の解消を目的とした支援を提供します。問題解決のために必要な原因調査を実施し、調査過程で判明した原因に関する情報は基本的にお伝えさせていただきます。しかしながら、原因究明それ自体を目的とした調査は承ることができません。</p><blockquote><p><strong>(例) ユーザー アカウントの属性値変更を実施したところエラーにより変更できなかった。改めて変更してみたところ問題なく変更でき、以降は事象は発生しない。なぜエラーとなったのか原因が知りたい</strong><br>→ 事象は解消されており、原因究明を目的とする問い合わせとサポート担当が判断する可能性があります。その場合は調査を承ることができません。</p></blockquote><p>なお、ご利用のオンプレミス環境において、たとえば Windows Server が関係する障害の原因究明調査については、<a href="https://www.microsoft.com/ja-jp/services/Microsoft-Unified-Support.aspx">マイクロソフト ユニファイド サポート 契約</a> や <a href="https://www.microsoft.com/ja-jp/services/support.aspx#coreui-feature-cieaak9">Premier サポート契約</a> において有償で承ります。</p><h4 id="Q-今日中-指定日中-に問題を解決してほしいのですが…"><a href="#Q-今日中-指定日中-に問題を解決してほしいのですが…" class="headerlink" title="Q. 今日中 (指定日中) に問題を解決してほしいのですが…"></a>Q. 今日中 (指定日中) に問題を解決してほしいのですが…</h4><p>A. 解決日時のお約束をすることはできませんが、お客様のご状況を考慮して最善を尽くします。</p><p>お客様のご状況をヒアリングの上、可能な限り早期にご案内できるように善処いたします。具体的な対応のスピード感や案内目途については、ケース バイ ケースでサポート担当が判断いたしますが、お客様とご相談の上決めさせていただきます。</p><h4 id="Q-サポートでは対応できない問い合わせの具体例を教えてください。"><a href="#Q-サポートでは対応できない問い合わせの具体例を教えてください。" class="headerlink" title="Q. サポートでは対応できない問い合わせの具体例を教えてください。"></a>Q. サポートでは対応できない問い合わせの具体例を教えてください。</h4><p>A. 以下に詳細をご説明します。</p><p>基本的にサポートのご支援範囲は以下の 2 項目となります。</p><p>A) 障害対応<br>B) 公開情報 / 事例レベルの一般的な Q &amp; A 対応</p><p>一方で、以下に該当するお問い合わせは、アドバイザリやサポート契約で対応可能なご支援を超えるものとなり、原則は承ることができません。</p><p>・お客様の要件に沿った設計やアーキテクチャについてのアドバイスやキャパシティプランニング<br>・お客様が作成したコードのレビュー<br>・アプリケーションや構成のチューニング (パフォーマンスのチューニングなど)<br>・お客様の作業手順のレビュー<br>・お客様の運用方針や要件に沿ったスクリプトの提供<br>・事例や公開情報レベル以上の詳細な仕様の検証および調査<br>・事例や公開情報レベル以上のお客様の特殊な要件を満たすためのソリューションや実現方法に関する調査<br>・所定のメール回答以外の報告書作成<br>・機能拡張に関する定期的なご報告</p><blockquote><p><strong>(例) Teams などのオンライン会議への参加</strong><br>サポートの支援は、基本的にある 1 つの問題 (障害) に対しての解決策の提示を目的としています。そのため、問題を解決するための情報収集という観点からオンライン会議にサポート担当が参加することはあります。しかし、複数の課題に対してのアドバイスを差し上げることを目的とした会議、お客様とのディスカッションを目的とした会議への参加に応じることは基本的にはできません。また、会議の日程についてはご支援を提供するサポート担当のスケジュール調整が必要となり、必ずしもご要望に沿えない場合があります。</p></blockquote><blockquote><p><strong>(例) 電話や画面共有などによる作業手順の認識合わせ</strong><br>サポートの支援は、原則お客様の質問への応答や、具体的な課題や問題の調査を目的としたサポートとなります。たとえば「手順の中の 〇〇 の箇所について、Azure AD の認証の観点で伺いたい」、「手順 〇〇 と 〇〇 の順序は Azure AD の観点だと問題ないか確認したい」といったように具体的な質問に対する質疑応答であれば支援可能です。<br>一方で、お客様の作業手順の妥当性の確認や、作業方針に対するアドバイザリに該当するものは、「コンサルテーション」あるいは「プロアクティブ」な要素を含みます。これらに該当するものは、原則サポートによる支援ではなく、有償対応によるコンサルティング サービスなどの個別契約をご検討ください。</p></blockquote><blockquote><p><strong>(例) サポートへの設定変更の依頼</strong><br>お客様環境の設定変更をサポート担当が代行して承ることはできません。例外として、テナント管理者がデッド ロックによりアクセスできず、サポート側で対処が必要なお問い合わせについては、お客様の依頼をもってサポート部門が承ることはあります。</p></blockquote><blockquote><p><strong>(例）サポートからの作業手順書の提示</strong><br>サポートの支援ではお客様の業務を請け負うことはできませんので、お客様の環境、構成、運用に則った詳細な手順は提供できません。あくまでも一般的な手順、公開情報に準ずるご案内を提供します。</p></blockquote><blockquote><p><strong>(例) Azure ADの仕様に関する質問</strong><br>クラウド側の仕様については非公開の情報もあり、基本的には公開情報でご案内していない情報は非公開であり、技術サポートからも回答を差し上げることができないとご認識ください。これは、仮に調査を行うことで仕様に関する情報をお客様にご案内できたとしても、クラウドの特性上、その時点の仕様が将来変更される可能性があるためです。</p></blockquote><blockquote><p><strong>(例) API や PowerShell スクリプトの提供</strong><br>サポートの支援は開発、運用の請負を請け負うことはできませんので、基本的にはスクリプトなどの提供はできません。過去事例などからスクリプトを提供できる場合であっても、あくまでサンプルスクリプトとして提供します。</p></blockquote><br><h2 id="▼-お問い合わせの分割をご依頼するガイドライン"><a href="#▼-お問い合わせの分割をご依頼するガイドライン" class="headerlink" title="▼ お問い合わせの分割をご依頼するガイドライン"></a>▼ お問い合わせの分割をご依頼するガイドライン</h2><h4 id="Q-追加質問をした際に、問い合わせの分割依頼を案内されました。1-つの問い合わせの中で対応していただけないのでしょうか。"><a href="#Q-追加質問をした際に、問い合わせの分割依頼を案内されました。1-つの問い合わせの中で対応していただけないのでしょうか。" class="headerlink" title="Q. 追加質問をした際に、問い合わせの分割依頼を案内されました。1 つの問い合わせの中で対応していただけないのでしょうか。"></a>Q. 追加質問をした際に、問い合わせの分割依頼を案内されました。1 つの問い合わせの中で対応していただけないのでしょうか。</h4><p>A. 原則は一問一答でご案内を差し上げております。サポート担当より新規発行の依頼がありましたらご協力をお願いします。</p><p>Azure のサポートは一問一答を原則としており、必要に応じてサポート担当がお問い合わせ内容の検証を行った上でご案内を提供しております。何をもって一問一答と定義するかをお客様が判断するのは、正直なところ難しい側面があるかと思います。</p><p>たとえば、「Azure AD PowerShell で特定のユーザーを確認するコマンドと、特定のグループを確認するコマンドを教えてほしい」というお問い合わせに対して、「ご質問がユーザーとグループで分かれているので、 2 つお問い合わせを発行ください」というのは一問一答の粒度が細かすぎて、お客様への負荷だけが大きくなってしまうことは理解しております。</p><p>一方で「Hybrid Azure AD Join の構成手順について教えてほしい」というお問い合わせに対して、構成手順の参考になる技術情報をご案内したところ「手順 1 は XXX のシナリオで実行しても問題ないのか？」「手順 2 のロジックがわからなかったので詳細を説明してほしい」「手順 3 は自身の環境でも必要な手順なのか、代替可能な方法はないのか？」といったご質問をいただいた際は、1 つのお問い合わせですべてをご案内することは困難です。構成手順の項目毎やお客様が疑問を抱えるシナリオをすべて網羅してご案内を差し上げることは膨大な確認と調査の時間が必要となるためです。</p><p>もちろん、上記と類似したお問い合わせに対して、コマンドやオプションのわずかな差異によって確認や検証に一定の時間がかかると想定された場合は、お問い合わせの分割依頼をさせていただくこともありますし、逆に、特定の機能の構成手順や仕様確認で多数のご質問をいただいた際に、分割のご案内をせずに 1 つのお問い合わせで網羅的にご案内を差し上げる場合もあります。</p><p>そのため、1 つのお問い合わせで承る内容は、原則一問一答をベースとしておりますが、お問い合わせの内容 / 確認に必要な想定時間 / お客様のご状況 といった諸要素を加味した上で、対応を承るサポート担当が都度判断をさせていただいております。</p><p>以下の例もあわせてご参考ください。</p><blockquote><p><strong>(例) 条件付きアクセスで複数のユーザーからブロックされた旨の申告があったので、それぞれの事象を調査してほしい</strong><br>複数のユーザーが “同様の事象により” ブロックされた場合は基本的に承ることが可能です。(確認を行うユーザー数によっては調査の方法を相談させていただく場合があります)<br>複数のユーザーが “異なる事象により” ブロックされたことが想定される場合は、調査対象となるユーザー毎にお問い合わせを発行いただきます。(確認を行うユーザー数が少ない場合は 1 つのお問い合わせで承る場合もあります)</p></blockquote><blockquote><p><strong>(例) 条件付きアクセスのサインインの頻度の仕組みを教えてほしい</strong><br>ご案内可能です。<br>しかし、案内後に「XXX というシナリオの場合はどのように動作することが期待されるか？」「YYY というシナリオの場合はどうか？」といった質問をいただいた場合は、基本的にはそれぞれのシナリオでお問い合わせの発行を依頼しております。(質問の内容や量に応じて 1 つのお問い合わせで承る場合もあります)<br>また、期待される動作や仕組みの回答を差し上げた後で、回答とは異なる想定されない動作が確認できた場合、その動作を調査するために新規のお問い合わせの発行をご依頼する可能性があります。</p></blockquote><h4 id="Q-問い合わせのやりとりの中で、サポートから問い合わせの分割依頼を案内されました。サポート側で発行はしてもらえないのでしょうか？"><a href="#Q-問い合わせのやりとりの中で、サポートから問い合わせの分割依頼を案内されました。サポート側で発行はしてもらえないのでしょうか？" class="headerlink" title="Q. 問い合わせのやりとりの中で、サポートから問い合わせの分割依頼を案内されました。サポート側で発行はしてもらえないのでしょうか？"></a>Q. 問い合わせのやりとりの中で、サポートから問い合わせの分割依頼を案内されました。サポート側で発行はしてもらえないのでしょうか？</h4><p>A. 原則はお客様にお問い合わせの発行をご依頼しております。</p><p>調査の状況により新規でお問い合わせの起票をご依頼するケースにおいても、その起票は恐れ入りますがお客様にて実施をお願いします。お客様情報の取り扱い上、間違いのないようにお客様側で対応いただくことをお願いしております。お問い合わせ発行の際に、関連お問い合わせの番号を添えていただければ、サポート内で連携を行い、可能な限りスムーズにご案内を差し上げますのでご安心ください。</p><h4 id="Q-問い合わせのやりとりの中で、オンプレミス観点での調査が必要と伺いました。この場合は継続の調査は受け付けてもらえないのでしょうか？"><a href="#Q-問い合わせのやりとりの中で、オンプレミス観点での調査が必要と伺いました。この場合は継続の調査は受け付けてもらえないのでしょうか？" class="headerlink" title="Q. 問い合わせのやりとりの中で、オンプレミス観点での調査が必要と伺いました。この場合は継続の調査は受け付けてもらえないのでしょうか？"></a>Q. 問い合わせのやりとりの中で、オンプレミス観点での調査が必要と伺いました。この場合は継続の調査は受け付けてもらえないのでしょうか？</h4><p>A. オンプレミス製品のご支援は Premier / Unified 契約、または一部のオンプレミス製品を対象としたサポート契約のみ承ることが可能です。</p><p>これらに該当しないサポート契約からのお問い合わせの場合、調査の過程の中でオンプレミス観点での調査やご案内が必要と判明した際は、それ以上のご支援を承ることができません。</p><blockquote><p><strong>(例) Azure AD Connect でオンプレミスから Azure AD に同期を構成している環境で、大量の同期ユーザーの削除が発生した。Azure AD Connect の観点で調査を承ったものの、ユーザーの削除はオンプレミス側で発生していることを確認した</strong><br>→ この場合は、オンプレミス側でユーザーの削除が行われたことが起因した事象となるため、オンプレミス観点での調査が必要となります。</p></blockquote><h4 id="Q-問い合わせのやりとりの中で、別製品-オンプレミスではない-での調査が必要と伺いました。この場合は継続の調査は受け付けてもらえないのでしょうか？"><a href="#Q-問い合わせのやりとりの中で、別製品-オンプレミスではない-での調査が必要と伺いました。この場合は継続の調査は受け付けてもらえないのでしょうか？" class="headerlink" title="Q. 問い合わせのやりとりの中で、別製品 (オンプレミスではない) での調査が必要と伺いました。この場合は継続の調査は受け付けてもらえないのでしょうか？"></a>Q. 問い合わせのやりとりの中で、別製品 (オンプレミスではない) での調査が必要と伺いました。この場合は継続の調査は受け付けてもらえないのでしょうか？</h4><p>A. 複数製品が関連した事象に関するお問い合わせについては、Premier / Unified 契約のみ承ることが可能です。</p><p>例を挙げて解説します。</p><p>たとえば、「条件付きアクセスの準拠済みポリシーを構成したところ、特定の端末からのアクセスがブロックされる」というお問い合わせがあったとします。この場合、まずは Azure AD の担当が、なぜブロックが行われたのか調査を行います。調査の結果、条件付きアクセスの準拠済みポリシーによってアクセスがブロックされている場合は、対象の端末が準拠済みであるかどうかを確認します。そして、もし対象の端末が準拠済みとなっていない状態であれば、条件付きアクセスでブロックされることは想定された動作となります。Azure AD 担当からのご支援は以上となります。そして、なぜ対象の端末が準拠済みとなっていないのかの調査は、Microsoft Endpoint Manager (Intune) サポートにて承ることになります。</p><p>このように、1 つの事象に対して複数の製品 (Azure AD と Intune) が関連する場合は、Premier / Unified 契約以外の場合は、異なる製品の対応が必要と判明した時点で、お客様に Azure AD と Intune それぞれでお問い合わせを発行いただく必要があります。もちろん、”異なる製品側” のサポート契約をお客様がお持ちでない場合はサポートを承ることはできませんので、この点はご注意ください。</p><p>Premier / Unified 契約の場合は、このように異なる製品の対応が必要となった場合でもサポート内部で連携を行い、スムーズにお客様にご支援を提供できるように対応します。たとえば、各サービスに依存する事象ではあるものの、Azure AD とその他製品の双方の動作や仕様を考慮してご案内を差し上げる必要があるといった場合においてサポート内部で担当者間の連携を緊密に行った上でご支援します。(Premier / Unified 契約の場合でも、お問い合わせの番号自体は各サービス / 製品に応じて発行していただくことになります)</p><br><h2 id="▼-サポート契約・ライセンスについて"><a href="#▼-サポート契約・ライセンスについて" class="headerlink" title="▼ サポート契約・ライセンスについて"></a>▼ サポート契約・ライセンスについて</h2><h4 id="Q-サポート契約がない場合でも支援してもらうことは可能ですか？"><a href="#Q-サポート契約がない場合でも支援してもらうことは可能ですか？" class="headerlink" title="Q. サポート契約がない場合でも支援してもらうことは可能ですか？"></a>Q. サポート契約がない場合でも支援してもらうことは可能ですか？</h4><p>A. サポート契約がない場合は支援をご提供することができません。</p><p>サポート契約をお持ちでない場合は、Azure ポータルから「サブスクリプションの管理」と「課金」のカテゴリを選択いただけますが、ここで案内可能なお問い合わせは、これらのカテゴリに関するものだけですので、Azure AD を含む技術的なお問い合わせを承ることはできません。上記のカテゴリを選択の上 Azure の技術的な質問をいただいた場合は、基本的にご支援をお断りさせていただいておりますのでご了承ください。</p><p>サポート契約の購入を検討されている場合は、<a href="https://azure.microsoft.com/ja-jp/support/plans/">Azure のサポート プランの比較 | Microsoft Azure</a> からご希望に沿ったサポート プランを検討いただければ幸いです。</p><p><img src="/blog/azure-active-directory/support-Q&A/support-request.png"></p><h4 id="Q-ライセンスの種類に関する問い合わせは-Azure-サポートで対応可能ですか？"><a href="#Q-ライセンスの種類に関する問い合わせは-Azure-サポートで対応可能ですか？" class="headerlink" title="Q. ライセンスの種類に関する問い合わせは Azure サポートで対応可能ですか？"></a>Q. ライセンスの種類に関する問い合わせは Azure サポートで対応可能ですか？</h4><p>A. 原則はライセンスの代理店にご相談ください。</p><p>お客様が利用を検討されている Azure AD の特定の機能に対するライセンス要否といった質問には、Azure 技術サポートにてご案内が可能です。一方、お客様の運用方針に沿った必要なライセンスのコンサルティングなどの支援は承ることができません。</p><p>ライセンスの購入方法や課金などのお問い合わせについては、貴社担当営業 または ライセンスの代理店 (貴社パートナー) にご相談ください。<br>マイクロソフトのパートナーとして、パートナー ネットワークに登録されているお客様からのライセンスの質問については、無償の窓口となる <a href="https://partner.microsoft.com/ja-jp/support/call-center">パートナー コールセンター</a> にお問い合わせください。</p><p>上記内容が参考となりましたら幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure &amp;amp; Identity サポート チームの関口です。&lt;/p&gt;
&lt;p&gt;今回は、Azure AD サポート窓口の対応に関する Q ＆ A をおまとめしました。&lt;br&gt;本記事は Azure ＆ Identity (Azure AD) サポートを念頭に</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>条件付きアクセスで 「準拠済み」 でブロックされる場合の対処法 (iOS / Android 編)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/conditional-access-compliant-ios-android/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/conditional-access-compliant-ios-android/</id>
    <published>2021-02-18T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.143Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure &amp; Identity サポート チームの関口です。</p><p>今回は、ご利用の端末が 「準拠済み」にもかかわらず、条件付きアクセスの「準拠済み」の設定でブロックされてしまった場合の原因と対処方法をご紹介します。</p><p>&lt;エラー コード例&gt;</p><blockquote><p>“errorCode”: 53000, “failureReason”: “Device is not in required device state: {state}. Conditional Access policy requires a compliant device, and the device is not compliant. The user must enroll their device with an approved MDM provider like Intune.”, “additionalDetails”: “Your administrator might have configured a conditional access policy that allows access to your organization’s resources only from compliant devices. To be compliant, your device must be either joined to your on-premises Active Directory or joined to your Azure Active Directory.            More details available at <a href="https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation">https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation</a></p></blockquote><blockquote><p>“errorCode”: 530003, “failureReason”: “Your device is required to be managed to access this resource.”<br>“additionalDetails”: “The requested resource can only be accessed using a compliant device. The user is either using a device not managed by a Mobile-Device-Management (MDM) agent like Intune, or it’s using an application that doesn’t support device authentication. The user could enroll their devices with an approved MDM provider, or use a different app to sign in, or find the app vendor and ask them to update their app. More details available at <a href="https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation">https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation</a></p></blockquote><br><h2 id="lt-なぜブロックされるのか？-gt"><a href="#lt-なぜブロックされるのか？-gt" class="headerlink" title="&lt;なぜブロックされるのか？&gt;"></a>&lt;なぜブロックされるのか？&gt;</h2><p>条件付きアクセスの「準拠済み」の設定は、デバイス ベースのアクセス制御となるため、”どの端末からのアクセスか？” を Azure AD が判断する必要があります。この判断のために、ご利用のデバイスは Azure AD に対して ”デバイス情報” を提示する必要があります。</p><p>ご利用の端末がデバイス情報を Azure AD に提示できない場合、Azure AD は ”どの端末からのアクセスか？” を判断することができません。つまり「準拠済み」であるかも判断することができず、ブロックされてしまいます。<br>ブロックされたアクセスをサインイン ログで確認すると、以下のようにデバイス ID の情報が表示されていないことがわかります。</p><p><img src="/blog/azure-active-directory/conditional-access-compliant-ios-android/deviceid-not-displayed.png"></p><br><p>ご利用の端末の状況に応じて、以下の二つの観点で確認を行うのがスムーズです。</p><p><strong>”デバイス情報を提示できているかどうか”</strong><br><strong>”デバイス情報を提示できていない場合は、なぜ提示できていないのか”</strong></p><br><h2 id="lt-対処方法-gt"><a href="#lt-対処方法-gt" class="headerlink" title="&lt;対処方法&gt;"></a>&lt;対処方法&gt;</h2><p>iOS / Android でデバイス情報が提示できない原因としては、以下が挙げられます。<br>それぞれの項目ごとに解説します。</p><table><thead><tr><th>No.</th><th>確認ポイント</th></tr></thead><tbody><tr><td>A</td><td>準拠済み？</td></tr><tr><td>B</td><td>サポートされたブラウザーを使用している？</td></tr><tr><td>C</td><td>Edge Chromium を使用している場合、ブラウザーにサインインできている？</td></tr><tr><td>D</td><td>旧 Edge を利用している場合</td></tr><tr><td>E</td><td>証明書を提示できていない</td></tr><tr><td>F</td><td>Microsoft Authenticator をインストールしていない</td></tr><tr><td>G</td><td>アプリの実装によりデバイス情報を提示できないこともある</td></tr><tr><td>H</td><td>その他</td></tr></tbody></table><br><h2 id="A-準拠済み？"><a href="#A-準拠済み？" class="headerlink" title="A. 準拠済み？"></a>A. 準拠済み？</h2><p>利用している端末が準拠済みとなっているかを確認します。<br>Azure Portal のデバイス一覧で、対象の端末の「準拠している」の列が「はい」にセットされていれば OK です。</p><p><img src="/blog/azure-active-directory/conditional-access-compliant-ios-android/compliant-set.png"></p><p>対象の端末が準拠していない場合は、Microsoft Endpoint Manager (Intune) の観点で、なぜ準拠済みとならないのかを調査する必要があります。</p><br><h2 id="B-サポートされたブラウザーを使用している？"><a href="#B-サポートされたブラウザーを使用している？" class="headerlink" title="B. サポートされたブラウザーを使用している？"></a>B. サポートされたブラウザーを使用している？</h2><p>OS によってサポートされるブラウザーは異なるため、以下の公開情報を元にご利用のブラウザーがサポートされているかご確認をお願いします。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-conditions#supported-browsers">サポートされているブラウザー - Azure Active Directory | Microsoft Docs</a></p><br><h2 id="C-Edge-Chromium-を使用している場合、ブラウザーにサインインしている？"><a href="#C-Edge-Chromium-を使用している場合、ブラウザーにサインインしている？" class="headerlink" title="C. Edge Chromium を使用している場合、ブラウザーにサインインしている？"></a>C. Edge Chromium を使用している場合、ブラウザーにサインインしている？</h2><p>Microsoft Edge Chromium を利用してデバイス情報を提示するためには、ブラウザーにサインインしている必要があります。</p><p><a href="https://docs.microsoft.com/ja-jp/deployedge/ms-edge-security-conditional-access">Microsoft Edge と条件付きアクセス - Azure Active Directory | Microsoft Docs</a></p><blockquote><p>エンタープライズ Azure AD 資格情報を使用して Microsoft Edge プロファイルにサインインすると、条件付きアクセスを使用して保護されたエンタープライズ クラウド リソースへのシームレスなアクセスが、Microsoft Edge によって許可されます。</p></blockquote><p>なお、旧 Edge (Microsoft Edge HTML) の場合は、プロファイルにサインインを行う機能はありません。あくまで Microsoft Edge Chromium をご利用の場合の確認となります。</p><br><h2 id="D-旧-Edge-を利用している場合"><a href="#D-旧-Edge-を利用している場合" class="headerlink" title="D. 旧 Edge を利用している場合"></a>D. 旧 Edge を利用している場合</h2><p>旧 Edge (Microsoft Edge HTML) を使用している場合、デバイス情報を Azure AD に適切に提示できない場合があることを確認しています。残念ながら、Microsoft Edge HTML は既に開発が終了しており、2021 年 3 月 9 日 にサポートが終了することが予定されているため、Microsoft Edge Chromium を利用いただくことを推奨しています。</p><br><h2 id="E-証明書を提示できていない"><a href="#E-証明書を提示できていない" class="headerlink" title="E. 証明書を提示できていない"></a>E. 証明書を提示できていない</h2><p>iOS / Android がデバイス情報を提示する仕組みは、ブラウザー アクセスの場合と、クライアント アプリの場合で異なります。</p><p>ブラウザー アクセスの場合は、iOS も Android も Azure AD に証明書を提示することでデバイス情報を渡します。<br>Android の場合、以下のように端末内に保持している証明書一覧が表示されて、どの証明書を使用するのか促されます。(既に使用する証明書が決まっていると判断されれば促されない場合もあります)<br>ここで適切な証明書を選択すれば、証明書の中に保存されているデバイス情報を提示し、Azure AD でデバイス ベースの条件付きアクセスの制御が可能となります。</p><p><img src="/blog/azure-active-directory/conditional-access-compliant-ios-android/device-cert.png"></p><p>なお、ここで使用する証明書 (上記画面の証明書) は、Microsoft Endpoint Manager (Intune) ポータル サイトからインストール可能です。以下の公開情報をご参照の上、記載された画面と同様のメッセージが表示されている状況であれば、本公開情報の「ブラウザー アクセスを有効にする」手順をお試しください。</p><p><a href="https://docs.microsoft.com/ja-jp/mem/intune/user-help/your-device-is-missing-an-it-required-certificate-android">不足している必要な証明書をインストールする | Microsoft Docs</a></p><p>iOS の場合、Intune によるプロファイル設定が行われる際に証明書もあわせてインストールされるはずです。<br>iOS の [プロファイルとデバイス管理] から、Intune 用のプロファイルが既に設定されているかご確認ください。</p><p><img src="/blog/azure-active-directory/conditional-access-compliant-ios-android/device-profile1.png"></p><p><img src="/blog/azure-active-directory/conditional-access-compliant-ios-android/device-profile2.png"></p><p>iOS / Android を使用したブラウザー アクセスは、上記のように証明書を使用したデバイス情報の提示が可能となります。</p><p>一方で、モバイル アプリ (クライアント アプリ) の場合は、Microsoft Authenticator を使用して PRT を Azure AD に提示する必要があります。詳細は 「F. Microsoft Authenticator をインストールしていない」で説明します。</p><br><h2 id="F-Microsoft-Authenticator-をインストールしていない"><a href="#F-Microsoft-Authenticator-をインストールしていない" class="headerlink" title="F. Microsoft Authenticator をインストールしていない"></a>F. Microsoft Authenticator をインストールしていない</h2><p>iOS / Android を使用してモバイル アプリ (ネイティブ アプリ) にアクセスする際は、基本的に Microsoft Authenticator を使用して PRT を Azure AD に提示する必要があります。アプリの実装によっては、ブラウザーを経由してデバイス情報を提示する場合もあるため、その場合は Microsoft Authenticator  を用いずにデバイス情報を提示可能です。</p><p>以下は iPad を使用した動作サンプルとなりますが、こちらを見ていただくと Microsoft Authenticator を使用してデバイス情報を提示するシナリオのイメージが湧くかと思います。</p><p>Microsoft Teams のモバイル アプリにサインインするために資格情報を入力すると、パスワード入力画面に遷移しています。画面左上に Teams の表示がありますが、これは Microsoft Teams が呼び出した画面ではないことがわかります。なぜなら、このパスワード入力画面が Microsoft Teams が呼び出した画面であれば、画面左側に Teams への切り替えを促す表示は出ないからです。</p><p><img src="/blog/azure-active-directory/conditional-access-compliant-ios-android/authenticator-screen1.png"></p><p>実際に、起動アプリを確認すると Microsoft Authenticator がパスワード入力画面を呼び出していることが確認できます。</p><p><img src="/blog/azure-active-directory/conditional-access-compliant-ios-android/authenticator-screen2.png"></p><p>このことから、Microsoft Teams から Microsoft Authenticator にリダイレクトされ、この動作でパスワード入力、および PRT を Azure AD に渡しているように思われます。</p><p>※ なお、Android の場合は、このような画面遷移が行われていることを明示的に確認できませんが、同様の動作が行われているとお考えください。</p><br><h2 id="G-アプリの実装によりデバイス情報を提示できないこともある"><a href="#G-アプリの実装によりデバイス情報を提示できないこともある" class="headerlink" title="G. アプリの実装によりデバイス情報を提示できないこともある"></a>G. アプリの実装によりデバイス情報を提示できないこともある</h2><p>3rd Party 製のアプリケーションの場合、デバイス情報を直接 Azure AD に提示できるような実装か、Microsoft Authenticator 経由で提示できるように実装されている必要があります。3rd Party 製のアプリケーションでこのような実装が行われているかどうかは、アプリケーション ベンダーに直接ご確認いただく必要があります。</p><p>基本的に、Microsoft 製のアプリケーションは Microsoft Authenticator を使用してデバイス情報を提示するとお考え下さい。(Outlook などは Microsoft Authenticator を使用しなくてもデバイス情報を提示できるシナリオがあることを確認していますが、基本的には Microsoft Authenticator が使用されるとお考えください)</p><p>なお、モバイル デバイスに Microsoft Authenticator をインストールするだけでは不十分で、アプリケーション側が Microsoft Authenticator を使用するように実装がされている必要があります。上記の動作については、以下のアプリケーション開発者用の公開情報に記載がありますのでご参照ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/scenario-mobile-app-configuration#configure-the-application-to-use-the-broker">ブローカーを使用するようにアプリケーションを構成する - Azure Active Directory | Microsoft Docs</a></p><p>こちらは iOS / Android 端末を利用時の場合の説明となりますが、Windows 端末を使用する場合も類似の動作があります。Windows 10 端末上のデスクトップ アプリ (ネイティブ アプリ) を使用してアプリケーションにアクセスする場合、Microsoft Authenticator ではなく、Web Account Manager (WAM) と呼ばれる Windows 10 に既定で実装されているトークン ブローカーを使用して PRT を Azure AD に提示します。</p><p>Microsoft のアプリケーションは基本的に WAM に対応しているため問題ありませんが、3rd Party 製のアプリケーションは WAM に対応した実装となっていないことが考えられ、PRT を提示できないことが想定されます。こちらも正確な実装はアプリケーション ベンダーに確認いただく必要がありますが、このような動作処理が行われるために、Azure AD 側でデバイスを判断できない結果になることがあります。</p><br><h2 id="H-その他"><a href="#H-その他" class="headerlink" title="H. その他"></a>H. その他</h2><p>その他サポート チームで確認できている事象や仕様についてです。</p><p>・ 3rd Party 製品によってデバイス情報が提示できない</p><p>クライアント端末から Azure AD にデバイス情報を提示する経路上に、プロキシなど一部 3rd Party 製品の動作 (仕様) によって、デバイス情報が提示できない場合があることを確認しております。<br>もし切り分けの結果、ご利用の 3rd Party 製品を経由する場合のみ事象が発生するということであれば、該当のベンダーに確認のお問い合わせをいただければと思います。</p><br><h2 id="関連ブログ"><a href="#関連ブログ" class="headerlink" title="関連ブログ"></a>関連ブログ</h2><p><a href="https://jpazureid.github.io/blog/azure-active-directory/conditional-access-compliant-windows">Japan Azure Identity Support Blog: 条件付きアクセスで 「準拠済み」 や 「Hybrid Azure AD 参加が必要」 でブロックされる場合の対処法 (Windows 編)</a></p><p>上記内容が少しでも参考となれば幸いです。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひサポートサービスまでお問い合わせください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure &amp;amp; Identity サポート チームの関口です。&lt;/p&gt;
&lt;p&gt;今回は、ご利用の端末が 「準拠済み」にもかかわらず、条件付きアクセスの「準拠済み」の設定でブロックされてしまった場合の原因と対処方法をご紹介します。&lt;/p&gt;
&lt;p&gt;&amp;lt;エラ</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Conditional Access" scheme="https://jpazureid.github.io/blog/tags/Conditional-Access/"/>
    
    <category term="Compliant" scheme="https://jpazureid.github.io/blog/tags/Compliant/"/>
    
  </entry>
  
  <entry>
    <title>条件付きアクセスで「準拠済み」や「Hybrid Azure AD 参加が必要」でブロックされる場合の対処法 (Windows 編)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/conditional-access-compliant-windows/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/conditional-access-compliant-windows/</id>
    <published>2021-02-18T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.147Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure &amp; Identity サポート チームの関口です。</p><p>今回は、ご利用の端末が 「準拠済み」もしくは「Hybrid Azure AD 参加を構成済み」にもかかわらず、条件付きアクセスの「準拠済み」や「Hybrid Azure AD 参加が必要」の設定でブロックされてしまった場合の原因と対処方法をご紹介します。</p><p>&lt;エラー コード例&gt;</p><blockquote><p>“errorCode”: 53000, “failureReason”: “Device is not in required device state: {state}. Conditional Access policy requires a compliant device, and the device is not compliant. The user must enroll their device with an approved MDM provider like Intune.”, “additionalDetails”: “Your administrator might have configured a conditional access policy that allows access to your organization’s resources only from compliant devices. To be compliant, your device must be either joined to your on-premises Active Directory or joined to your Azure Active Directory.            More details available at <a href="https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation">https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation</a></p></blockquote><blockquote><p>“errorCode”: 530003, “failureReason”: “Your device is required to be managed to access this resource.”<br>“additionalDetails”: “The requested resource can only be accessed using a compliant device. The user is either using a device not managed by a Mobile-Device-Management (MDM) agent like Intune, or it’s using an application that doesn’t support device authentication. The user could enroll their devices with an approved MDM provider, or use a different app to sign in, or find the app vendor and ask them to update their app. More details available at <a href="https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation">https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation</a></p></blockquote><br><h2 id="lt-なぜブロックされるのか？-gt"><a href="#lt-なぜブロックされるのか？-gt" class="headerlink" title="&lt;なぜブロックされるのか？&gt;"></a>&lt;なぜブロックされるのか？&gt;</h2><p>条件付きアクセスの「準拠済み」と「Hybrid Azure AD 参加が必要」の設定は、デバイス ベースのアクセス制御となるため、”どの端末からのアクセスか？” を Azure AD が判断する必要があります。この判断のために、ご利用のデバイスは Azure AD に対して ”デバイス情報” を提示する必要があります。</p><p>ご利用の端末がデバイス情報を Azure AD に提示できない場合、Azure AD は ”どの端末からのアクセスか？” を判断することができません。つまり「準拠済み」であるかも「Hybrid Azure AD 参加を構成済み」であるかも判断することができず、ブロックされてしまいます。<br>ブロックされたアクセスをサインイン ログで確認すると、以下のようにデバイス ID の情報が表示されていないことがわかります。</p><p><img src="/blog/azure-active-directory/conditional-access-compliant-windows/deviceid-not-displayed.png"></p><br><p>ご利用の端末の状況に応じて、以下の二つの観点で確認を行うのがスムーズです。</p><p><strong>”デバイス情報を提示できているかどうか”</strong><br><strong>”デバイス情報を提示できていない場合は、なぜ提示できていないのか”</strong></p><br><h2 id="lt-対処方法-gt"><a href="#lt-対処方法-gt" class="headerlink" title="&lt;対処方法&gt;"></a>&lt;対処方法&gt;</h2><p>Windows でデバイス情報が提示できない原因としては、以下が挙げられます。<br>それぞれの項目ごとに解説します。</p><table><thead><tr><th>No.</th><th>確認ポイント</th></tr></thead><tbody><tr><td>A</td><td>Hybrid Azure AD 参加が構成済み？</td></tr><tr><td>B</td><td>準拠済み？</td></tr><tr><td>C</td><td>PRT 取得済み？</td></tr><tr><td>D</td><td>サポートされたブラウザーを使用している？</td></tr><tr><td>E</td><td>Chrome を使用している場合、Windows 10 Accounts 拡張機能をインストールしている？</td></tr><tr><td>F</td><td>Edge Chromium を使用している場合、ブラウザーにサインインできている？</td></tr><tr><td>G</td><td>旧 Edge を利用している場合</td></tr><tr><td>H</td><td>アプリの実装によりデバイス情報を提示できないこともある</td></tr><tr><td>I</td><td>その他</td></tr></tbody></table><br><h2 id="A-Hybrid-Azure-AD-参加が構成済み？"><a href="#A-Hybrid-Azure-AD-参加が構成済み？" class="headerlink" title="A. Hybrid Azure AD 参加が構成済み？"></a>A. Hybrid Azure AD 参加が構成済み？</h2><p>利用している端末が Hybrid Azure AD 参加構成済みとなっているかを確認します。<br>Azure Portal のデバイス一覧で、対象の端末の「登録済み」の列に登録日時がセットされていれば OK です。</p><p><img src="/blog/azure-active-directory/conditional-access-compliant-windows/registered-set.png"></p><p>構成が完了していない場合は、「登録済み」の列に「保留中」と表示がされることになります。この場合は、まずは Hybrid Azure AD 参加の構成を完了させることから始めてください。<br>(ここでは、Hybrid Azure AD 参加の構成方法は割愛します)</p><br><h2 id="B-準拠済み？"><a href="#B-準拠済み？" class="headerlink" title="B. 準拠済み？"></a>B. 準拠済み？</h2><p>利用している端末が準拠済みとなっているかを確認します。<br>Azure Portal のデバイス一覧で、対象の端末の「準拠している」の列が「はい」にセットされていれば OK です。</p><p><img src="/blog/azure-active-directory/conditional-access-compliant-windows/compliant-set.png"></p><p>対象の端末が準拠していない場合は、Microsoft Endpoint Manager (Intune) の観点で、なぜ準拠済みとならないのかを調査する必要があります。</p><br><h2 id="C-PRT-取得済み？"><a href="#C-PRT-取得済み？" class="headerlink" title="C. PRT 取得済み？"></a>C. PRT 取得済み？</h2><p>[A. Hybrid Azure AD 参加が構成済み？] で Hybrid Azure AD 参加が構成済み、もしくは [B. 準拠済み？] で 準拠済み となっていても、Primary Refresh Token (PRT) を取得できていないと Azure AD にデバイス情報を提示することができません。</p><p>PRT の中にはデバイス情報が含まれており、Azure AD 側が、どの端末からのアクセスなのかを判断するために使用されます。そのため、ご利用の端末で正常に PRT を取得できているか確認してください。<br>以下のコマンドの実行結果で [AzureAdPrt : NO] となっている場合は、PRT が取得できていないことになります。</p><p>dsregcmd /status</p><pre><code>+------- SSO State -------+            AzureAdPrt : NO   AzureAdPrtAuthority : NO         EnterprisePrt : NOEnterprisePrtAuthority : NO</code></pre><p>この場合は、なぜ PRT が取得できていないのか？という観点で調査を行う必要があります。<br>PRT が取得できない場合の対処方法としては、以下の記事をご参考ください。また、サポートによる支援も可能ですので、ご希望の場合はお問い合わせください。</p><p><a href="/blog/azure-active-directory/troubleshoot-hybrid-azure-ad-join-managed/">Hybrid Azure AD Join 失敗時の初動調査方法について (マネージド編) | Japan Azure Identity Support Blog</a>)<br><a href="/blog/azure-active-directory/troubleshoot-hybrid-azure-ad-join-federated/">Hybrid Azure AD Join 失敗の初動調査方法について (フェデレーション編) | Japan Azure Identity Support Blog</a>)</p><br><h2 id="D-サポートされたブラウザーを使用している？"><a href="#D-サポートされたブラウザーを使用している？" class="headerlink" title="D. サポートされたブラウザーを使用している？"></a>D. サポートされたブラウザーを使用している？</h2><p>OS によってサポートされるブラウザーは異なるため、以下の公開情報を元にご利用のブラウザーがサポートされているかご確認をお願いします。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-conditions#supported-browsers">サポートされているブラウザー - Azure Active Directory | Microsoft Docs</a></p><br><h2 id="E-Chrome-を使用している場合、Windows-10-Accounts-拡張機能をインストールしている？"><a href="#E-Chrome-を使用している場合、Windows-10-Accounts-拡張機能をインストールしている？" class="headerlink" title="E. Chrome を使用している場合、Windows 10 Accounts 拡張機能をインストールしている？"></a>E. Chrome を使用している場合、Windows 10 Accounts 拡張機能をインストールしている？</h2><p>Windows 10 バージョン 1703 以降で Chrome を利用してデバイス情報を提示するためには、Windows 10 Accounts 拡張機能をインストールする必要があります。Chrome をご利用の場合は、以下の公開情報の案内に沿ってインストールが可能です。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-conditions#chrome-support">Chrome のサポート - Azure Active Directory | Microsoft Docs</a></p><blockquote><p>Windows 10 Creators Update (バージョン 1703) 以降で Chrome をサポートするには、Windows 10 Accounts 拡張機能をインストールしてください。 条件付きアクセス ポリシーでデバイス固有の詳細が必要な場合は、この拡張機能が必要です。</p></blockquote><br><h2 id="F-Edge-Chromium-を使用している場合、ブラウザーにサインインしている？"><a href="#F-Edge-Chromium-を使用している場合、ブラウザーにサインインしている？" class="headerlink" title="F. Edge Chromium を使用している場合、ブラウザーにサインインしている？"></a>F. Edge Chromium を使用している場合、ブラウザーにサインインしている？</h2><p>Microsoft Edge Chromium を利用してデバイス情報を提示するためには、ブラウザーにサインインしている必要があります。</p><p><a href="https://docs.microsoft.com/ja-jp/deployedge/ms-edge-security-conditional-access">Microsoft Edge と条件付きアクセス - Azure Active Directory | Microsoft Docs</a></p><blockquote><p>エンタープライズ Azure AD 資格情報を使用して Microsoft Edge プロファイルにサインインすると、条件付きアクセスを使用して保護されたエンタープライズ クラウド リソースへのシームレスなアクセスが、Microsoft Edge によって許可されます。</p></blockquote><p>なお、旧 Edge (Microsoft Edge HTML) の場合は、プロファイルにサインインを行う機能はありません。あくまで Microsoft Edge Chromium をご利用の場合の確認となります。</p><br><h2 id="G-旧-Edge-を利用している場合"><a href="#G-旧-Edge-を利用している場合" class="headerlink" title="G. 旧 Edge を利用している場合"></a>G. 旧 Edge を利用している場合</h2><p>旧 Edge (Microsoft Edge HTML) を使用している場合、デバイス情報を Azure AD に適切に提示できない場合があることを確認しています。残念ながら、Microsoft Edge HTML は既に開発が終了しており、2021 年 3 月 9 日 にサポートが終了することが予定されているため、Microsoft Edge Chromium を利用いただくことを推奨しています。</p><br><h2 id="H-アプリの実装によりデバイス情報を提示できないこともある"><a href="#H-アプリの実装によりデバイス情報を提示できないこともある" class="headerlink" title="H. アプリの実装によりデバイス情報を提示できないこともある"></a>H. アプリの実装によりデバイス情報を提示できないこともある</h2><p>3rd Party 製のアプリケーションの場合、デバイス情報を直接 Azure AD に提示できるような実装か、Microsoft Authenticator 経由で提示できるように実装されている必要があります。3rd Party 製のアプリケーションでこのような実装が行われているかどうかは、アプリケーション ベンダーに直接ご確認いただく必要があります。</p><p>基本的に、Microsoft 製のアプリケーションは Microsoft Authenticator を使用してデバイス情報を提示するとお考え下さい。(Outlook などは Microsoft Authenticator を使用しなくてもデバイス情報を提示できるシナリオがあることを確認していますが、基本的には Microsoft Authenticator が使用されるとお考えください)</p><p>なお、モバイル デバイスに Microsoft Authenticator をインストールするだけでは不十分で、アプリケーション側が Microsoft Authenticator を使用するように実装がされている必要があります。上記の動作については、以下のアプリケーション開発者用の公開情報に記載がありますのでご参照ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/scenario-mobile-app-configuration#configure-the-application-to-use-the-broker">ブローカーを使用するようにアプリケーションを構成する - Azure Active Directory | Microsoft Docs</a></p><p>こちらは iOS / Android 端末を利用時の場合の説明となりますが、Windows 端末を使用する場合も類似の動作があります。Windows 10 端末上のデスクトップ アプリ (ネイティブ アプリ) を使用してアプリケーションにアクセスする場合、Microsoft Authenticator ではなく、Web Account Manager (WAM) と呼ばれる Windows 10 に既定で実装されているトークン ブローカーを使用して PRT を Azure AD に提示します。</p><p>Microsoft のアプリケーションは基本的に WAM に対応しているため問題ありませんが、3rd Party 製のアプリケーションは WAM に対応した実装となっていないことが考えられ、PRT を提示できないことが想定されます。こちらも正確な実装はアプリケーション ベンダーに確認いただく必要がありますが、このような動作処理が行われるために、Azure AD 側でデバイスを判断できない結果になることがあります。</p><br><h2 id="I-その他"><a href="#I-その他" class="headerlink" title="I. その他"></a>I. その他</h2><p>その他サポート チームで確認できている事象や仕様についてです。</p><p>・ 3rd Party 製品によってデバイス情報が提示できない</p><p>クライアント端末から Azure AD にデバイス情報を提示する経路上に、プロキシなど一部 3rd Party 製品の動作 (仕様) によって、デバイス情報が提示できない場合があることを確認しております。<br>もし切り分けの結果、ご利用の 3rd Party 製品を経由する場合のみ事象が発生するということであれば、該当のベンダーに確認のお問い合わせをいただければと思います。</p><br><h2 id="関連ブログ"><a href="#関連ブログ" class="headerlink" title="関連ブログ"></a>関連ブログ</h2><p><a href="https://jpazureid.github.io/blog/azure-active-directory/conditional-access-compliant-ios-android">Japan Azure Identity Support Blog: 条件付きアクセスで「準拠済み」でブロックされる場合の対処法 (iOS / Android 編)</a></p><p>上記内容が少しでも参考となれば幸いです。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひサポートサービスまでお問い合わせください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure &amp;amp; Identity サポート チームの関口です。&lt;/p&gt;
&lt;p&gt;今回は、ご利用の端末が 「準拠済み」もしくは「Hybrid Azure AD 参加を構成済み」にもかかわらず、条件付きアクセスの「準拠済み」や「Hybrid Azure AD </summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Conditional Access" scheme="https://jpazureid.github.io/blog/tags/Conditional-Access/"/>
    
    <category term="Hybrid Azure AD Join" scheme="https://jpazureid.github.io/blog/tags/Hybrid-Azure-AD-Join/"/>
    
    <category term="Compliant" scheme="https://jpazureid.github.io/blog/tags/Compliant/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD Connect をご利用のお客様に対して予定されている多要素認証に関する変更</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/</id>
    <published>2021-02-17T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.311Z</updated>
    
    <content type="html"><![CDATA[<p>皆さんこんにちは。Azure &amp; Identity サポート チームの高田です。</p><p>本日は Azure AD Connect を利用しオンプレミス AD から Azure AD にユーザーを同期しているお客様において影響が生じる可能性のある多要素認証の動作変更についてお知らせいたします。この内容は、<a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/ba-p/1994722">Azure Active Directory Identity Blog</a> で公開されたものであり、本記事ではその内容についてより分かりやすく解説いたします。</p><h2 id="影響を受ける可能性のあるお客様"><a href="#影響を受ける可能性のあるお客様" class="headerlink" title="影響を受ける可能性のあるお客様"></a>影響を受ける可能性のあるお客様</h2><p>本記事で解説する内容で影響を受ける可能性があるのは、以下のすべての点に該当するお客様です。</p><ul><li>オンプレミス AD 上のユーザー属性に多要素認証用の電話番号を設定している。</li><li>Azure AD Connect などのアカウント同期ソリューションを利用してオンプレミス AD から Azure AD にユーザーを同期している。</li><li>管理者が PowerShell を用いて電話で多要素認証を行うようユーザー属性 (StrongAuthenticationMethods 属性) を変更をしている。</li></ul><p>上記のような状態は、ユーザーの多要素認証設定を管理者が行う場合に相当します。つまり、管理者が PowerShell を用いて多要素認証の方法 (電話番号を用いた認証）を指定し、認証に使用する電話番号はオンプレミス AD の属性から設定するという方法です。この方法をとると、ユーザーが自身で多要素認証をセットアップせずとも、管理者から多要素認証 (電話番号を用いた認証) を構成できます。</p><p>なお、Azure AD Connect などアカウント同期ソリューションを利用して電話番号を Azure AD に同期していても、管理者が各ユーザーに対して電話認証の利用を設定してない場合は本記事の影響を受けません。ただし、多要素認証用の電話番号について正しい運用方法を確認するため、いずれのお客様でも後述します対応内容をご覧いただくことをお勧めします。</p><h2 id="変更前の動作"><a href="#変更前の動作" class="headerlink" title="変更前の動作"></a>変更前の動作</h2><p>現在 Azure AD ユーザーは以下の 2 種類の電話番号を利用しています。</p><ul><li>パブリックな電話番号: ユーザーのプロファイルの一部として管理されている連絡先電話番号</li><li>認証用の電話番号: 他のユーザー (管理者を除く) からは参照できない認証専用の電話番号</li></ul><p>前述のとおり、本変更の影響を受ける可能性のあるお客様では、オンプレミス AD 上のユーザーが電話番号を保持しており、この電話番号が Azure AD Connect を利用することで Azure AD 上のユーザーにも同期される状態となります。このようにして同期された電話番号は、パブリックな電話番号として Azure AD 上に設定されます。つまり、Azure ポータルや Outlook のアドレス帳などから確認可能な電話番号として表示されます。</p><p>一方、認証用の電話番号は、ユーザーが多要素認証のセットアップを使用するか、管理者が認証方法のブレードなどを使用することで設定されます。これらの操作を明示的に行わない限りは、認証用の電話番号はユーザーに未設定の状態です。</p><p>現在の動作では、このようにして同期されたユーザーがパブリックな電話番号のみを持ち、さらに認証用の電話番号を保持していない状態で管理者が PowerShell から電話認証の利用を有効化した場合、条件付きアクセスで多要素認証が要求されると、ユーザーに設定されているパブリックな電話番号に電話認証が試行されます。つまり、Azure AD はユーザーの認証用の電話番号が未設定の場合は、代わりにパブリックな電話番号を使用して多要素認証を試行します。</p><table><thead><tr><th>パブリックな電話番号</th><th>認証用の電話番号</th></tr></thead><tbody><tr><td>携帯電話: +81 123456789</td><td>電話番号: (未設定)</td></tr><tr><td></td><td>認証方法 (StrongAuthenticationMethods): 電話認証</td></tr></tbody></table><p>例えば、ユーザーが上記のような属性を持つ状態の場合、認証用の電話番号には多要素認証の方法として電話認証の設定のみが行われており、多要素認証に使用する電話番号は設定されていません。しかしこの場合でも現状の動作では、ユーザーに多要素認証が求められるとパブリックな電話番号 (+81 123456789) が代わりに多要素認証に使用され、+81 123456789 に SMS などが送信されます。</p><h2 id="予定されている動作変更の内容"><a href="#予定されている動作変更の内容" class="headerlink" title="予定されている動作変更の内容"></a>予定されている動作変更の内容</h2><p>マイクロソフトでは、継続してユーザービリティとセキュリティに対する改善を進めており、その一環として Azure AD が保持する電話番号の扱いについてよりシンプルなモデルを採用することを検討しています。</p><p>今回予定されているのは、上記のようにパブリックな電話番号と認証方法 (電話認証) の設定を持つ一方で認証用の電話番号が未設定の同期ユーザーに対し、オンプレミス AD から同期されたパブリックな電話番号を認証用の電話番号にコピーするという対応です。また、パブリックな電話番号が認証用の電話番号にコピーされ認証用の電話番号が構成されると、Azure AD はそれ以降、認証用の電話番号に多要素認証を試行するように動作が変化します。つまり、パブリックな電話番号が代わりに多要素認証に使用されるという動作はなくなります。</p><table><thead><tr><th>パブリックな電話番号</th><th>認証用の電話番号</th></tr></thead><tbody><tr><td>携帯電話: +81 123456789</td><td>電話番号: +81 123456789 (パブリックな電話番号からコピー)</td></tr><tr><td></td><td>認証方法 (StrongAuthenticationMethods): 電話認証</td></tr></tbody></table><p>マイクロソフトでは、このように多要素認証には認証用の電話番号のみを使用する用動作を変更します。これに際し、上記条件に合致するお客様に影響が生じないようこのコピー処理を 5 月 1 日まで順次各テナントで実施します。ただし、コピー処理がいつどのタイミングで行われるかはデータセンター側での対応となり事前に確認することはできません。このためお客様におかれましては上記の変更についてご理解の上、速やかに後述する対応 (運用方法の変更) を実施くださいますようお願い申し上げます。</p><h2 id="動作変更に伴い必要となる対応"><a href="#動作変更に伴い必要となる対応" class="headerlink" title="動作変更に伴い必要となる対応"></a>動作変更に伴い必要となる対応</h2><p>以上の動作変更に伴い、多要素認証に使用する電話番号を現在オンプレミス AD 上で管理されているお客様においては、管理方法を変更いただく必要がございます。多要素認証に使用する電話番号を変更したい場合は、管理者がオンプレミス AD 上のユーザー属性 (電話番号) を変更するという方法ではなく、後述するいずれかの方法で認証用の電話番号を設定および更新するようご対応ください。</p><h3 id="Azure-ポータルからユーザーの「認証方法」ブレードを使用する"><a href="#Azure-ポータルからユーザーの「認証方法」ブレードを使用する" class="headerlink" title="Azure ポータルからユーザーの「認証方法」ブレードを使用する"></a>Azure ポータルからユーザーの「認証方法」ブレードを使用する</h3><p>管理者がユーザーの認証用電話番号を構成したい場合、Azure ポータルの Azure Active Directory ブレードから行うのが簡単です。Azure Active Directory ブレードより対象のユーザーを選択し、認証方法のブレードへお進みください。<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-userdevicesettings#add-authentication-methods-for-a-user">この方法</a> によりポータルの画面からユーザーの認証用電話番号を直接変更いただけます。</p><p><img src="/blog/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/bh1.png"></p><h3 id="Microsoft-Graph-API-の-authentication-methods-エンドポイントを使用する"><a href="#Microsoft-Graph-API-の-authentication-methods-エンドポイントを使用する" class="headerlink" title="Microsoft Graph API の authentication/methods エンドポイントを使用する"></a>Microsoft Graph API の authentication/methods エンドポイントを使用する</h3><p>管理者がユーザーの認証用電話番号を構成する方法としては、直接 <a href="https://docs.microsoft.com/ja-jp/graph/authenticationmethods-get-started">Microsoft Graph API の authentication/methods エンドポイント</a> を使用する方法もございます。API を直接操作したい場合は本方法をご利用ください。</p><p><img src="/blog/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/bh2.png"></p><h3 id="Microsoft-Graph-Identity-Signins-PowerShell-を使用する"><a href="#Microsoft-Graph-Identity-Signins-PowerShell-を使用する" class="headerlink" title="Microsoft.Graph.Identity.Signins PowerShell を使用する"></a>Microsoft.Graph.Identity.Signins PowerShell を使用する</h3><p>Microsoft Graph API を直接操作することが難しい場合は、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-userdevicesettings#manage-methods-using-powershell">Microsoft.Graph.Identity.Signins PowerShell コマンド</a> から同様の操作を実施いただけます。</p><p><img src="/blog/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/bh3.png"></p><h3 id="ユーザーが自ら-MyAccount-ページから設定する"><a href="#ユーザーが自ら-MyAccount-ページから設定する" class="headerlink" title="ユーザーが自ら MyAccount ページから設定する"></a>ユーザーが自ら MyAccount ページから設定する</h3><p>エンドユーザーが自ら認証用電話番号を構成することも可能です。この場合は、ユーザー自ら <a href="http://myaccount.microsoft.com/">MyAccount</a> にアクセスし、セキュリティ情報のタブから認証用電話番号を追加ください。</p><p><img src="/blog/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/bh4.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;皆さんこんにちは。Azure &amp;amp; Identity サポート チームの高田です。&lt;/p&gt;
&lt;p&gt;本日は Azure AD Connect を利用しオンプレミス AD から Azure AD にユーザーを同期しているお客様において影響が生じる可能性のある多要素認証の動</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="MFA" scheme="https://jpazureid.github.io/blog/tags/MFA/"/>
    
    <category term="Azure AD Connect" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-Connect/"/>
    
  </entry>
  
  <entry>
    <title>条件付きアクセスによりディレクトリ同期が失敗する場合の対処方法について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory-connect/directory-synchronization-accounts/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory-connect/directory-synchronization-accounts/</id>
    <published>2021-02-17T01:00:00.000Z</published>
    <updated>2021-07-01T00:10:32.919Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの田中です。</p><p> <br>今回は、比較的多くのお客様からお問い合わせをいただく、条件付きアクセスの利用を開始した環境において、ディレクトリ同期が失敗するという事象の対処方法の一例を紹介します。 </p><p><strong>読者のターゲット</strong> : テナントのグローバル管理者。条件付きアクセスおよび Azure AD Connect を操作できることが前提となります。 </p><p>Azure AD Connect は、オンプレミス AD から Azure AD に情報を同期するため、Azure AD 側に Azure AD コネクタ アカウントと呼ばれる (既定では UPN が “Sync_” から始まるアカウント)、Azure AD Connect が同期に使用するための専用アカウントがあります。   </p><p>この Azure AD コネクタ アカウントが条件付きアクセスでブロックされると、Azure AD Connect によるディレクトリ同期が行われなくなります。 </p><p>そのため、Azure AD 側では、Azure AD コネクタ アカウントが条件付きアクセスでブロックされないように、本アカウントを意味する “ディレクトリ同期アカウント” というロールを個別に用意し、条件付きアクセスの適用対象外ロールとして選択できるようになっています。 </p><p>具体的には、お客様環境における条件付きアクセス ポリシーにて、下記の手順をもとにディレクトリロールの観点で設定を行います。</p><h2 id="条件付きアクセスの適用「対象外」に-Azure-AD-コネクタ-アカウントのディレクトリ-ロールを指定する方法"><a href="#条件付きアクセスの適用「対象外」に-Azure-AD-コネクタ-アカウントのディレクトリ-ロールを指定する方法" class="headerlink" title="条件付きアクセスの適用「対象外」に Azure AD コネクタ アカウントのディレクトリ ロールを指定する方法"></a>条件付きアクセスの適用「対象外」に Azure AD コネクタ アカウントのディレクトリ ロールを指定する方法</h2><p>▼手順</p><ol><li><p>Azure ポータル (<a href="https://portal.azure.com/">https://portal.azure.com</a>) に、グローバル管理者 (全体管理者) でサインインをします。 </p></li><li><p>[Azure Active Directory] &gt; [セキュリティ] &gt; [条件付きアクセス] の順にクリックします。 </p></li><li><p>変更を行う条件付きアクセスのポリシーをクリックします。 </p></li><li><p>[割り当て] 配下にある [ユーザーとグループ] をクリックし、下記の設定を追加します。 </p><p>[対象] : 特に追加の設定は不要です。 </p><p>[対象外] : [ディレクトリ ロール] にチェックを入れた後、[ディレクトリ同期アカウント] にチェックを入れるという追加の設定を行います。</p><p><img src="/blog/azure-active-directory-connect/directory-synchronization-accounts/image01.png"></p></li><li><p>[保存] をクリックします。 </p></li></ol><p>設定手順は以上となります。 </p><h2 id="どのようなときに、Azure-AD-コネクタ-アカウントのサインインに問題が発生していると判断すればいいのか"><a href="#どのようなときに、Azure-AD-コネクタ-アカウントのサインインに問題が発生していると判断すればいいのか" class="headerlink" title="どのようなときに、Azure AD コネクタ アカウントのサインインに問題が発生していると判断すればいいのか"></a>どのようなときに、Azure AD コネクタ アカウントのサインインに問題が発生していると判断すればいいのか</h2><p>Azure AD コネクタ アカウントのサインインは、Azure AD Connect 新規インストール時からその後の定期的な同期処理においても発生します。</p><p>そのため、Azure AD コネクタ アカウントによるサインインに問題が発生している場合は、Azure AD Connect 構成ウィザードにおける画面がしばらくしても進まない動作や、Azure AD のサインイン ログにおいて当該アカウントによるサインインの失敗状況が確認される可能性が考えられます。 </p><p>なお、Azure AD コネクタ アカウントについては、明示的に管理者などのユーザーがサインインを行うものではなく、Azure AD Connect 新規インストール時やその後の定期的な同期処理のタイミングで、自動で当該アカウントによるサインインが行われるものとお考えください。 </p><p>下記では、Azure AD コネクタ アカウントに対して MFA が要求されるようにポリシーを構成している場合の確認例について、Azure AD Connect 構成ウィザードにおける画面、および Azure AD 対話型サインイン ログの観点でご紹介します。 </p><p><strong>▼ Azure AD Connect 構成ウィザードにおける画面</strong></p><p>例えば、Azure AD Connect 新規インストール時、下記のような “構成中” の画面で、しばらく時間が経過しても画面が変わらない (“接続の検証” 画面に進まない) 場合は、Azure AD Connect 構成ウィザード画面とは別のウィンドウにて、Azure AD コネクタ アカウントに対して、ユーザー名とパスワード &amp; MFA による認証が求められている可能性があります。</p><p>その場合は、画面上でパスワードを入力するなどの対処を行うことはできません。</p><p><img src="/blog/azure-active-directory-connect/directory-synchronization-accounts/image02.png"></p><p><strong>▼ Azure AD 対話型サインイン ログ</strong></p><p>例えば、ユーザー名が “Sync_” から始まる値で検索フィルターをかけると (通常は Azure AD コネクタ アカウントが検索対象として表示されるのが想定されます)、下記のように Azure AD コネクタ アカウントに対して MFA が要求されているために、当該アカウントによるサインインに失敗していることが確認できます。</p><p><img src="/blog/azure-active-directory-connect/directory-synchronization-accounts/image03.png"></p><p>本エラーが確認できた場合は、条件付きアクセスにて対処を実施します。 </p><p>上記内容が少しでも参考となりますと幸いです。</p><p>なお、製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポート サービスをご利用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの田中です。&lt;/p&gt;
&lt;p&gt; &lt;br&gt;今回は、比較的多くのお客様からお問い合わせをいただく、条件付きアクセスの利用を開始した環境において、ディレクトリ同期が失敗するという事象の対処方法の一例を紹介します。
 &lt;/p&gt;</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Conditional Access" scheme="https://jpazureid.github.io/blog/tags/Conditional-Access/"/>
    
    <category term="Azure AD Connect" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-Connect/"/>
    
    <category term="Directory Synchronization Accounts" scheme="https://jpazureid.github.io/blog/tags/Directory-Synchronization-Accounts/"/>
    
  </entry>
  
  <entry>
    <title>AD FS 証明書利用者信頼 に登録している Office 365 のフェデレーション メタデータの更新が検知された場合の対処方法について</title>
    <link href="https://jpazureid.github.io/blog/active-directory-federation-service/adfs-federation-metadata/"/>
    <id>https://jpazureid.github.io/blog/active-directory-federation-service/adfs-federation-metadata/</id>
    <published>2021-02-14T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:32.851Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。 Azure Identity チームの山口です。</p><p>2021 年 1 月中旬頃より AD FS と信頼関係を結んでいる Office 365 (Azure AD) の証明書利用者信頼の「監視」のタブに下記画面ショットのようにフェデレーション メタデータの更新が検知されたことを知らせる警告メッセージに関するお問い合わせを多くいただいております。</p><p><img src="/blog/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-001.jpg"></p><p>本 Blog の記事ではフェデレーション メタデータに関する説明と更新影響の有無、また、お客様よりよくいただいておりますご質問内容について Q&amp;A 形式で記載いたします。</p><h2 id="このメッセージの意味"><a href="#このメッセージの意味" class="headerlink" title="このメッセージの意味"></a>このメッセージの意味</h2><p>AD FS 側ではなく、連携している証明書利用者信頼 (サービス側) のフェデレーション メタデータが更新されたことを示します。<br>本記事では、証明書利用者信頼が  Office 365 (Azure AD) の場合についてご案内いたします。</p><h2 id="このフェデレーション-メタデータは何に使われているのか"><a href="#このフェデレーション-メタデータは何に使われているのか" class="headerlink" title="このフェデレーション メタデータは何に使われているのか"></a>このフェデレーション メタデータは何に使われているのか</h2><p>Office 365 (Azure AD)  のフェデレーション メタデータの実体は、 URL 「 <a href="https://nexus.microsoftonline-p.com/federationmetadata/2007-06/federationmetadata.xml">https://nexus.microsoftonline-p.com/federationmetadata/2007-06/federationmetadata.xml</a> 」  になり、ブラウザーで URL をクリックすると XML 形式のメタデータの中身を実際に確認できます。</p><p>このフェデレーションメタデータには、Azure AD が AD FS など別の IdP と認証連携をする場合に必要となる、Azure AD 側の情報が含まれています。<br>具体的には、IdP で認証を行った後にトークンを送信するエンドポイントや、発行されたトークンで利用できるサービスの識別子、また IdP に送信する認証リクエストの署名に利用される証明書などが含まれています。</p><p>AD FS などの IdP 側でも同様の情報をメタデータとして保持しており、認証連携する際には、お互いにデータの交換をして相手の情報を保持します。<br>つまり、AD FS のフェデレーションメタデータは Office 365 (Azure AD) 側にインポートし、Office 365 (Azure AD) 側のフェデレーションメタデータは AD FS 側にインポートして、お互いの情報を交換することで認証連携を行います。</p><p>今回の警告メッセージは、Office 365 (Azure AD) 側のフェデレーションメタデータが更新されたことを AD FS が検知して表示しているものです。</p><p>ここからは、上述の内容を踏まえまして、お客様より多くいただいておりますご質問内容についてそれぞれ Q&amp;A 形式で回答いたします。</p><h2 id="Q-なぜ警告が検知されたのか"><a href="#Q-なぜ警告が検知されたのか" class="headerlink" title="Q. なぜ警告が検知されたのか"></a>Q. なぜ警告が検知されたのか</h2><p>A. Azure AD Connect を利用したり、Powershell モジュールを利用して Office 365 (Azure AD) と AD FS の間にフェデレーション信頼を結んだ場合、「証明書利用者を監視する」にチェックが自動的に入ります。</p><p>このチェックが入っている場合、24 時間に 1 回の頻度で対象のフェデレーション メタデータに更新があるかどうかのチェックを行います。</p><p>逆に申し上げますと、「証明書利用者を監視する」にチェックが入っていない場合は、 Azure AD フェデレーション メタデータに更新があったとしても検知できないので、警告が表示されることもありません。<br>また、監視のチェックに加えて「証明書利用者を自動的に更新する」にチェックが入っている場合には、更新を検知すると自動的に AD FS は変更を反映する動作となり、この場合にも警告が表示されることはありません。</p><h2 id="Q-更新すると影響が出るのか。"><a href="#Q-更新すると影響が出るのか。" class="headerlink" title="Q. 更新すると影響が出るのか。"></a>Q. 更新すると影響が出るのか。</h2><p>A. 原則、影響はございません。<br>影響が及ぶような大きな変更がなされる場合には、事前に情報公開されることが想定されます。<br>基本的には、常に最新のメタデータに更新されることをお勧めいたします。</p><h2 id="Q-更新する方法-警告を解消する方法-について教えてください"><a href="#Q-更新する方法-警告を解消する方法-について教えてください" class="headerlink" title="Q. 更新する方法 (警告を解消する方法) について教えてください"></a>Q. 更新する方法 (警告を解消する方法) について教えてください</h2><p>A. フェデレーション メタデータの更新方法は、手動と自動 2 通りの方法があります。</p><p>手動で更新する場合は、証明書利用者信頼の一覧から「Microsoft Office 365 Identity Platform」を右クリックすることで表示される「フェデレーションメタデータから更新」を選択します。</p><p><img src="/blog/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-002.jpg"></p><p>下記画面がポップアップ表示されますので「更新」をクリックします。</p><p><img src="/blog/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-003.jpg"></p><p>フェデレーション メタデータからの最終更新日が手動更新を行った日時に更新されていることを確認します。</p><p><img src="/blog/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-004.jpg"></p><p>自動で更新を行いたい場合には、下記画面ショットにあります「証明書利用者を自動的に更新する」にチェックを入れ「適用」をクリックすることで、AD FS サーバーが 24 時間に 1 回の頻度で Azure AD フェデレーション メタデータの構成を確認し、構成の内容が変更されている場合に、自動的にフェデレーション メタデータの内容に沿って更新を行います。</p><p><img src="/blog/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-005.jpg"></p><h2 id="Q-更新しなくても問題はないのか"><a href="#Q-更新しなくても問題はないのか" class="headerlink" title="Q. 更新しなくても問題はないのか"></a>Q. 更新しなくても問題はないのか</h2><p>A. これまでに、更新しないことで影響が出るようなメタデータの変更は行われたことがございません。<br>影響が及ぶような大きな変更がなされる場合には、事前に情報公開をする予定です。<br>実際に、「証明書利用者を監視する」のチェックを外して監視を行わずに、クローズドな環境で運用されているお客様もいらっしゃいます。<br>ただし、可能な場合には、Azure AD フェデレーションメタデータの更新を検知できるようにし、更新を検知した際には更新ができるようにする運用を推奨いたします。</p><h2 id="Q-AD-FS-のトークン署名証明書などとの関連はないのか"><a href="#Q-AD-FS-のトークン署名証明書などとの関連はないのか" class="headerlink" title="Q. AD FS のトークン署名証明書などとの関連はないのか"></a>Q. AD FS のトークン署名証明書などとの関連はないのか</h2><p>A.  今回ご案内している警告は、AD FS と連携している証明書利用者信頼 (Azure AD) 側のメタデータが変更されたことを検知しているもので、AD FS 側のトークン署名証明書とは関連はありません。<br>以下の「トークン署名証明書」、「トークン暗号化解除証明書」は、AD FS 側のフェデレーションメタデータに含まれるものであり、Office 365 (Azure AD) などのサービス側でインポート、更新が必要となるものです。</p><p><img src="/blog/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-006.jpg"></p><h2 id="Q-今後も-Azure-AD-フェデレーション-メタデータが更新される可能性はあるのか。"><a href="#Q-今後も-Azure-AD-フェデレーション-メタデータが更新される可能性はあるのか。" class="headerlink" title="Q. 今後も Azure AD  フェデレーション メタデータが更新される可能性はあるのか。"></a>Q. 今後も Azure AD  フェデレーション メタデータが更新される可能性はあるのか。</h2><p>A. ございます。<br>AD FS 側で更新されないことで影響が出るような大きな変更の場合には、事前に情報公開する予定ではありますが、可能な場合には更新を検知し、最新の状態に反映していただく運用をお勧めいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。 Azure Identity チームの山口です。&lt;/p&gt;
&lt;p&gt;2021 年 1 月中旬頃より AD FS と信頼関係を結んでいる Office 365 (Azure AD) の証明書利用者信頼の「監視」のタブに下記画面ショットのようにフェデレーション メタデ</summary>
      
    
    
    
    
    <category term="AD FS" scheme="https://jpazureid.github.io/blog/tags/AD-FS/"/>
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>条件付きアクセスの 検索 / 並び替え/ 絞り込み 機能がパブリック プレビューとなりました !</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/search-sort-and-filter-for-ca/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/search-sort-and-filter-for-ca/</id>
    <published>2021-02-09T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.299Z</updated>
    
    <content type="html"><![CDATA[<p>本記事は、 2021 年 2 月 1 日に Azure Active Directory Identity Blog に公開された記事 (Search, Sort, and Filter for Conditional Access is now in public preview!) の抄訳です。原文は <a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/search-sort-and-filter-for-conditional-access-is-now-in-public/ba-p/1994699">こちら</a> より参照ください。</p><hr><p>Azure ポータル上で Azure AD  条件付きアクセス ポリシーを検索、並び替え、絞り込みする機能がパブリック プレビューとなりました。これは Azure AD のフィードバック フォーラムで最もリクエストされていたものの 1 つであり、ポリシーの管理が一段と楽になります。この機能は 2021 年 2 月 1 日から全テナントに順次展開され、数週間後には全テナントで利用できるようになる予定です。</p><br><h2 id="検索-Search"><a href="#検索-Search" class="headerlink" title="検索 (Search)"></a>検索 (Search)</h2><p>条件付きアクセス ポリシーの一覧ページに検索バーが追加され、特定のポリシーをすばやく簡単に名前から見つけることができるようになりました。検索では、ポリシー名のリストに対して、「～から始まる (starts-with)」と部分文字列検索が自動的に実行されます。部分文字列検索は、全単語、部分単語に対して実行され、特殊文字のサポートが含まれています。検索は大文字小文字を区別しません。<br>例えば、「Devices」を検索すると、「Devices」をポリシー名に含む「compliant devices」と「managed devices」の両方のポリシーが検索結果として表示されます。</p><p><img src="/blog/azure-active-directory/search-sort-and-filter-for-ca/001.png"></p><br><h2 id="並び替え-Sort"><a href="#並び替え-Sort" class="headerlink" title="並び替え (Sort)"></a>並び替え (Sort)</h2><p>ポリシーのリストを、ポリシー名、状態、作成日、および更新日で並べ替えることができます。各列の見出しの右側にある矢印を使用して、昇順または降順でリストを並べ替えることができます。</p><p><img src="/blog/azure-active-directory/search-sort-and-filter-for-ca/002.png"></p><br><h2 id="絞り込み-Filter"><a href="#絞り込み-Filter" class="headerlink" title="絞り込み (Filter)"></a>絞り込み (Filter)</h2><p>検索やソートだけでなく、状態、作成時刻、変更時刻でポリシーリストを絞り込みすることもできます。</p><p><img src="/blog/azure-active-directory/search-sort-and-filter-for-ca/003.png"></p><br><p>最後に、ポリシーの一覧ページでポリシー数を表示するように改善しました。これにより、設定したポリシーの総数を確認できるようになりました。また、検索または絞り込みを適用した場合、全ポリシー数のうちいくつのポリシーが該当したかを確認いただけます。</p><p><img src="/blog/azure-active-directory/search-sort-and-filter-for-ca/004.png"></p><br><p>世界中で、過去 30 日間で 18,000 を超えるポリシーが作成されました。条件付きアクセスの検索、並び替え、絞り込み機能を活用し、多くのポリシーの中から目的のポリシーを見つけていただければ幸いです。</p><p>これまでの数々のフィードバックを提供いただいたことに Azure  AD チームを代表してお礼申し上げます。Azure AD 条件付きアクセスの管理エクスペリエンスを弊社が改善できるよう引き続きフィードバックの共有にご協力いただけますと幸いです。</p><p>いつものように、<a href="https://feedback.azure.com/forums/169401-azure-active-directory">Azure フォーラム</a> や Twitter @AzureAD を通じて、この機能に関する質問やフィードバックを共有いただければと思います。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本記事は、 2021 年 2 月 1 日に Azure Active Directory Identity Blog に公開された記事 (Search, Sort, and Filter for Conditional Access is now in public pre</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Conditional Access" scheme="https://jpazureid.github.io/blog/tags/Conditional-Access/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD B2C のキホンとよくある質問</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-b2c-fundamentals/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azure-ad-b2c-fundamentals/</id>
    <published>2021-01-14T01:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.087Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity サポートの埴山です。</p><p>Azure AD B2C は非常に多機能な ID 基盤ですが、誤った利用方法を検討いただいていたり、本来利用方法として想定されない構成についてご質問いただいたりすることがございます。本記事では Azure AD B2C をご利用いただくにあたり、抑えていただきたい Azure AD B2C の基本的な考え方をご案内し、併せてよくあるご質問について回答します。</p><h2 id="Azure-AD-B2C-のキホン"><a href="#Azure-AD-B2C-のキホン" class="headerlink" title="Azure AD B2C のキホン"></a>Azure AD B2C のキホン</h2><p>まず、Azure AD B2C は Microsoft が提供する ID 管理基盤で、いわゆる IDaaS と呼ばれるサービスです。Azure AD がエンタープライズ (企業など組織で働くユーザー) 向けの ID 管理基盤であるのに対し、Azure AD <strong>B2C</strong> は、コンシューマー (ショッピング サイトの利用者など一般ユーザー) の ID 管理を目的としている点が大きく異なります。</p><p>さて、コンシューマーのアカウントといわれても、想像がしづらいと思いますので、Azure AD B2C のドキュメントにある以下の例で具体的に考えていきましょう。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/overview#example-woodgrove-groceries">Azure Active Directory B2C とは | Microsoft Docs</a></li></ul><p><img src="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/media/overview/woodgrove-overview.png"></p><h3 id="サンプル-シナリオ"><a href="#サンプル-シナリオ" class="headerlink" title="サンプル シナリオ"></a>サンプル シナリオ</h3><p>WoodGrove 社はあるスーパーマーケット WoodGrove Groceries を経営する会社です。WoodGrove Groceries のオンライン ショッピング サイトに利用者をサインインさせたり、利用者の ID を管理したりするために Azure AD B2C を利用しています。ユーザーはサインアップ ページより、Google アカウントや Facebbok アカウントなどのソーシャル アカウントまたはメール アドレスでサインアップを行い、ショッピングを楽しめます。</p><p>同時に、WoodGrove 社では従業員のユーザー管理に Azure AD を利用しています。Azure AD B2C と Azure AD を使い分ける理由とは何でしょうか。</p><h3 id="Azure-AD-と-Azure-AD-B2C-の違い"><a href="#Azure-AD-と-Azure-AD-B2C-の違い" class="headerlink" title="Azure AD と Azure AD B2C の違い"></a>Azure AD と Azure AD B2C の違い</h3><p>それぞれのサービスを利用するユーザーはこのようになっています。</p><table><thead><tr><th></th><th>対象のシステム</th><th>対象ユーザー</th></tr></thead><tbody><tr><td>Azure AD</td><td>WoodGrove 社の社内システム</td><td>WoodGrove 社の社員や派遣社員</td></tr><tr><td>Azure AD B2C</td><td>WoodGrove Groceries のショッピング サイト</td><td>オンライン ショッピングの利用ユーザー</td></tr></tbody></table><p>もう少しそれぞれのサービスに求められる特徴を考えてみます。</p><h4 id="Azure-AD-に求められる特徴"><a href="#Azure-AD-に求められる特徴" class="headerlink" title="Azure AD に求められる特徴"></a>Azure AD に求められる特徴</h4><p>まず WoodGrove 社のユーザーを管理できるという観点では、会社の管理者がテナントのあらゆる設定を管理できることが望ましいでしょう。さらに、管理部門や人事部門には、ユーザー管理の権限を適切に割り当てられる必要があります。また、Office 365 や SaaS アプリをユーザーに使わせることや、オンプレミスの Active Directory との同期も必要かもしれません。</p><p>外部ユーザーとの連携を行いたい場合には、その外部ユーザーをゲスト ユーザーとして招待することで自社の Azure AD で管理されるサービスを、外部ユーザーに利用させるシーンもあるかもしれません。</p><p>このため、WoodGrove 社の ID 管理基盤に求められる機能は以下のとおりとなります。</p><ul><li>管理権限の適切な委譲</li><li>Microsoft 365 サービスの利用</li><li>組織が管理する SaaS アプリとの連携</li><li>オンプレミスの Active Directory との連携</li><li>ゲスト ユーザーを招待する B2B 機能</li></ul><p>このように、Azure AD には、会社組織の中で適切に権限を設定し委任できるような管理機能が提供されています。また、各ユーザーは既定でお互いのユーザーを参照し連携できるなど、利用者が同一組織のメンバーであることを前提に設計されています。</p><h4 id="Azure-AD-B2C-に求められる特徴"><a href="#Azure-AD-B2C-に求められる特徴" class="headerlink" title="Azure AD B2C に求められる特徴"></a>Azure AD B2C に求められる特徴</h4><p>一方で、WoodGrove Groceries (ショッピング サイト) の会員管理サービスに必要な機能は何でしょうか。まずサービスを利用するにあたり、サインイン画面やサインアップ画面のカスタマイズが必要です。また、ユーザー自身が属性情報を変更できるプロフィール編集画面やパスワード リセット機能、ユーザー属性を外部の身分確認サービスと連携する API 連携といった機能が必要となる場合もあるでしょう。</p><p>このため、WoodGrove Groceries の ID 管理基盤に求められる機能は以下のとおりとなります。</p><ul><li>ユーザーが自身で会員登録を行えるセルフサインアップ機能</li><li>サインアップ時に名前や住所、電話番号などのユーザー属性を収集する機能</li><li>ブランド イメージに合わせたサインイン画面のカスタマイズ</li><li>ユーザーが自身で行えるプロフィールやパスワード変更 (リセット) 機能</li><li>本人確認や身分確認のためのサービスとの連携機能</li></ul><p>Azure AD B2C では上述のとおり、コンシューマー ユーザーを管理することが目的であり、会社組織のアカウント管理で有用な機能は利用できない、あるいはコンシューマー ユーザーには適用できない場合がございます。</p><p>もし、あなたが自社組織の ID を管理しようとしており、その管理のための機能が必要な場合、Azure AD B2C は適切なソリューションではない可能性があります。つまり、求める機能は Azure AD B2C では実現できない、あるいは自身で細かい実装が必要になる可能性がありますのでご注意ください。</p><h4 id="Azure-AD-B2C-以外に自テナントのリソースを他者に利用させるソリューション"><a href="#Azure-AD-B2C-以外に自テナントのリソースを他者に利用させるソリューション" class="headerlink" title="Azure AD B2C 以外に自テナントのリソースを他者に利用させるソリューション"></a>Azure AD B2C 以外に自テナントのリソースを他者に利用させるソリューション</h4><p>Azure AD B2C を利用せず自テナントのリソースを他者に利用させたい場合、Azure AD の以下の方法が代替策になる可能性があります。</p><ul><li>既存の Azure AD テナントに外部ユーザーを B2B ユーザーとしてゲスト招待し、組織内のアプリケーションにサインインをさせる (シングル テナント アプリ)</li><li>マルチテナント アプリケーションを作成し、すべての Azure AD テナントのユーザーがサインイン可能なアプリを作る</li></ul><p>たとえば、自組織内の Office 365 のリソースを外部ユーザーにも参照させたいときには Azure AD B2B を使用し、また Azure AD を利用する他社組織へのサービス提供 (SaaS アプリの開発) を考えている場合には、マルチテナント アプリケーションを構成するのが適切でしょう。</p><p>以下に、外部のユーザーをアプリにサインアップ、サインインさせる際のソリューションについて簡単な比較表を作成しましたので参考にしてください。</p><p><img src="/blog/azure-active-directory/azure-ad-b2c-fundamentals/compare-external-identities.png"></p><p>詳しくは、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/compare-with-b2c">外部 ID の比較 - Azure Active Directory | Microsoft Docs</a> をご確認ください。</p><h3 id="Azure-AD-B2C-の機能"><a href="#Azure-AD-B2C-の機能" class="headerlink" title="Azure AD B2C の機能"></a>Azure AD B2C の機能</h3><p>ここからは、もう少し詳しく Azure AD B2C の動作について確認していきます。</p><p><a href="https://woodgrovedemo.com/Account/LogIn">WoodGrove Groceries</a> では新規ユーザーの登録時に、Google や Facebook などのソーシャル アカウントまたは、既存のメール アドレスを指定してセルフサインアップを行えます。</p><p><img src="/blog/azure-active-directory/azure-ad-b2c-fundamentals/woodgrove-signup.png"></p><p>この際、ユーザー フローに設定された属性値をもとに、サインアップと同時に氏名、メールアドレス、規約への同意情報などを収集します。</p><p><img src="/blog/azure-active-directory/azure-ad-b2c-fundamentals/woodgrove-signup-local-account.png"></p><p>現実世界のネット ショップでは、生年月日、電話番号、住所などの属性も収集が必要でしょう。また Azure AD B2C が標準で対応している本人確認はメールアドレスの確認のみですが、必要に応じて外部サービスや、独自の API との連携で本人確認を実施することも可能です。サインアップが完了すると、Azure AD B2C テナント上にユーザーが作成され、サインアップ時に利用したアカウント情報 (ソーシャル アカウントの情報、あるいはメール アドレス情報) と属性値が Azure AD 上に記録されます。</p><p>このように作成されたユーザーは “コンシューマー ユーザー” とよばれます。大まかな Azure AD B2C を構成するコンポーネントの関係について、図にまとめましたので参考にしてください。</p><p><img src="/blog/azure-active-directory/azure-ad-b2c-fundamentals/azure-ad-b2c-tenant-overview.png"></p><p>コンシューマー ユーザーは、赤枠のフローを通してサインアップ・サインインを行い、アプリに対してトークンを発行することが可能です。</p><p>ユーザー フローなどの設定は管理用アカウントである B2B ユーザーやテナントの組織ユーザーに管理権限を付与し設定を行います。Azure AD B2C ではトークンに含まれる属性情報などを細かくカスタマイズする、条件付きアクセス ポリシーを構成し必要に応じて多要素認証を求める、API コネクターやカスタム ポリシーを利用して API 連携を行うなど、アプリに合わせた認証・認可フローを構成することが可能です。</p><p><img src="/blog/azure-active-directory/azure-ad-b2c-fundamentals/azure-ad-b2c-customize-flow.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>※ カスタム ポリシーは既定で用意されている ID プロバイダーとユーザー フローで要望を実現できない場合に、より高度なカスタマイズを実現するための ID プロフェッショナル向けの機能です。Azure AD B2C をご利用いただく際には、まずは既定で用意されている ID プロバイダーとユーザー フローにて要件を満たせるか検討いただくことを推奨します。</p></div><h2 id="よくあるご質問"><a href="#よくあるご質問" class="headerlink" title="よくあるご質問"></a>よくあるご質問</h2><p>ここからは、上記の前提事項を踏まえ、よくある質問について回答いたします。</p><h3 id="Azure-AD-B2C-テナントの管理画面にアクセスするにはどうすればよいですか"><a href="#Azure-AD-B2C-テナントの管理画面にアクセスするにはどうすればよいですか" class="headerlink" title="Azure AD B2C テナントの管理画面にアクセスするにはどうすればよいですか"></a>Azure AD B2C テナントの管理画面にアクセスするにはどうすればよいですか</h3><p>Azure AD B2C はサブスクリプションに紐づくリソースではありますが、サブスクリプションが紐づくテナントとは別の Azure AD テナント上に機能が提供されています。そのため、管理者が Azure AD B2C テナントへアクセスするには、以下の手順でアクセス先のテナントを切り替える必要があります。</p><ol><li>Azure ポータルにアクセスします。</li><li>右上のユーザーアイコンをクリックし、<code>ディレクトリの切り替え</code> をクリックします。</li><li>作成した Azure AD B2C テナントを選択します。</li></ol><p>あるいは Azure AD B2C テナントのテナント ID を、<code>https://portal.azure.com/&lt;tenant id&gt;</code> のように指定してブラウザーからアクセスすることでも、Azure AD B2C テナントに切り替えいただけます。</p><p>なお、Azure ポータルから Azure AD B2C テナントにアクセスしてユーザー (<a href="mailto:&#x61;&#x64;&#x6d;&#105;&#x6e;&#x40;&#x63;&#111;&#110;&#116;&#x6f;&#115;&#111;&#x62;&#50;&#x63;&#46;&#x6f;&#110;&#x6d;&#105;&#x63;&#114;&#111;&#115;&#111;&#x66;&#x74;&#x2e;&#x63;&#x6f;&#109;">&#x61;&#x64;&#x6d;&#105;&#x6e;&#x40;&#x63;&#111;&#110;&#116;&#x6f;&#115;&#111;&#x62;&#50;&#x63;&#46;&#x6f;&#110;&#x6d;&#105;&#x63;&#114;&#111;&#115;&#111;&#x66;&#x74;&#x2e;&#x63;&#x6f;&#109;</a> など) を作成いただき、グローバル管理者権限を付与することで、このユーザーを管理者としてご利用いただくことも可能です。その場合、直接 Azure AD B2C テナントにアクセスするためテナントの切り替えが不要となるほか、<a href="https://developer.microsoft.com/ja-jp/graph/graph-explorer">Graph Explorer</a> などで Azure AD B2C テナントに対して API 呼び出しを実施いただくことも可能になります。このため、検証用に Azure AD B2C テナントに対しメンバー ユーザーとして管理ユーザーを作成いただくことをお勧めします。</p><h3 id="Azure-AD-B2C-のコンシューマー-ユーザー-アカウントとはなんですか"><a href="#Azure-AD-B2C-のコンシューマー-ユーザー-アカウントとはなんですか" class="headerlink" title="Azure AD B2C のコンシューマー ユーザー アカウントとはなんですか"></a>Azure AD B2C のコンシューマー ユーザー アカウントとはなんですか</h3><p>Azure AD B2C のサインアップ フローで作成されたアカウントは、コンシューマー ユーザー アカウントと呼ばれます。コンシューマー ユーザー アカウントは、サインアップ フロー以外に Azure ポータル、あるいは Microsoft Graph API を利用して作成することが可能です。</p><p>技術的にはコンシューマー アカウントは、連携している IdP のアカウント情報、またはローカル アカウントのメール アドレスを “ID プロパティ” として保持しています。ID プロパティ (identities 属性) のほか、表示名 (DisplayName) や拡張属性 (extension) を Microsoft Graph API を利用することで編集、またはユーザーの新規作成を行うことが可能です。</p><p>詳細については、以下の公開情報をご確認ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/manage-user-accounts-graph-api">Microsoft Graph API を使用してユーザーを管理する - Azure AD B2C | Microsoft Docs</a></li></ul><h3 id="Azure-AD-B2C-の職場アカウント-管理ユーザー-とは何ですか"><a href="#Azure-AD-B2C-の職場アカウント-管理ユーザー-とは何ですか" class="headerlink" title="Azure AD B2C の職場アカウント (管理ユーザー) とは何ですか"></a>Azure AD B2C の職場アカウント (管理ユーザー) とは何ですか</h3><p>Azure AD B2C テナントにはコンシューマー ユーザー以外にも、管理用の Azure AD ユーザーを登録することが可能です。これらの職場アカウント (B2B ゲストユーザーを含む) は管理ユーザーとして Azure AD を直接利用することができ、Azure ポータルにサインインをしユーザーを操作を行う、Microsoft Graph API を呼び出すといったことが可能です。上記の <a href="mailto:&#x61;&#100;&#109;&#105;&#110;&#x40;&#x63;&#x6f;&#x6e;&#116;&#x6f;&#115;&#111;&#98;&#50;&#99;&#x2e;&#x6f;&#110;&#x6d;&#105;&#99;&#114;&#111;&#115;&#x6f;&#x66;&#116;&#x2e;&#99;&#111;&#109;">&#x61;&#100;&#109;&#105;&#110;&#x40;&#x63;&#x6f;&#x6e;&#116;&#x6f;&#115;&#111;&#98;&#50;&#99;&#x2e;&#x6f;&#110;&#x6d;&#105;&#99;&#114;&#111;&#115;&#x6f;&#x66;&#116;&#x2e;&#99;&#111;&#109;</a> がこの例に該当します。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/user-overview">Azure Active Directory B2C のユーザー アカウントの概要 | Microsoft Docs</a></li></ul><p>Azure AD B2C テナントは、通常の Azure AD テナントを拡張して作成されております。そのため多くの Azure AD 機能を利用いただけますが、Azure AD B2C の管理領域とそれらは分けて考えることが重要です。管理ユーザーは従来の Azure AD テナントのユーザーと同等であり、グローバル管理者のディレクトリ ロールを割り当てることで、ユーザー フローを含めたテナントの設定を行うことが可能です。</p><p>上記のとおり、ユーザー ストア等は従来の Azure AD と Azure AD B2C のコンシューマー アカウントで共用であり、管理ユーザーは Azure AD ユーザー管理機能 (Microsoft Graph API や Azure ポータル上での操作) を利用してコンシューマー ユーザー アカウントを含めたユーザーを管理することが可能です。</p><p>なお、職場アカウントはあくまで管理用のユーザーであり、Azure AD B2C のユーザー フローで利用することはできません。上記図の赤枠で囲われた部分が Azure AD B2C の機能ですが、これらの機能は通常の Azure AD テナント上に拡張機能として実装されており、コンシューマー ユーザー アカウントのみが利用することを想定しております。</p><h3 id="他テナントの-Azure-AD-ユーザーをコンシューマー-アカウントとして利用することは可能ですか"><a href="#他テナントの-Azure-AD-ユーザーをコンシューマー-アカウントとして利用することは可能ですか" class="headerlink" title="他テナントの Azure AD ユーザーをコンシューマー アカウントとして利用することは可能ですか"></a>他テナントの Azure AD ユーザーをコンシューマー アカウントとして利用することは可能ですか</h3><p>他テナントのユーザーを B2B 招待 (管理ユーザーとして招待) ではなく、コンシューマー ユーザーとして作成したい場合には、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/identity-provider-azure-ad-single-tenant?pivots=b2c-user-flow">特定の Azure Active Directory 組織用のサインインを設定</a> しサインアップとサインインのフローを構成ください。</p><p>連携先のテナントに作成いただく Azure AD アプリにてサインイン可能なユーザーを設定することで、Azure AD B2C テナントにサインアップできるユーザーを制限することも可能です。アクセスできるユーザーを制限するには、エンタープライズ アプリケーションの<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/manage-apps/assign-user-or-group-access-portal">ユーザーの割り当てを有効</a>に設定し、アプリにアクセスを許可するユーザーを割り当てます。</p><h3 id="Azure-AD-B2C-のユーザー-フローで取得したトークンで-Microsoft-Graph-API-を呼び出せますか？"><a href="#Azure-AD-B2C-のユーザー-フローで取得したトークンで-Microsoft-Graph-API-を呼び出せますか？" class="headerlink" title="Azure AD B2C のユーザー フローで取得したトークンで Microsoft Graph API を呼び出せますか？"></a>Azure AD B2C のユーザー フローで取得したトークンで Microsoft Graph API を呼び出せますか？</h3><p>いいえ、Azure AD B2C のユーザー フローはお客様のアプリ用のトークンのみを発行し、Microsoft Graph API を呼び出すためのトークンを発行することはできません。</p><p>Azure AD B2C のサインイン アップ フローやサインイン フロー、b2clogin.com の認証エンドポイントから発行されるトークンは、ある意味 Azure AD の領域とは切り離されており、お客様独自のアプリケーション内でのみ利用できるものとなっています。</p><p>もう少し、技術的な説明を付け加えると、<a href="https://docs.microsoft.com/ja-jp/graph/auth/auth-concepts">Microsoft Graph API を呼び出すために必要なトークン</a> は、issuer が <code>https://login.microsoftonline.com/&lt;tenantid&gt;/v2.0</code> などである必要がありますが、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/tokens-overview">Azure AD B2C のユーザー フローで発行されるトークン</a> の issuer は <code>https://&lt;tenantname&gt;.b2clogin.com/&lt;tenantid&gt;/v2.0/</code> となります。このように、Issuer が異なるため、Azure AD B2C が発行するトークンを Microsoft Graph API に対して利用することはできません。Azure AD B2C のユーザー フローで発行されるトークンは、B2C アプリの閉じた世界でのみ利用できるものとなります。</p><p>Microsoft Graph API を呼び出すユース ケースがある場合、アプリ側で Azure AD の <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow">OAuth 2.0 クライアント資格情報フロー</a> などを利用して Microsoft Graph API 用のトークンを取得ください。例えばお客様側で API を用意いただき、その API 内部で Microsoft Graph API 用のトークン取得と Microsoft Graph API の呼び出しを行うといった実装が考えられます。</p><h3 id="Azure-AD-B2C-テナントに登録できるアプリの種類について教えてください。"><a href="#Azure-AD-B2C-テナントに登録できるアプリの種類について教えてください。" class="headerlink" title="Azure AD B2C テナントに登録できるアプリの種類について教えてください。"></a>Azure AD B2C テナントに登録できるアプリの種類について教えてください。</h3><p>Azure AD B2C のユーザー フローを利用する B2C アプリを登録できます。それに加え、通常の Azure AD テナント同様に、シングルテナント アプリケーション、マルチテナント アプリケーションの登録も可能です。</p><p>前者のユーザー フローを利用する B2C アプリは <code>&lt;tenantname&gt;.b2clogin.com</code> のエンドポイントで認証し、Azure AD B2C の世界のトークンを発行します。これに対して、後者のシングルテナントおよびマルチテナント アプリケーションは管理用アプリとして <code>login.microsoftonline.com</code> のエンドポイントで認証し、Microsoft Graph API の呼び出しなどに利用します。</p><p>テナントの管理ユーザー権限あるいはサービス プリンシパル権限で Microsoft Graph API を呼び出すには、テナントにシングルテナント (またはマルチテナント) アプリを登録ください。</p><h3 id="Azure-AD-B2C-の料金について詳しく教えてください"><a href="#Azure-AD-B2C-の料金について詳しく教えてください" class="headerlink" title="Azure AD B2C の料金について詳しく教えてください"></a>Azure AD B2C の料金について詳しく教えてください</h3><p>2021/1 現在、料金は Azure AD の External Identity と同様で以下のページよりご確認いただけます。</p><ul><li><a href="https://azure.microsoft.com/ja-jp/pricing/details/active-directory/external-identities/">料金 - Active Directory 外部 ID | Microsoft Azure</a></li></ul><h3 id="Azure-AD-B2C-テナントに-Azure-AD-Connect-を利用しオンプレミス-AD-のユーザーを同期するのは可能ですか？"><a href="#Azure-AD-B2C-テナントに-Azure-AD-Connect-を利用しオンプレミス-AD-のユーザーを同期するのは可能ですか？" class="headerlink" title="Azure AD B2C テナントに Azure AD Connect を利用しオンプレミス AD のユーザーを同期するのは可能ですか？"></a>Azure AD B2C テナントに Azure AD Connect を利用しオンプレミス AD のユーザーを同期するのは可能ですか？</h3><p>いいえ、Azure AD B2C テナントでは Azure AD Connect をご利用いただくことはできません。お客様独自のアプリを開発し、Microsoft Graph API を利用して Azure AD B2C テナントにユーザーを同期することは可能ですが、上述の利用シーンを確認いただき、組織ユーザーを Azure AD B2C に連携することが適切か再度ご検討ください。</p><h3 id="Azure-AD-B2C-の-Premium-P1-と-P2-ライセンスで利用できる機能は何ですか"><a href="#Azure-AD-B2C-の-Premium-P1-と-P2-ライセンスで利用できる機能は何ですか" class="headerlink" title="Azure AD B2C の Premium P1 と P2 ライセンスで利用できる機能は何ですか"></a>Azure AD B2C の Premium P1 と P2 ライセンスで利用できる機能は何ですか</h3><p>2021/1 現在、Azure AD B2C のコンシューマー アカウント向けに、条件付きアクセス ポリシーの利用 (P1)、リスクベースの条件付きアクセス ポリシーの利用 (P2) が可能です。現時点では Azure AD Premium の機能であるアプリおよびロールへのグループ ベースの割り当てや Azure AD の組織アカウント向けの Identity Protection などの機能は B2C テナント管理ユーザー向けには利用できません。</p><h3 id="コンシューマー-ユーザー-アカウントのパスワードをリセットするにはどうすればよいですか"><a href="#コンシューマー-ユーザー-アカウントのパスワードをリセットするにはどうすればよいですか" class="headerlink" title="コンシューマー ユーザー アカウントのパスワードをリセットするにはどうすればよいですか"></a>コンシューマー ユーザー アカウントのパスワードをリセットするにはどうすればよいですか</h3><p>コンシューマー ユーザー (ローカル アカウント) のパスワード リセットを Azure ポータルから実施すると、パスワード プロファイルの <code>forceChangePasswordNextSignIn</code> が <code>true</code> となり、一部のユーザー フローでサインインの失敗が発生します。</p><p>そのためパスワード リセットは Microsoft Graph API や Azure AD PowerShell モジュールを利用し、<code>forceChangePasswordNextSignIn</code> を <code>false</code> に設定したうえで更新ください。</p><p>▽ Graph API の例</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">PATCH https://graph.microsoft.com/v1.0/users/&lt;対象ユーザーのオブジェクト ID&gt;</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">    &quot;passwordProfile&quot;: &#123;</span><br><span class="line">        &quot;password&quot;: &quot;password-value&quot;,</span><br><span class="line">        &quot;forceChangePasswordNextSignIn&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;passwordPolicies&quot;: &quot;DisablePasswordExpiration&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>▽ Azure AD PowerShell モジュールでの例</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-AzureAD</span> <span class="literal">-TenantId</span> &lt;B2C tenant 名&gt;</span><br><span class="line"><span class="variable">$password</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-String</span> &lt;パスワードの値&gt; <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">Set-AzureADUserPassword</span> <span class="literal">-ObjectId</span> &lt;対象ユーザーのオブジェクト ID&gt; <span class="literal">-Password</span> <span class="variable">$password</span> <span class="literal">-ForceChangePasswordNextLogin</span> <span class="variable">$false</span> </span><br></pre></td></tr></table></figure><h3 id="コンシューマー-ユーザー-アカウントのパスワードに有効期限を定めることは可能ですか"><a href="#コンシューマー-ユーザー-アカウントのパスワードに有効期限を定めることは可能ですか" class="headerlink" title="コンシューマー ユーザー アカウントのパスワードに有効期限を定めることは可能ですか"></a>コンシューマー ユーザー アカウントのパスワードに有効期限を定めることは可能ですか</h3><p>パスワード有効期限の通知機能や、強制更新機能は Azure AD B2C の標準機能としては提供しておりません。</p><p>Azure AD B2C では、お客様が設定可能なパスワードのポリシーとして NIST SP 800-63 をベースに機能を実装しております。NIST SP 800-63 では、頻繁なパスワード変更や、複雑なパスワード ポリシーはエンドユーザーの利便性を下げるだけではなく、セキュリティの向上に寄与しないことを指摘しています。</p><p>必要に応じてカスタム ポリシーでの実装をご検討ください。</p><ul><li><a href="https://github.com/azure-ad-b2c/samples/tree/master/policies/force-password-reset-after-90-days">samples/policies/force-password-reset-after-90-days at master · azure-ad-b2c/samples</a></li></ul><h3 id="XXXX-の機能について、カスタム-ポリシーを利用すればを実現可能ですか"><a href="#XXXX-の機能について、カスタム-ポリシーを利用すればを実現可能ですか" class="headerlink" title="XXXX の機能について、カスタム ポリシーを利用すればを実現可能ですか"></a>XXXX の機能について、カスタム ポリシーを利用すればを実現可能ですか</h3><p>弊社ではカスタム ポリシーの利用例として、以下の GitHub リポジトリにてサンプルを公開しています。まずは実現したいことが以下のサンプルにあるかを確認ください。</p><ul><li><a href="https://github.com/azure-ad-b2c/samples">azure-ad-b2c/samples: Azure AD B2C Identity Experience Framework sample User Journeys.</a></li></ul><p>カスタム ポリシーは非常に柔軟な連携や構成が可能なため、ある意味イチからプログラミングをしてアプリケーションを作成する程度の自由度があります。一方で構成が非常に複雑であり、仕組みの理解や適切な利用には十分な学習と検証が必要です。弊社サポートとしては Azure AD B2C の機能自体についてのご質問については回答可能ですが、特定の要件に合わせた詳細なカスタマイズ手順のご案内については、別途コンサルティング サービス、あるいはコミュニティー (Stack overflow) サポートの利用をご検討ください。</p><ul><li><a href="https://stackoverflow.com/questions/tagged/azure-ad-b2c">Newest ‘azure-ad-b2c’ Questions - Stack Overflow</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity サポートの埴山です。&lt;/p&gt;
&lt;p&gt;Azure AD B2C は非常に多機能な ID 基盤ですが、誤った利用方法を検討いただいていたり、本来利用方法として想定されない構成についてご質問いただいたりすることがございます。本記事では A</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Azure AD B2C" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-B2C/"/>
    
  </entry>
  
  <entry>
    <title>Hybrid Azure AD Join とユーザーの UPN</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/haadj-and-upn/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/haadj-and-upn/</id>
    <published>2021-01-04T15:00:00.000Z</published>
    <updated>2021-07-01T00:10:33.175Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの 姚 (ヨウ) です。</p><p>今回は Hybrid Azure AD Join を構成した際の、デバイスにログオンするユーザーの UPN とドメイン名の関係について説明します。<br>この内容は以下の公開情報で説明されておりますが、今回はより分かりやすい解説を目指します。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/devices/hybrid-azuread-join-plan#review-on-premises-ad-users-upn-support-for-hybrid-azure-ad-join">ハイブリッド Azure AD 参加でのオンプレミス AD ユーザー UPN サポートを確認する</a></p><p>ご存じの通り、Hybrid Azure AD Join した端末へユーザーがログオンすると、SSO や条件付きアクセスに利用される PRT を取得します。</p><p>PRT を正常に取得するためには、デバイスが正常に Hybrid Azure AD Join した状態として登録されている必要がありますが、ユーザーの UPN も正しく構成されている必要があります。<br>PRT を正常に取得するために、どのようにユーザーの UPN を構成するべきかをフェデレーション認証とクラウド認証でそれぞれ解説します。<br>ご参考にいただければと思います。</p><h2 id="クラウド認証のユーザーの場合"><a href="#クラウド認証のユーザーの場合" class="headerlink" title="クラウド認証のユーザーの場合"></a>クラウド認証のユーザーの場合</h2><ul><li>Windows 10 1803 以降のバージョンを対象です。</li><li>ユーザーがいる Azure AD テナントとデバイスが Hybrid Azure AD Join として登録する Azure AD テナントは同じである前提です。</li><li>ユーザーがいる Azure AD テナントとデバイスが Hybrid Azure AD Join として登録する Azure AD テナントは異なる場合、Hybrid Azure AD Join として構成できません。</li></ul><p>以下の表にオンプレミス AD と AAD のユーザーの UPN のパターンごとに PRT を正常に取得できるかどうかをまとめいたしました。</p><table><thead><tr><th align="center"></th><th align="center">パターン A</th><th align="center">パターン B</th><th align="center">パターン C</th></tr></thead><tbody><tr><td align="center">オンプレミス AD 側の UPN</td><td align="center"><a href="mailto:&#120;&#120;&#x78;&#120;&#x78;&#x40;&#x63;&#111;&#x6e;&#116;&#x6f;&#115;&#111;&#x2e;&#108;&#111;&#x63;&#97;&#108;">&#120;&#120;&#x78;&#120;&#x78;&#x40;&#x63;&#111;&#x6e;&#116;&#x6f;&#115;&#111;&#x2e;&#108;&#111;&#x63;&#97;&#108;</a></td><td align="center"><a href="mailto:&#x78;&#x78;&#x78;&#120;&#120;&#64;&#99;&#111;&#110;&#116;&#111;&#x73;&#111;&#46;&#x63;&#x6f;&#x2e;&#x6a;&#112;">&#x78;&#x78;&#x78;&#120;&#120;&#64;&#99;&#111;&#110;&#116;&#111;&#x73;&#111;&#46;&#x63;&#x6f;&#x2e;&#x6a;&#112;</a></td><td align="center"><a href="mailto:&#120;&#x78;&#x78;&#120;&#x78;&#x40;&#x63;&#111;&#110;&#x74;&#x6f;&#115;&#x6f;&#x2e;&#x63;&#x6f;&#109;">&#120;&#x78;&#x78;&#120;&#x78;&#x40;&#x63;&#111;&#110;&#x74;&#x6f;&#115;&#x6f;&#x2e;&#x63;&#x6f;&#109;</a></td></tr><tr><td align="center">Azure AD 側の UPN</td><td align="center"><a href="mailto:&#120;&#120;&#x78;&#x78;&#120;&#64;&#99;&#x6f;&#110;&#x74;&#x6f;&#115;&#111;&#x2e;&#99;&#x6f;&#109;">&#120;&#120;&#x78;&#x78;&#120;&#64;&#99;&#x6f;&#110;&#x74;&#x6f;&#115;&#111;&#x2e;&#99;&#x6f;&#109;</a></td><td align="center"><a href="mailto:&#x78;&#120;&#120;&#120;&#120;&#x40;&#99;&#111;&#x6e;&#x74;&#111;&#115;&#x6f;&#x2e;&#x63;&#111;&#x6d;">&#x78;&#120;&#120;&#120;&#120;&#x40;&#99;&#111;&#x6e;&#x74;&#111;&#115;&#x6f;&#x2e;&#x63;&#111;&#x6d;</a></td><td align="center"><a href="mailto:&#120;&#120;&#x78;&#x78;&#120;&#x40;&#99;&#x6f;&#110;&#x74;&#x6f;&#x73;&#111;&#46;&#99;&#111;&#x6d;">&#120;&#120;&#x78;&#x78;&#120;&#x40;&#99;&#x6f;&#110;&#x74;&#x6f;&#x73;&#111;&#46;&#99;&#111;&#x6d;</a></td></tr><tr><td align="center">Azure AD に登録されているカスタムドメイン</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td></tr><tr><td align="center">PRT を取得</td><td align="center">できない</td><td align="center">できる</td><td align="center">できる</td></tr></tbody></table><p>上記の表を言葉で説明しますと、以下です。<br>ユーザーのオンプレミス AD の UPN と Azure AD 側の UPN は同じ場合、正常に PRT を取得できます。<br>ユーザーのオンプレミス AD の UPN と Azure AD 側の UPN は異なっても、オンプレミス AD の UPN のドメイン名は Azure AD テナントのカスタムドメインとして登録されば、PRT を取得できます。</p><h2 id="フェデレーション認証のユーザーの場合"><a href="#フェデレーション認証のユーザーの場合" class="headerlink" title="フェデレーション認証のユーザーの場合"></a>フェデレーション認証のユーザーの場合</h2><ul><li>Windows 10 1803 以降のバージョンを対象です。</li><li>ユーザーがいる Azure AD テナントとデバイスが Hybrid Azure AD Join として登録する Azure AD テナントは同じである前提です。</li><li>ユーザーがいる Azure AD テナントとデバイスが Hybrid Azure AD Join として登録する Azure AD テナントは異なる場合、Hybrid Azure AD Join として構成できません。</li></ul><p>フェデレーション ユーザーの場合は比較的わかりやすいです。</p><p>AD FS のフェデレーション環境でオンプレミス AD と AAD のユーザーの UPN が異なっても、代替ログイン ID を構成していれば、ユーザーは正常に PRT を取得できます。<br>もちろん、ユーザーのオンプレミス AD と Azure AD の UPN は同じで、代替ログイン ID を利用しない構成でも、正常に PRT を取得できます。</p><p>クラウド認証と同じく表にまとめてみました。</p><table><thead><tr><th align="center"></th><th align="center">パターン A</th><th align="center">パターン B</th><th align="center">パターン C</th></tr></thead><tbody><tr><td align="center">オンプレミス AD 側の UPN</td><td align="center"><a href="mailto:&#120;&#120;&#x78;&#x78;&#x78;&#64;&#99;&#x6f;&#110;&#116;&#111;&#115;&#111;&#46;&#x6c;&#x6f;&#99;&#x61;&#108;">&#120;&#120;&#x78;&#x78;&#x78;&#64;&#99;&#x6f;&#110;&#116;&#111;&#115;&#111;&#46;&#x6c;&#x6f;&#99;&#x61;&#108;</a></td><td align="center"><a href="mailto:&#x78;&#x78;&#120;&#x78;&#x78;&#64;&#99;&#111;&#x6e;&#x74;&#111;&#115;&#111;&#x2e;&#99;&#x6f;&#x2e;&#106;&#112;">&#x78;&#x78;&#120;&#x78;&#x78;&#64;&#99;&#111;&#x6e;&#x74;&#111;&#115;&#111;&#x2e;&#99;&#x6f;&#x2e;&#106;&#112;</a></td><td align="center"><a href="mailto:&#120;&#x78;&#x78;&#x78;&#120;&#x40;&#99;&#111;&#x6e;&#x74;&#111;&#x73;&#x6f;&#46;&#x63;&#111;&#x6d;">&#120;&#x78;&#x78;&#x78;&#120;&#x40;&#99;&#111;&#x6e;&#x74;&#111;&#x73;&#x6f;&#46;&#x63;&#111;&#x6d;</a></td></tr><tr><td align="center">Azure AD 側の UPN</td><td align="center"><a href="mailto:&#120;&#120;&#x78;&#120;&#120;&#64;&#x63;&#x6f;&#110;&#116;&#111;&#115;&#111;&#x2e;&#99;&#111;&#109;">&#120;&#120;&#x78;&#120;&#120;&#64;&#x63;&#x6f;&#110;&#116;&#111;&#115;&#111;&#x2e;&#99;&#111;&#109;</a></td><td align="center"><a href="mailto:&#x78;&#x78;&#x78;&#120;&#120;&#x40;&#99;&#x6f;&#x6e;&#x74;&#x6f;&#115;&#x6f;&#46;&#99;&#x6f;&#x6d;">&#x78;&#x78;&#x78;&#120;&#120;&#x40;&#99;&#x6f;&#x6e;&#x74;&#x6f;&#115;&#x6f;&#46;&#99;&#x6f;&#x6d;</a></td><td align="center"><a href="mailto:&#120;&#120;&#x78;&#120;&#120;&#x40;&#x63;&#x6f;&#x6e;&#116;&#111;&#x73;&#x6f;&#x2e;&#x63;&#111;&#x6d;">&#120;&#120;&#x78;&#120;&#120;&#x40;&#x63;&#x6f;&#x6e;&#116;&#111;&#x73;&#x6f;&#x2e;&#x63;&#111;&#x6d;</a></td></tr><tr><td align="center">Azure AD に登録されているカスタムドメイン</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td></tr><tr><td align="center">PRT を取得</td><td align="center">できる</td><td align="center">できる</td><td align="center">できる</td></tr></tbody></table><p>AD FS のフェデレーション環境での代替ログイン ID の構成は一般的に以下の理由によって利用されます。</p><p>・ユーザーのオンプレミス AD の UPN のドメインは Azure AD のカスタムドメインとして登録していない<br>・ユーザーのオンプレミス AD の UPN とメールドレスが異なり、Office 365 などのクラウド アプリケーションへのサインイン時にメールアドレスを利用する</p><p>代替ログイン ID の詳細については、<a href="https://docs.microsoft.com/ja-jp/windows-server/identity/ad-fs/operations/configuring-alternate-login-id">代替ログイン ID を構成する</a> をご参照ください。</p><p>製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポート サービスをご利用ください。<br>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの 姚 (ヨウ) です。&lt;/p&gt;
&lt;p&gt;今回は Hybrid Azure AD Join を構成した際の、デバイスにログオンするユーザーの UPN とドメイン名の関係について説明します。&lt;br&gt;この内容は</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="HAADJ" scheme="https://jpazureid.github.io/blog/tags/HAADJ/"/>
    
    <category term="UPN" scheme="https://jpazureid.github.io/blog/tags/UPN/"/>
    
  </entry>
  
</feed>
